{"version":3,"sources":["webpack://officechromeextension/webpack/runtime/chunk loaded","webpack://officechromeextension/./app/common/constants.js","webpack://officechromeextension/./app/common/httpInterceptor.js","webpack://officechromeextension/./app/common/logDecorator.js","webpack://officechromeextension/./app/common/storage.service.js","webpack://officechromeextension/./app/common/index.js","webpack://officechromeextension/./app/common/notification.service.js","webpack://officechromeextension/./app/user/index.js","webpack://officechromeextension/./app/user/protectedResourceInterceptor.js","webpack://officechromeextension/./app/user/msaUser.service.js","webpack://officechromeextension/./app/user/o365User.service.js","webpack://officechromeextension/./app/user/msidUser.service.js","webpack://officechromeextension/./app/user/user.service.js","webpack://officechromeextension/./app/mru/mru.service.js","webpack://officechromeextension/./app/mru/mru.controller.js","webpack://officechromeextension/./app/mru/index.js","webpack://officechromeextension/./app/diagnostics/index.js","webpack://officechromeextension/./app/diagnostics/telemetry.service.js","webpack://officechromeextension/./app/diagnostics/ariaTelemetry.service.js","webpack://officechromeextension/./app/diagnostics/otelTelemetry.service.js","webpack://officechromeextension/./app/popup/index.js","webpack://officechromeextension/./app/popup/popup.controller.js","webpack://officechromeextension/./app/experimentation/index.js","webpack://officechromeextension/./app/experimentation/experimentConstants.js","webpack://officechromeextension/./app/experimentation/experiment.service.js","webpack://officechromeextension/./app/experimentation/sharing/sharing.controller.js","webpack://officechromeextension/./app/experimentation/sharing/sharing.service.js","webpack://officechromeextension/./app/experimentation/sharing/sharingA/sharingA.controller.js","webpack://officechromeextension/./app/app.js","webpack://officechromeextension/./app/common/browserHandler.ts","webpack://officechromeextension/./app/common/utilities.ts","webpack://officechromeextension/./third_party/angularjs-localizationservice.1.0.1/localize.js","webpack://officechromeextension/webpack/bootstrap","webpack://officechromeextension/webpack/runtime/compat get default export","webpack://officechromeextension/webpack/runtime/define property getters","webpack://officechromeextension/webpack/runtime/global","webpack://officechromeextension/webpack/runtime/hasOwnProperty shorthand","webpack://officechromeextension/webpack/runtime/make namespace object","webpack://officechromeextension/webpack/runtime/runtimeId","webpack://officechromeextension/webpack/runtime/jsonp chunk loading","webpack://officechromeextension/webpack/startup"],"names":["deferred","IDTYPE","MSACID","ORGIDPUID","ACTIVITY","AUTHENTICATION","NAME","AUTHORIZATION","NOTIFICATION","TELEMETRY","USERINFO_AVAILABLE","SSO","LOGOUT","REQUEST_TOKEN","LOG","APPINFO_NAME","TELEM_PREFIX","FILE","APPLICATION_IMAGE_PATH","APPLICATION_LABEL","ERROR","MAX_SIZE_BYTE_LIMIT","OFFICE_APP_FILE_ASSOCIATIONS","EXCEL","ONENOTE","POWERPOINT","WORD","OFFICE_MIME_TYPES","ORIGIN","HTML5","LOCAL_PATH","SUPPORTED_APPLICATIONS","SUPPORTED_FILE_TYPES","JQUERY","EVENT_ID","KEYPRESS","ENTER","ARROWLEFT","ARROWUP","ARROWRIGHT","ARROWDOWN","MOUSEDOWN","LEFT_BUTTON_CLICK","LINKS","OFFICE_URL","PROGRESSPAGE_URL","SETTINGS_URL","SIGNUP","UNINSTALL","OFFICE_HOME_URL","MY_CONTENT_URL","APPS_MODULE_URL","OFFICE_HOME_DEV_URL","SUPPORT_URL","MYACCOUNT_MSA_URL","MYACCOUNT_O365_URL","APP","arguments","SWAY","SWAY_DEFAULT","ONEDRIVE","TEAMS","SHAREPOINT_DEFAULT","OUTLOOK_DEFAULT","OUTLOOK_O365","MENU_VIEWMODE","NONE","NEW","OPEN","ACCOUNT","SETTINGS","OAUTH","ACCESS_TOKEN","AUTH_CODE","CODE","EXPIRES_ON","REFRESH_TOKEN","SERVICE_ENDPOINT","SERVICE_ID","O365CONFIG","CLIENT_ID","CLIENT_SECRET","GRAPH_RESOURCE","ENDPOINTS","INSTANCE","LOGOUT_URI","MRU_URL","PHOTO_URL","ONEDRIVE_URL","SHAREPOINT_URL","REDIRECT_URI","UPLOAD_URL","FEDERATED_URL","MSACONFIG","ONEDRIVE_ITEMS_URL","SCOPE","URL","USERINFO_URL","FILEACCESS","id","priority","type","message","FILE_MAX_SIZE_BYTE_LIMIT_REACHED","FILE_UPLOAD_FAILURE_GENERIC","FILE_UPLOAD_FAILURE_SERVER","FILE_UPLOAD_FAILURE_UNSUPPORTED_MEDIA","FILE_UPLOAD_IN_PROGRESS","SETDEFAULT","AUTOSAVE","buttons","title","AUTOSAVETOONEDRIVE","AUTOSAVETOSHAREPOINT","NOTSIGNEDIN","UNSUPPORTEDFILETYPE","INVALIDSUBSCRIPTION","WEBDOCREDIRECT","DISPLAY_URL","QUERY_OPTION","RECENTS","LIST_LENGTH_MSA","LIST_LENGTH_O365","FILTER","ONEDRIVE_ENDPOINT","DISPLAY_PANEL","LIST","LOADING","NO_DOCS","CANCELLED","GENERIC","NO_DOCS_FOUND","UNSUPPORTED_USER_TYPE","SIGNINSTATUS","UNKNOWN","HASREFRESHTOKEN","SIGNEDIN","COMMAND","SET_DISABLED","TRACK_TRACE","TRACK_EVENT","ENABLED_SETTING_STORAGE_KEY","EVENT_PREFIX","PII_TYPE","IDENTITY","USER_TYPE","MSA","O365","USER_SERVICE_TYPE","MSID","USER_DATA_BOUNDARY","EU","TIMEOUT","DEFAULT_REQUEST","USER_INFO_LOOKUP","USER_INFO_LOOKUP_TEST","COPY_PASTE","TEST","PASTE","GET_CLIPBOARD_DATA","GET_AVAILABLE_COMMANDS","ERROR_RETRIES","HTTP_REQUEST","BROWSER_ICON","DEFAULT","INACTIVE","MESSAGE_CHANNEL","RESPONSE_STATUS_SUCCESS","RESPONSE_STATUS_FAIL","RESPONSE_CODE_NO_SUPPORT","RESPONSE_CODE_INVALID","$q","$log","$timeout","$injector","retries","request","config","timeout","constants","responseError","response","status","debug","url","info","JSON","stringify","data","error_codes","get","$http","startsWith","resolve","error","reject","logDecorator","$delegate","telemetry","getTruncatedString","string","length","substring","trackTrace","properties","logToBackground","severity","stack","filename","source","log","Date","toLocaleString","undefined","month","day","hour","minute","second","extensionOrigin","location","href","origin","toString","replace","trimExtensionOrigin","console","toLowerCase","activity","prepareLog","originalFunction","severityLevel","args","slice","call","logParams","fullStack","Error","messageString","Promise","split","mapStackTrace","mappedStack","match","shift","then","caller","matched","pop","timeStamp","apply","warn","getEnabledSetting","setEnabledSetting","enabled","trackEvent","eventName","measurements","window","dumpStorage","chrome","storage","local","result","commonModule","$httpProvider","$provide","decorator","interceptors","push","factory","keys","defer","promise","set","items","remove","clear","localize","show","notification","index","getLocalizedString","iconUrl","wasCleared","imageUrl","progress","notificationId","httpInterceptor","userService","headers","userType","resource","acquireToken","token","Authorization","clearToken","service","this","getConfig","lookupUserInfo","async","userInfo","oneDriveUrl","method","email","emails","account","cid","getResourceForEndpoint","endpoint","configEndpoint","hasOwnProperty","indexOf","tokenData","idToken","user","parsedJson","encodedIdToken","decodedToken","jwtToken","matches","exec","header","JWSPayload","JWSSig","decodeJwt","base64Decoded","base64IdToken","atob","decodeURIComponent","escape","base64DecodeStringUrlSafe","parse","_logstatus","err","extractIdToken","aud","upn","puid","tid","getUserProfile","id_token","httpRequest","webUrl","reason","getOneDriveUrl","sharePointUrl","getSharePointUrl","scopes","userInfoUrl","aadV2Url","redirectUri","logoutUrl","authorizeUrl","aadClientId","loginUrl","search","createParams","prompt","getUserService","additionalParams","defaultParams","URLSearchParams","Object","assign","fetchUserInfo","object","prop","deleteMetaDataTags","fetchOneDriveUrl","fetchOneDriveQuota","quota","parseInt","total","Math","round","endpointResources","paths","urlPath","pathname","reduce","previous","current","warning","infoFuncs","all","requestAccessToken","scope","response_type","params","navigateToAuthEndpoint","access_token","$window","msaUserService","o365UserService","msidUserService","userOrServiceType","getServiceProvider","getAccessToken","isTokenExpired","expires_on","refreshToken","getIdentityProperty","getRefreshToken","refresh_token","grant_type","tokenUrl","refreshAccessToken","getUserType","getUserInfo","saveTokens","statusText","authorize","serviceType","dataBoundary","userAndTenantId","code","accessToken","acquireTokenFromCode","setUserType","boundaryOrToken","boundary","values","includes","payload","parseJwtToken","xms_tdbr","setUserDataBoundary","idOrToken","userId","tenantId","setUserAndTenantId","osPlugin","OsPlugin","detectOs","oneDSSinkProperties","endpointUrl","plugins","persistentDataFields","name","platform","primaryIdentitySpace","primaryIdentityHash","isAnonymous","tenantGroup","sessionStorage","getItem","oneDSSink","OneDSSink","otelLogger","telemetrySinks","addSink","flushQueue","login","error_description","typeOrToken","tenantInfo","tenants","tenant","resolveTypeAndTenant","tenantEntry","identity","getStoredIdentity","mergeProperties","unpackStateParam","state","appid","inIFrame","searchParams","param","value","createGuid","frameId","cleanup","listener","iframe","document","getElementById","parentNode","removeChild","sender","clearTimeout","has","iframeAuthDelay","setTimeout","createElement","setAttribute","style","visibility","position","width","height","border","body","appendChild","src","handleLogin","logout","handleLogout","useAuthNext","toggle","override","checkAuthFlighting","noLogout","close","tab","checkTransitionAuth","transitionAuthInterval","options","now","checkedTime","toUTCString","storageData","elapsed","authNext","lastCheck","flighted","force","deviceId","getDeviceId","accept","contentType","AppId","FeatureFlags","userServiceProvider","getServiceForUserType","target","key","sourceValue","entries","Array","isArray","forEach","getEndpointBase","expires_in","Number","item","tokenEntry","supportsScopes","required","granted","resourceScope","allTokens","property","saveUserInfo","expiresOn","userPrincipalName","getPhotoFromServer","photoUrl","photoRequest","responseType","photo","reader","FileReader","onload","readAsDataURL","char","timestamp","performance","rand","random","floor","setInterval","initCheckTransition","isLoggedIn","getEndpointUrlForCurrentUser","getUserPhoto","getUserDataBoundary","getUserAndTenantId","uid","waitForUserInfo","userInfoListener","giveUpDelay","giveUp","cleanUp","getUserLicenseInfo","getRecentDocs","getOneDriveItem","itemId","_","getOneDriveSharedItems","supportedMimeType","normalizeMruList","fileList","newFileList","entry","DocumentUrl","Timestamp","Application","FileName","remoteItem","fileName","documentUrl","application","mru","mruItem","app","webDavUrl","supportedExtensions","ext","file","mimeType","packageInfo","package","lastModifiedDateTime","fileSystemInfo","lastAccessedDateTime","Id","getRecentDocumentList","documentsUrl","recentDocs","sharedItems","recent","shared","find","mergeSharedDocs","$scope","mruService","self","onLoad","currentDisplayPanel","getRecentDocumentsFromStorage","docList","recentDocuments","openRecentDocument","doc","clickEvent","appName","ctrlKey","LIST_LENGTH","$watch","refreshRecentDocumentsList","recentDocumentsList","newRecentDocuments","listCount","i","isFileDataValid","appLabel","lastAccessed","toLocaleDateString","imageSource","shortenFilename","createOpenInWebUrl","mruListsEqual","setRecentDocumentsToStorage","oldList","newList","localRecentDocuments","path","controller","ariaTelemetry","otelTelemetry","telemetryProviders","addCustomProperties","sessionId","pii","manifest","AppVersion","version","dataBoundaryPromise","DataBoundary","language","Language","semanticContext","AWTLogManager","setUserId","features","ExperimentFeatures","getEnabledSettingFromStorage","settings","settingName","storedSetting","readSettingValueOrUndefined","telemetry_enabled","lastUpdate","manualOverride","setEnabledSettingInStorage","command","propertiesToTrack","addEventProperties","eventProperties","setProperty","enabledSetting","AWTEventProperties","setName","ariaLogger","logEvent","dataFields","partAFields","otelEvent","eventFlags","dataCategories","diagnosticLevel","sendTelemetryEvent","$document","onSignOutLinkClick","hasSignedIn","openDocument","addAuthParam","concat","signedInWithOrgId","accountPanelOpened","filesSelected","webRedirectInputChecked","telemetryInputChecked","onLine","username","profilePicture","rtl","isChrome","appDescriptionMessage","onMenuItemClick","viewMode","currentViewMode","onSignOutClick","onWelcomeSignInClick","onProfileClick","onSignupLinkClick","onWebRedirectInputChange","webRedirect_disabled","Enabled","onTelemetryInputChange","onFileInputChange","loadFile","openOfficeHome","openSupportPage","supportUrl","openMyAccountPage","browseToRecents","openAppsModule","createDocument","openSharePointSite","authType","handleTableNavigation","event","which","keyCode","currentCell","closest","currentRow","targetCell","prevCell","previousElementSibling","prevRow","querySelector","nextElementSibling","nextRow","preventDefault","focus","FilesSelectedCount","postMessage","appLaunchers","label","iconClass","isBusinessOnly","ready","CheckBoxElements","querySelectorAll","j","storageResult","signInStatus","directive","require","restrict","link","element","attrs","ngModel","bind","$setViewValue","files","stopPropagation","originalEvent","dataTransfer","dropEffect","currentTarget","click","$routeProvider","when","templateUrl","controllerAs","otherwise","redirectTo","constant","DEFAULT_CLIENT_ID","ENABLED","BROWSERS","ENDPOINT","BAD_USER_TYPE","NO_CLIENT_ID","NO_FEATURES","EXPERIMENTS","SHARING","CONTROL","FLIGHTS","experimentConstants","currentUserType","flights","flightsPromise","userTypeMap","getFlight","expName","experimentEnabled","getFlights","flightingDisabled","disabledCheck","Utilities","isNotUndefinedOrNull","isUndefinedOrNull","defaultFlights","clientId","getClientId","deferral","charCodeAt","stringToHex","Features","getFeatures","expKey","setExperimentFlights","invalid","feature","isFeatureInvalid","validateFeatures","featuresToFlights","setFlights","experiment","flightKey","enabledSettings","logName","browser","getBrowserName","enabledBrowsers","enabledForUser","experimentService","flightView","flight","setShareUrl","shareUrl","setFlagFromPermissions","getCID","docSplit","docId","canShare","permissions","shortId","permissionObject","grantedTo","grantedToUser","roles","hasWriteAccess","getMSAPermissions","canBeShared","sharingService","shareDoc","init","shareDocument","openActive","$ariaProvider","$compileProvider","tabindex","imgSrcSanitizationWhitelist","browserListeners","propertyList","browserHandler","edgeBrowser","create","notifications","callback","alert","onButtonClicked","addListener","onClicked","runtime","getPlatformInfo","jasmine","mock","browserAction","setIcon","icon","extension","getURL","i18n","getUILanguage","getMessage","onMessage","removeListener","splice","sendMessage","tabs","createProperties","BrowserHandler","deserializeQuery","query","pl","decode","s","obj","getFileExtension","docExt","splitDoc","navigateToUrlWithNewTab","onSuccess","active","safeOpenNewTab","windows","getAll","onCreated","isExtensionInTestingMode","isExtensionInDevelopmentMode","test","getManifest","update_url","getAppDescription","description","isBackgroundContext","loc","getBackgroundPage","getCurrentTime","getTime","navigator","vendor","getBrowserAndVersion","browserVersion","checkUserAgentForBrowser","regex","RegExp","browserMatch","userAgent","groups","userAgentData","brands","brand","orderedBrowserMatches","isRTL","uiLang","iconPath","getNewId","crypto","randomUUID","angular","module","$filter","filter","input","i18nDirective","updateText","elm","tag","text","$observe","i18NAttrDirective","attr","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","exports","__webpack_modules__","m","O","chunkIds","fn","notFulfilled","Infinity","fulfilled","every","r","n","getter","__esModule","d","a","definition","o","defineProperty","enumerable","g","globalThis","Function","e","prototype","Symbol","toStringTag","installedChunks","chunkId","webpackJsonpCallback","parentChunkLoadingFunction","moreModules","some","chunkLoadingGlobal","__webpack_exports__"],"mappings":"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","file":"\\app.js","sourcesContent":["var deferred = [];\n__webpack_require__.O = (result, chunkIds, fn, priority) => {\n\tif(chunkIds) {\n\t\tpriority = priority || 0;\n\t\tfor(var i = deferred.length; i > 0 && deferred[i - 1][2] > priority; i--) deferred[i] = deferred[i - 1];\n\t\tdeferred[i] = [chunkIds, fn, priority];\n\t\treturn;\n\t}\n\tvar notFulfilled = Infinity;\n\tfor (var i = 0; i < deferred.length; i++) {\n\t\tvar [chunkIds, fn, priority] = deferred[i];\n\t\tvar fulfilled = true;\n\t\tfor (var j = 0; j < chunkIds.length; j++) {\n\t\t\tif ((priority & 1 === 0 || notFulfilled >= priority) && Object.keys(__webpack_require__.O).every((key) => (__webpack_require__.O[key](chunkIds[j])))) {\n\t\t\t\tchunkIds.splice(j--, 1);\n\t\t\t} else {\n\t\t\t\tfulfilled = false;\n\t\t\t\tif(priority < notFulfilled) notFulfilled = priority;\n\t\t\t}\n\t\t}\n\t\tif(fulfilled) {\n\t\t\tdeferred.splice(i--, 1)\n\t\t\tvar r = fn();\n\t\t\tif (r !== undefined) result = r;\n\t\t}\n\t}\n\treturn result;\n};","import { CopyPasteService } from '@1js/office-online-ccp';\r\n\r\nexport default {\r\n    IDTYPE: {\r\n        MSACID: 'MSACID',\r\n        ORGIDPUID: 'OrgIdPUID'\r\n    },\r\n    ACTIVITY: {\r\n        AUTHENTICATION: {\r\n            NAME: 'authentication'\r\n        },\r\n        AUTHORIZATION: {\r\n            NAME: 'authorization'\r\n        },\r\n        NOTIFICATION: {\r\n            NAME: 'notification'\r\n        },\r\n        TELEMETRY: {\r\n            NAME: 'telemetry'\r\n        },\r\n        USERINFO_AVAILABLE: {\r\n            NAME: 'userInfoAvailable'\r\n        },\r\n        SSO: {\r\n            NAME: 'sso'\r\n        },\r\n        LOGOUT: {\r\n            NAME: 'logout'\r\n        },\r\n        REQUEST_TOKEN: {\r\n            NAME: 'requestToken'\r\n        },\r\n        LOG: {\r\n            NAME: 'log'\r\n        },\r\n    },\r\n    APPINFO_NAME: 'OfficeOnlineExtension',\r\n    TELEM_PREFIX: 'Office.Taos.M365Extension',\r\n    FILE: {\r\n        APPLICATION_IMAGE_PATH: {\r\n            'excel': 'assets/excel_doc.png',\r\n            'onenote': 'assets/onenote_doc.png',\r\n            'powerpoint': 'assets/powerpoint_doc.png',\r\n            'unknown': 'assets/generic_doc.png',\r\n            'word': 'assets/word_doc.png'\r\n        },\r\n        APPLICATION_LABEL: {\r\n            'excel': 'ExcelOnlineAppName',\r\n            'onenote': 'OneNoteOnlineAppName',\r\n            'powerpoint': 'PowerPointOnlineAppName',\r\n            'unknown': 'OfficeOnlineAppName',\r\n            'word': 'WordOnlineAppName'\r\n        },\r\n        ERROR: {\r\n            'FILE_SIZE_MAX_EXCEEDED': 'fileSizeMaxExceeded',\r\n            'LOAD_FROM_PATH': 'loadFromPath',\r\n            'UNSUPPORTED_FILE_TYPE': 'unsupportedFileType'\r\n        },\r\n        MAX_SIZE_BYTE_LIMIT: 1024 * 1024 * 4,\r\n        OFFICE_APP_FILE_ASSOCIATIONS: {\r\n            EXCEL: 'excel',\r\n            ONENOTE: 'onenote',\r\n            POWERPOINT: 'powerpoint',\r\n            WORD: 'word'\r\n        },\r\n        OFFICE_MIME_TYPES: {\r\n            'application/msword': 'word',\r\n            'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'word',\r\n            'application/vnd.openxmlformats-officedocument.wordprocessingml.template': 'word',\r\n            'application/vnd.oasis.opendocument.text': 'word',\r\n            'application/vnd.ms-powerpoint': 'powerpoint',\r\n            'application/vnd.openxmlformats-officedocument.presentationml.presentation': 'powerpoint',\r\n            'application/vnd.openxmlformats-officedocument.presentationml.slideshow': 'powerpoint',\r\n            'application/vnd.oasis.opendocument.presentation': 'powerpoint',\r\n            'application/vnd.ms-excel': 'excel',\r\n            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'excel',\r\n            'application/vnd.ms-excel.sheet.binary.macroEnabled.12': 'excel',\r\n            'application/vnd.ms-excel.sheet.macroEnabled.12': 'excel',\r\n            'application/vnd.oasis.opendocument.spreadsheet': 'excel'\r\n        },\r\n        ORIGIN: {\r\n            HTML5: 'html5',\r\n            LOCAL_PATH: 'local_path'\r\n        },\r\n        SUPPORTED_APPLICATIONS: [\r\n            'Word',\r\n            'Excel',\r\n            'PowerPoint',\r\n            'OneNote'\r\n        ],\r\n        SUPPORTED_FILE_TYPES: {\r\n            'doc': 'word',\r\n            'dot': 'word',\r\n            'docx': 'word',\r\n            'dotx': 'word',\r\n            'odt': 'word',\r\n            'ppt': 'powerpoint',\r\n            'pot': 'powerpoint',\r\n            'pps': 'powerpoint',\r\n            // BUG: 214522: 'ppa': 'powerpoint',\r\n            'pptx': 'powerpoint',\r\n            'ppsx': 'powerpoint',\r\n            'odp': 'powerpoint',\r\n            // BUG: 214522: 'xls': 'excel',\r\n            // BUG: 214522: 'xlt': 'excel',\r\n            // BUG: 214522: 'xla': 'excel',\r\n            'xlsx': 'excel',\r\n            'xlsm': 'excel',\r\n            'xlsb': 'excel',\r\n            'ods': 'excel',\r\n            'notebook': 'onenote'\r\n        }\r\n    },\r\n    JQUERY: {\r\n        EVENT_ID: {\r\n            // Reference: http://api.jquery.com/keypress/\r\n            KEYPRESS: {\r\n                ENTER: 13,\r\n                ARROWLEFT: 37,\r\n                ARROWUP: 38,\r\n                ARROWRIGHT: 39,\r\n                ARROWDOWN: 40\r\n            },\r\n            // Reference: http://api.jquery.com/mousedown/\r\n            MOUSEDOWN: {\r\n                LEFT_BUTTON_CLICK: 1\r\n            }\r\n        }\r\n    },\r\n    LINKS: {\r\n        OFFICE_URL: 'https://portal.office.com/home',\r\n        PROGRESSPAGE_URL: 'https://onedrive.live.com',\r\n        SETTINGS_URL: 'chrome://extensions',\r\n        SIGNUP: 'https://onedrive.live.com/about',\r\n        UNINSTALL: 'https://contentstorage.osi.office.net/officeonlineextensionuninstall/uninstall.html',\r\n        OFFICE_HOME_URL: 'https://go.microsoft.com/fwlink/?linkid=859986',\r\n        MY_CONTENT_URL: 'https://go.microsoft.com/fwlink/?linkid=2227960',\r\n        APPS_MODULE_URL: 'https://go.microsoft.com/fwlink/?linkid=2238237',\r\n        OFFICE_HOME_DEV_URL: 'https://go.microsoft.com/fwlink/?linkid=860665',\r\n        SUPPORT_URL: 'https://aka.ms/officeextsignin',\r\n        MYACCOUNT_MSA_URL: 'https://go.microsoft.com/fwlink/?LinkId=823747',\r\n        MYACCOUNT_O365_URL: 'https://go.microsoft.com/fwlink/?LinkId=824642',\r\n        APP: {\r\n            WORD: function () {return `https://office.live.com/start/word.aspx?auth=${arguments[0]}&WT.mc_id=Chrome_OfficeApp`},\r\n            EXCEL: function () {return `https://office.live.com/start/excel.aspx?auth=${arguments[0]}&WT.mc_id=Chrome_OfficeApp`},\r\n            POWERPOINT: function () {return `https://office.live.com/start/powerpoint.aspx?auth=${arguments[0]}&WT.mc_id=Chrome_OfficeApp`},\r\n            ONENOTE: function () {return `https://www.onenote.com/notebooks?auth=${arguments[0]}&WT.mc_id=Chrome_OfficeApp`},\r\n            SWAY: function () {return `https://www.sway.com/?auth_pvr=${arguments[0]}&auth_upn=${arguments[1]}&WT.mc_id=Chrome_OfficeApp`},\r\n            SWAY_DEFAULT: 'https://www.sway.com/?WT.mc_id=Chrome_OfficeApp',\r\n            ONEDRIVE: 'https://onedrive.live.com',\r\n            TEAMS: 'https://teams.microsoft.com',\r\n            SHAREPOINT_DEFAULT: 'https://products.office.com/sharepoint',\r\n            OUTLOOK_DEFAULT: 'https://outlook.com',\r\n            OUTLOOK_O365: 'https://outlook.office365.com'\r\n        }\r\n    },\r\n    MENU_VIEWMODE: {\r\n        NONE: 0,\r\n        NEW: 1,\r\n        OPEN: 2,\r\n        ACCOUNT: 3,\r\n        SETTINGS: 4\r\n    },\r\n    OAUTH: {\r\n        ACCESS_TOKEN: 'access_token',\r\n        AUTH_CODE: 'authorization_code',\r\n        CODE: 'code',\r\n        EXPIRES_ON: 'expires_on',\r\n        REFRESH_TOKEN: 'refresh_token',\r\n        SERVICE_ENDPOINT: 'service_endpoint',\r\n        SERVICE_ID: 'service_id'\r\n    },\r\n    O365CONFIG: {\r\n        CLIENT_ID: 'd08f258a-c5dd-4a8f-8afc-9321d67c767a',\r\n        // [SuppressMessage(\"Microsoft.Security\", \"CS002:SecretInNextLine\", Justification=\"[Bug Id: 3579837]: Fake secret that cannot access resources\")]\r\n        CLIENT_SECRET: '00000000000000000000000000000000',\r\n        GRAPH_RESOURCE: 'https://graph.microsoft.com',\r\n        ENDPOINTS: {\r\n            'officeapps.live.com': 'https://officeapps.live.com',\r\n            'graph.microsoft.com': 'https://graph.microsoft.com'\r\n        },\r\n        INSTANCE: 'https://login.windows.net/common/oauth2/',\r\n        LOGOUT_URI: 'https://login.microsoftonline.com/logout.srf',\r\n        MRU_URL: 'https://ocws.officeapps.live.com/ocs/docs/recent/',\r\n        PHOTO_URL: 'https://graph.microsoft.com/v1.0/me/photo/$value',\r\n        ONEDRIVE_URL: 'https://graph.microsoft.com/v1.0/me/drive/root',\r\n        SHAREPOINT_URL: 'https://graph.microsoft.com/v1.0/sites/root',\r\n        REDIRECT_URI: 'https://login.microsoftonline.com/login.srf',\r\n        UPLOAD_URL: 'https://graph.microsoft.com/v1.0/me/drive/root:/',\r\n        FEDERATED_URL: 'https://login.microsoftonline.com/getuserrealm.srf'\r\n    },\r\n    MSACONFIG: {\r\n        CLIENT_ID: '000000004016DA34',\r\n        // [SuppressMessage(\"Microsoft.Security\", \"CS002:SecretInNextLine\", Justification=\"[Bug Id: 3579838]: Fake secret that cannot access resources\")]\r\n        CLIENT_SECRET: '00000000000000000000000000000000',\r\n        INSTANCE: 'https://login.live.com/oauth20_authorize.srf',\r\n        LOGOUT_URI: 'https://login.live.com/oauth20_logout.srf',\r\n        ONEDRIVE_ITEMS_URL: 'https://api.onedrive.com/v1.0/drive/items/',\r\n        PHOTO_URL: 'https://apis.live.net/v5.0/me/picture',\r\n        REDIRECT_URI: 'https://login.live.com/oauth20_desktop.srf',\r\n        SCOPE: 'wl.basic+wl.emails+wl.signin+wl.offline_access+onedrive.readwrite+wl.skydrive',\r\n        URL: 'https://login.live.com/oauth20_token.srf',\r\n        USERINFO_URL: 'https://apis.live.net/v5.0/me'\r\n    },\r\n    /* Notification priorities:\r\n       -2, -1: Do not use; deprecated\r\n       0 - Lowest priority; will not display in Edge\r\n       1 - Medium priority\r\n       2 - Highest priority\r\n    */\r\n    NOTIFICATION: {\r\n        FILEACCESS: {\r\n            id: 'fileAccess',\r\n            priority: 0,\r\n            type: 'basic',\r\n            message: 'NotificationFileAccess'\r\n        },\r\n        FILE_MAX_SIZE_BYTE_LIMIT_REACHED: {\r\n            id: 'fileMaxSizeByteLimitReached',\r\n            priority: 2,\r\n            type: 'basic',\r\n            message: 'NotificationFileMaxSizeByteLimitReached'\r\n        },\r\n        FILE_UPLOAD_FAILURE_GENERIC: {\r\n            id: 'fileUploadFailureGeneric',\r\n            priority: 2,\r\n            type: 'basic',\r\n            message: 'NotificationFileUploadFailureGeneric'\r\n        },\r\n        FILE_UPLOAD_FAILURE_SERVER: {\r\n            id: 'fileUploadFailureServer',\r\n            priority: 2,\r\n            type: 'basic',\r\n            message: 'NotificationFileUploadFailureServer'\r\n        },\r\n        FILE_UPLOAD_FAILURE_UNSUPPORTED_MEDIA: {\r\n            id: 'fileUploadFailureUnsupportedMedia',\r\n            priority: 2,\r\n            type: 'basic',\r\n            message: 'NotificationFileUploadFailureUnsupportedMedia'\r\n        },\r\n        FILE_UPLOAD_IN_PROGRESS: {\r\n            id: 'fileUploadInProgress',\r\n            priority: 0,\r\n            type: 'basic',\r\n            message: 'NotificationFileUploadInProgress'\r\n        },\r\n        SETDEFAULT: {\r\n            id: 'setDefault',\r\n            priority: 0,\r\n            type: 'basic',\r\n            message: 'NotificationSetDefault'\r\n        },\r\n        AUTOSAVE: {\r\n            id: 'autoSave',\r\n            priority: 0,\r\n            type: 'basic',\r\n            buttons: [\r\n                {title: 'NotificationAutoSaveButton'}\r\n            ]\r\n        },\r\n        AUTOSAVETOONEDRIVE: 'NotificationAutoSaveToOneDrive',\r\n        AUTOSAVETOSHAREPOINT: 'NotificationAutoSaveToSharePoint',\r\n        NOTSIGNEDIN: {\r\n            id: 'notSignedIn',\r\n            priority: 2,\r\n            type: 'basic',\r\n            message: 'NotificationNotSignedIn'\r\n        },\r\n        UNSUPPORTEDFILETYPE: {\r\n            id: 'unsupportedFileType',\r\n            priority: 2,\r\n            type: 'basic',\r\n            message: 'NotificationUnsupportedFileType'\r\n        },\r\n        INVALIDSUBSCRIPTION: {\r\n            id: 'invalidSubscription',\r\n            priority: 2,\r\n            type: 'basic',\r\n            message: 'NotificationInvalidSubscription'\r\n        },\r\n        WEBDOCREDIRECT: {\r\n            id: 'webDocRedirect',\r\n            priority: 0,\r\n            type: 'basic',\r\n            message: 'NotificationWebDocRedirect',\r\n            buttons: [\r\n                {title: 'NotificationWebDocRedirectButton'}\r\n            ]\r\n        }\r\n    },\r\n    ONEDRIVE: {\r\n        DISPLAY_URL: 'https://onedrive.live.com/view.aspx?cid=',\r\n        INSTANCE: 'https://api.onedrive.com/v1.0',\r\n        QUERY_OPTION: '?@name.conflictBehavior=rename'\r\n    },\r\n    RECENTS: {\r\n        LIST_LENGTH_MSA: 3,\r\n        LIST_LENGTH_O365: 3,\r\n        FILTER: '?apps=powerpoint,word,excel,onenote&sort=date',\r\n        ONEDRIVE_ENDPOINT: 'https://api.onedrive.com/v2.1/drive/recent',\r\n        DISPLAY_PANEL: {\r\n            ERROR: 0,\r\n            LIST: 1,\r\n            LOADING: 2,\r\n            NO_DOCS: 3,\r\n            NONE: 4\r\n        },\r\n        ERROR: {\r\n            CANCELLED: 0,\r\n            GENERIC: 1,\r\n            NO_DOCS_FOUND: 2,\r\n            UNSUPPORTED_USER_TYPE: 3\r\n        }\r\n    },\r\n    SIGNINSTATUS: {\r\n        UNKNOWN: -1,\r\n        NONE: 0,\r\n        HASREFRESHTOKEN: 1,\r\n        SIGNEDIN: 2\r\n    },\r\n    TELEMETRY: {\r\n        COMMAND: {\r\n            SET_DISABLED: 'setDisabledTelemetry',\r\n            TRACK_TRACE: 'trackTrace',\r\n            TRACK_EVENT: 'trackEvent'\r\n        },\r\n        ENABLED_SETTING_STORAGE_KEY: 'telemetry_enabled',\r\n        EVENT_PREFIX: 'OO_CHROME_',\r\n        PII_TYPE: {\r\n            IDENTITY: 10\r\n        }\r\n    },\r\n    USER_TYPE: {\r\n        MSA: 'msa',\r\n        O365: 'aad',\r\n        NONE: 'none'\r\n    },\r\n    USER_SERVICE_TYPE: {\r\n        MSA: 'msaUserService',\r\n        O365: 'o365UserService',\r\n        MSID: 'msidUserService',\r\n        NONE: 'noneUserService'\r\n    },\r\n    USER_DATA_BOUNDARY: {\r\n        NONE: 'none',\r\n        EU: 'eu',\r\n    },\r\n    TIMEOUT: {\r\n        DEFAULT_REQUEST: 10000,\r\n        USER_INFO_LOOKUP: 5000,\r\n        USER_INFO_LOOKUP_TEST: 50\r\n    },\r\n    COPY_PASTE: {\r\n        TEST: CopyPasteService.testCommand,\r\n        PASTE: CopyPasteService.pasteCommand,\r\n        GET_CLIPBOARD_DATA: CopyPasteService.getClipboardDataCommand,\r\n        GET_AVAILABLE_COMMANDS: CopyPasteService.getAvailableCommandsCommand\r\n    },\r\n    ERROR_RETRIES: {\r\n        HTTP_REQUEST: 3\r\n    },\r\n    BROWSER_ICON: {\r\n        DEFAULT: '../assets/icon_20.png',\r\n        INACTIVE: '../assets/icon_inactive_20.png'\r\n    },\r\n    SSO: {\r\n        MESSAGE_CHANNEL: 'com.microsoft.browsercore',\r\n        RESPONSE_STATUS_SUCCESS: 'Success',\r\n        RESPONSE_STATUS_FAIL: 'Fail',\r\n        RESPONSE_CODE_NO_SUPPORT: 'NoSupport',\r\n        RESPONSE_CODE_INVALID: -2147186943\r\n    },\r\n};\r\n","import constants from './constants';\r\nimport Utilities from './utilities';\r\nimport 'angular';\r\n\r\nexport default httpInterceptor;\r\n\r\nfunction httpInterceptor($q, $log, $timeout, $injector) {\r\n    var retries = 0;\r\n    return {\r\n        request: function (config) {\r\n            if (Utilities.isUndefinedOrNull(config.timeout)) {\r\n                config.timeout = constants.TIMEOUT.DEFAULT_REQUEST;\r\n            }\r\n            return config;\r\n        },\r\n        responseError: function (response) {\r\n            if (response) {\r\n                switch (response.status) {\r\n                    case 0:\r\n                        $log.debug(`httpErrorResponseInterceptor - Request cancelled - ${response.config.url}`);\r\n                        break;\r\n                    case 401:\r\n                        $log.info(`httpErrorResponseInterceptor - ${response.status} - ${response.config.url} - ${JSON.stringify(response.data)}`);\r\n                        break;\r\n                    case 400:\r\n                        // Error of invalid AADService. Log the info trace.\r\n                        if (\r\n                            Utilities.isNotUndefinedOrNull(response.data) &&\r\n                            Utilities.isNotUndefinedOrNull(response.data.error_codes) &&\r\n                            response.data.error_codes[0] === 50001\r\n                        ) {\r\n                            $log.info(`httpErrorResponseInterceptor -  Invalid AADSerivce - ${response.status} - ${JSON.stringify(response.data)}`);\r\n                            break;\r\n                        }\r\n\r\n                        // Interaction required. Retry the request with the same resource for 3 times.\r\n                        // https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-protocols-oauth-code\r\n                        if (\r\n                            Utilities.isNotUndefinedOrNull(response.data) &&\r\n                            Utilities.isNotUndefinedOrNull(response.data.error_codes) &&\r\n                            response.data.error_codes[0] === 50079\r\n                        ) {\r\n                            $log.info(`httpErrorResponseInterceptor -  Interaction required - ${response.status} - ${JSON.stringify(response.data)}`);\r\n                            if (retries < constants.ERROR_RETRIES.HTTP_REQUEST) {\r\n                                retries++;\r\n                                return $timeout(function () {\r\n                                    var $http = $injector.get('$http');\r\n                                    return $http(response.config);\r\n                                }, constants.TIMEOUT.USER_INFO_LOOKUP);\r\n                            }\r\n\r\n                            retries = 0;\r\n                        }\r\n                        break;\r\n                    case 404:\r\n                        // don't throw exceptions when graph returns something not found\r\n                        if (response.config.url.startsWith('https://graph.microsoft.com/v1.0/me/drive')) {\r\n                            return $q.resolve(response);\r\n                        }\r\n                    // eslint-disable-next-line no-fallthrough\r\n                    default:\r\n                        $log.error(`httpErrorResponseInterceptor - ${response.status} - ${response.config.url} - ${JSON.stringify(response.data)}`);\r\n                }\r\n            }\r\n\r\n            return $q.reject(response);\r\n        },\r\n    };\r\n}\r\n","import BrowserHandler from './browserHandler';\r\nimport Utilities from '../common/utilities';\r\nimport {mapStackTrace} from 'sourcemapped-stacktrace';\r\n\r\nexport default function logDecorator($delegate, telemetry) {\r\n    // App Insights custom property values have a max length of 8192\r\n    // Limit to 8000 to stay under the App Insights limit\r\n    function getTruncatedString(string) {\r\n        return string.length > 8000 ? string.substring(0, 8000) : string;\r\n    }\r\n\r\n    // Wrapper functions for telemetry in order to handle any errors from the telemetry service //\r\n\r\n    // Gets the enabled setting from storage\r\n    function getEnabledSetting() {\r\n        return telemetry.getEnabledSetting();\r\n    }\r\n\r\n    // Sets the enabled setting\r\n    function setEnabledSetting(enabled) {\r\n        try {\r\n            telemetry.setEnabledSetting(enabled);\r\n        } catch (error) {\r\n            $delegate.error(`setEnabledSetting error: ${error}`);\r\n        }\r\n    }\r\n\r\n    // Tracks a custom event\r\n    function trackEvent(eventName, properties, measurements) {\r\n        try {\r\n            telemetry.trackEvent(eventName, properties, measurements);\r\n        } catch (error) {\r\n            $delegate.error(`trackEvent error with eventName ${eventName}: ${error}`);\r\n        }\r\n    }\r\n\r\n    // Tracks a custom trace (logging/diagnostics info)\r\n    function trackTrace(message, properties) {\r\n        try {\r\n            telemetry.trackTrace(message, properties);\r\n        } catch (error) {\r\n            // empty - if trackTrace fails, then error, info, warn, and debug statements can't be logged\r\n        }\r\n    }\r\n\r\n    function trimExtensionOrigin(url) {\r\n        try {\r\n            const extensionOrigin = (new URL(location.href)).origin + '/';\r\n            url = url.toString().replace(extensionOrigin, '');\r\n        }\r\n        // eslint-disable-next-line no-empty\r\n        catch {}\r\n\r\n        return url;\r\n    }\r\n\r\n    // Sends the log in a message where the background script will handle it and log\r\n    // the message to the console. Only useful in cases like the popup where an event\r\n    // may get logged before you can open the debugger window\r\n    function logToBackground(message, severity, stack, filename, source) {\r\n        if (Utilities.isBackgroundContext()) {\r\n            try {\r\n                const now = new Date();\r\n                var timeStamp = now.toLocaleString(undefined, {month: 'numeric', day: 'numeric', hour: \"numeric\", minute: \"numeric\", second: \"numeric\"});\r\n                var log = `[${timeStamp}] (${trimExtensionOrigin(source)}) ${filename ? filename + ' ' : ''} ${message}`;\r\n                console[severity.toLowerCase()](log);\r\n            }\r\n            // eslint-disable-next-line no-empty\r\n            catch {}\r\n            return;\r\n        }\r\n\r\n        BrowserHandler.runtime.sendMessage({\r\n            activity: 'log',\r\n            severity: severity,\r\n            log: message,\r\n            filename: filename,\r\n            stack: stack\r\n        });\r\n    }\r\n\r\n    function messageString(message) {\r\n        if (typeof message === 'string') {\r\n            return message;\r\n        }\r\n        return JSON.stringify(message);\r\n    }\r\n\r\n    // Returns a new logging function (error, info, etc.) that extends the original logging function\r\n    var prepareLog = function (originalFunction, severityLevel) {\r\n        return function () {\r\n            var args = [].slice.call(arguments);\r\n            var logParams = args[0];\r\n            var fullStack = undefined;\r\n\r\n            if (Utilities.isExtensionInDevelopmentMode()) {\r\n                fullStack = Error().stack;\r\n            }\r\n\r\n            var message = getTruncatedString(messageString(logParams.message ? logParams.message : logParams));\r\n\r\n            new Promise((resolve) => {\r\n                if (logParams.stack) {\r\n                    resolve(typeof logParams.stack === 'string' ? getTruncatedString(logParams.stack).split('\\n') : logParams.stack);\r\n                } else if (fullStack) {\r\n                    mapStackTrace(fullStack, mappedStack => {\r\n                        // remove this file from the top of the stack\r\n                        while (mappedStack[0].match('logDecorator.js')) {\r\n                            mappedStack.shift();\r\n                        }\r\n\r\n                        resolve(mappedStack);\r\n                    }, {/*cacheGlobally: true*/});\r\n                } else {\r\n                    resolve([]);\r\n                }\r\n            }).then((stack) => {\r\n                var filename = '';\r\n                var source = logParams.source || location;\r\n                if (logParams.filename) {\r\n                    filename = logParams.filename;\r\n                } else {\r\n                    for (var caller of stack) {\r\n                        var matched = caller.match(/\\b[\\w.]+\\b:\\d+/g);\r\n                        if (!matched) {\r\n                            continue;\r\n                        }\r\n                        filename = matched.pop();\r\n                        break;\r\n                    }\r\n                }\r\n\r\n                logToBackground(message, severityLevel, stack, filename, source);\r\n                var timeStamp = new Date().toLocaleString(undefined, {month: 'numeric', day: 'numeric', hour: \"numeric\", minute: \"numeric\", second: \"numeric\"});\r\n\r\n                args[0] = `[${timeStamp}] ${filename ? filename + ' ' : ''}${severityLevel}: ${message}`;\r\n\r\n                // Only output logs in development mode\r\n                if (Utilities.isExtensionInDevelopmentMode()) {\r\n                    originalFunction.apply(null, args);\r\n                }\r\n\r\n                // Do not track debug trace messages to telemetry\r\n                if (severityLevel === 'DEBUG') {\r\n                    return;\r\n                }\r\n\r\n                trackTrace(severityLevel, {\r\n                    message: message,\r\n                    stack: severityLevel === 'Error' ? stack : '',\r\n                });\r\n            });\r\n        };\r\n    };\r\n\r\n    // Extend the original $delegate logging functions\r\n    //No need to convert debug to Otel since it is just console output\r\n    $delegate.debug = prepareLog($delegate.debug, 'DEBUG');\r\n    $delegate.info = prepareLog($delegate.info, 'Info');\r\n    $delegate.warn = prepareLog($delegate.warn, 'Warn');\r\n    $delegate.error = prepareLog($delegate.error, 'Error');\r\n\r\n    // Attach telemetry functions to the $delegate so that $log can replace the telemetry service throughout the application\r\n    $delegate.getEnabledSetting = getEnabledSetting;\r\n    $delegate.setEnabledSetting = setEnabledSetting;\r\n    $delegate.trackEvent = trackEvent;\r\n    $delegate.trackTrace = trackTrace;\r\n\r\n    return $delegate;\r\n}\r\n","import BrowserHandler from './browserHandler';\r\n\r\nwindow.dumpStorage = () => {\r\n    if (!window.chrome) {\r\n        return;\r\n    }\r\n\r\n    window.chrome.storage.local.get(null, result => {\r\n        console.log(`result '${JSON.stringify(result, '\\t')}'`);\r\n    });\r\n};\r\n\r\nexport default function ($q, $log) {\r\n    return {\r\n        get: function (keys) {\r\n            var deferred = $q.defer();\r\n\r\n            BrowserHandler.storage.local.get(keys, function (result) {\r\n                $log.debug(`storage: get '${JSON.stringify(keys)}', result '${JSON.stringify(result)}'`);\r\n                deferred.resolve(result);\r\n            });\r\n\r\n            return deferred.promise;\r\n        },\r\n\r\n        set: function (items) {\r\n            $log.debug(`storage: set items '${JSON.stringify(items)}'`);\r\n            BrowserHandler.storage.local.set(items);\r\n        },\r\n\r\n        remove: function (keys) {\r\n            var deferred = $q.defer();\r\n\r\n            BrowserHandler.storage.local.remove(keys, function (result) {\r\n                $log.debug(`storage: remove '${JSON.stringify(keys)}', result '${JSON.stringify(result)}'`);\r\n                deferred.resolve(result);\r\n            });\r\n\r\n            return deferred.promise;\r\n        },\r\n\r\n        clear: function () {\r\n            var deferred = $q.defer();\r\n\r\n            BrowserHandler.storage.local.clear(function (result) {\r\n                $log.debug(`storage: clear result '${JSON.stringify(result)}'`);\r\n                deferred.resolve(result);\r\n            });\r\n\r\n            return deferred.promise;\r\n        },\r\n    };\r\n}\r\n","import angular from 'angular';\r\nimport './browserHandler'; /* eslint-disable-line sort-imports */\r\nimport 'angularjs-localizationservice.1.0.1/localize';\r\nimport httpInterceptor from './httpInterceptor';\r\nimport logDecorator from './logDecorator';\r\nimport notification from './notification.service';\r\nimport storage from './storage.service';\r\n\r\nvar commonModule = angular\r\n    .module('app.common', [])\r\n    .config(['$httpProvider', '$provide', appCommon])\r\n    .factory('storage', ['$q', '$log', storage])\r\n    .factory('notification', ['$log', 'localize', notification])\r\n    .factory('httpInterceptor', ['$q', '$log', '$timeout', '$injector', httpInterceptor]);\r\n\r\nexport default commonModule.name;\r\n\r\nfunction appCommon($httpProvider, $provide) {\r\n    $provide.decorator('$log', ['$delegate', 'telemetry', logDecorator]);\r\n\r\n    // Register http interceptors\r\n    $httpProvider.interceptors.push('httpInterceptor');\r\n}\r\n","import Utilities from './utilities';\r\nimport BrowserHandler from './browserHandler';\r\nimport constants from './constants';\r\n\r\nexport default function ($log, localize) {\r\n    return {\r\n        show: function (notification) {\r\n            // Send message to background instance to handle show notification.\r\n            if (!Utilities.isBackgroundContext()) {\r\n                BrowserHandler.runtime.sendMessage({\r\n                    activity: constants.ACTIVITY.NOTIFICATION.NAME,\r\n                    notification: notification,\r\n                });\r\n\r\n                return;\r\n            }\r\n\r\n            var buttons;\r\n            if (notification.buttons !== undefined && notification.buttons !== null) {\r\n                buttons = [];\r\n                for (var index = 0; index < notification.buttons.length; ++index) {\r\n                    buttons[index] = {};\r\n                    buttons[index].title = localize.getLocalizedString(notification.buttons[index].title);\r\n                    buttons[index].iconUrl = notification.buttons[index].iconUrl;\r\n                }\r\n            }\r\n\r\n            BrowserHandler.notifications.clear(notification.id, function (wasCleared) {\r\n                BrowserHandler.notifications.create(\r\n                    notification.id,\r\n                    {\r\n                        iconUrl: '../assets/icon.png',\r\n                        imageUrl: notification.imageUrl,\r\n                        message: localize.getLocalizedString(notification.message),\r\n                        priority: notification.priority,\r\n                        progress: notification.progress,\r\n                        title: '',\r\n                        type: notification.type,\r\n                        buttons: buttons,\r\n                    },\r\n                    function (notificationId) {\r\n                        if (notificationId === undefined || notificationId === null) {\r\n                            $log.error('CreateNotificationError');\r\n                        }\r\n                    }\r\n                );\r\n            });\r\n        },\r\n    };\r\n}\r\n","import angular from 'angular';\r\nimport protectedResourceInterceptor from './protectedResourceInterceptor';\r\nimport userService from './user.service';\r\nimport msidUserService from './msidUser.service';\r\nimport msaUserService from './msaUser.service';\r\nimport o365UserService from './o365User.service';\r\nimport '../common';\r\n\r\nexport default angular\r\n    .module('app.user', [])\r\n    .config(['$httpProvider', '$provide', appUser])\r\n    .factory('protectedResourceInterceptor', ['$q', '$log', '$injector', protectedResourceInterceptor])\r\n    .service('msaUserService', ['$log', '$injector', msaUserService])\r\n    .service('o365UserService', ['$log', '$injector', 'notification', o365UserService])\r\n    .service('msidUserService', ['$log', '$injector', 'notification', msidUserService])\r\n    .factory('userService', ['$q', '$log', '$injector', '$window', 'storage', 'notification', 'msaUserService', 'o365UserService', 'msidUserService', userService])\r\n    .name;\r\n\r\nfunction appUser($httpProvider, $provide) {\r\n    // Register http interceptors\r\n    $httpProvider.interceptors.push('protectedResourceInterceptor');\r\n}\r\n","import Utilities from '../common/utilities';\r\nimport './user.service';\r\nimport constants from '../common/constants';\r\n\r\n\r\nexport default function protectedResourceInterceptor($q, $log, $injector) {\r\n    var userService = $injector.get('userService');\r\n\r\n    return {\r\n        request: function (config) {\r\n            var deferred = $q.defer();\r\n\r\n            if (Utilities.isUndefinedOrNull(config) || Utilities.isUndefinedOrNull(config.headers)) {\r\n                $log.error('protectedResourceInterceptor.request: http request config is null or undefined');\r\n                deferred.resolve(config);\r\n                return deferred.promise;\r\n            }\r\n\r\n            var userType = config.headers['X-UserType'];\r\n\r\n            // Only apply http config changes to requests that have custom header\r\n            if (Utilities.isUndefinedOrNull(userType)) {\r\n                deferred.resolve(config);\r\n                return deferred.promise;\r\n            }\r\n\r\n            var resource = config.headers['X-Resource'];\r\n\r\n            // Remove the custom header; no longer needed\r\n            delete config.headers['X-Resource'];\r\n            delete config.headers['X-UserType'];\r\n            userService.acquireToken(userType, config.url, resource).then(token => {\r\n                // Validate userType within acquireToken method\r\n                if (!Utilities.isUndefinedOrNull(token)) {\r\n                    config.headers.Authorization = 'Bearer ' + token;\r\n                }\r\n                else {\r\n                    $log.warn(`failed to get auth token for type:${userType} url: ${config.url}, resource ${resource}`);\r\n                }\r\n                deferred.resolve(config);\r\n            });\r\n\r\n            return deferred.promise;\r\n        },\r\n        responseError: function (response) {\r\n            if (response && response.status === 401) {\r\n                if (Utilities.isNotUndefinedOrNull(response.config) &&\r\n                    (response.config.url === constants.O365CONFIG.SHAREPOINT_URL || response.config.url === constants.O365CONFIG.PHOTO_URL)) {\r\n                    // Don't clear the token if the request is made to get the sharepoint site url or the user photo.\r\n                    return $q.reject(response);\r\n                }\r\n\r\n                userService.clearToken();\r\n            }\r\n\r\n            return $q.reject(response);\r\n        }\r\n    };\r\n}\r\n","import constants from '../common/constants';\r\n\r\nexport default function msaUserService($log, $injector) {\r\n    this.type = constants.USER_TYPE.MSA;\r\n    this.type = constants.USER_SERVICE_TYPE.MSA;\r\n    this.userType = constants.USER_TYPE.MSA;\r\n    this.getConfig = function () {\r\n        var config = {\r\n            'tokenUrl': constants.MSACONFIG.URL,\r\n            'params': {\r\n                'client_id': constants.MSACONFIG.CLIENT_ID,\r\n                'client_secret': constants.MSACONFIG.CLIENT_SECRET,\r\n                'redirect_uri': constants.MSACONFIG.REDIRECT_URI\r\n            },\r\n            'resource': constants.ONEDRIVE.INSTANCE,\r\n            'loginUrl': constants.MSACONFIG.INSTANCE + '?response_type=code&client_id=' + constants.MSACONFIG.CLIENT_ID + '&redirect_uri=' + constants.MSACONFIG.REDIRECT_URI + '&scope=' + constants.MSACONFIG.SCOPE,\r\n            'logoutUrl': constants.MSACONFIG.LOGOUT_URI,\r\n            'photoUrl': constants.MSACONFIG.PHOTO_URL,\r\n            'documentsUrl': constants.RECENTS.ONEDRIVE_ENDPOINT\r\n        };\r\n\r\n        return config;\r\n    };\r\n\r\n    this.lookupUserInfo = async function (data) {\r\n        return new Promise((resolve, reject) => {\r\n            var userInfo = {\r\n                oneDriveUrl: constants.LINKS.APP.ONEDRIVE\r\n            };\r\n\r\n            var $http = $injector.get('$http');\r\n            var request = {\r\n                method: 'GET',\r\n                url: constants.MSACONFIG.USERINFO_URL,\r\n                headers: {\r\n                    'X-UserType': constants.USER_SERVICE_TYPE.MSA\r\n                }\r\n            };\r\n\r\n            $http(request).then(\r\n                function (response) {\r\n                    var data = response.data;\r\n                    userInfo.email = data.emails.account;\r\n                    userInfo.cid = data.id;\r\n                    resolve(userInfo);\r\n                },\r\n                function () {\r\n                    reject(`msaUser.Service.lookupUserInfo http request failed`);\r\n                });\r\n        });\r\n    };\r\n\r\n    this.getResourceForEndpoint = function (endpoint) {\r\n        return constants.MSACONFIG.SCOPE;\r\n    };\r\n}\r\n","import Utilities from '../common/utilities';\r\nimport constants from '../common/constants';\r\n\r\nexport default function o365UserService($log, $injector, notification) {\r\n    this.type = constants.USER_SERVICE_TYPE.O365;\r\n    this.userType = constants.USER_TYPE.O365;\r\n    this.getConfig = function () {\r\n        var config = {\r\n            'tokenUrl': constants.O365CONFIG.INSTANCE + 'token',\r\n            'params': {\r\n                'client_id': constants.O365CONFIG.CLIENT_ID,\r\n                'client_secret': constants.O365CONFIG.CLIENT_SECRET,\r\n                'redirect_uri': constants.O365CONFIG.REDIRECT_URI,\r\n                'resource': constants.O365CONFIG.GRAPH_RESOURCE\r\n            },\r\n            'resource': constants.O365CONFIG.GRAPH_RESOURCE,\r\n            'loginUrl': constants.O365CONFIG.INSTANCE + 'authorize?response_type=code&client_id=' + constants.O365CONFIG.CLIENT_ID + '&redirect_uri=' + constants.O365CONFIG.REDIRECT_URI + '&response_mode=query',\r\n            'logoutUrl': constants.O365CONFIG.LOGOUT_URI,\r\n            'photoUrl': constants.O365CONFIG.PHOTO_URL,\r\n            'documentsUrl': constants.O365CONFIG.MRU_URL + constants.RECENTS.FILTER\r\n        };\r\n\r\n        return config;\r\n    };\r\n\r\n    this.getResourceForEndpoint = function (endpoint) {\r\n        var resource = this.getConfig().resource;\r\n        if (Utilities.isUndefinedOrNull(endpoint)) {\r\n            return resource;\r\n        }\r\n\r\n        // Return resource from config data.\r\n        for (var configEndpoint in constants.O365CONFIG.ENDPOINTS) {\r\n            if (constants.O365CONFIG.ENDPOINTS.hasOwnProperty(configEndpoint) && endpoint.indexOf(configEndpoint) > -1) {\r\n                resource = constants.O365CONFIG.ENDPOINTS[configEndpoint];\r\n                break;\r\n            }\r\n        }\r\n\r\n        return resource;\r\n    };\r\n\r\n    this.lookupUserInfo = async function (tokenData) {\r\n        var userInfo = getUserProfile(tokenData.id_token);\r\n        const oneDriveUrl = await getOneDriveUrl();\r\n        userInfo.oneDriveUrl = oneDriveUrl;\r\n\r\n        const sharePointUrl = await getSharePointUrl();\r\n        userInfo.sharePointUrl = sharePointUrl || constants.LINKS.APP.SHAREPOINT_DEFAULT;\r\n        return userInfo;\r\n    };\r\n\r\n    async function getOneDriveUrl() {\r\n        var request = {\r\n            method: 'GET',\r\n            url: constants.O365CONFIG.ONEDRIVE_URL,\r\n            headers: {\r\n                'X-UserType': constants.USER_TYPE.O365\r\n            }\r\n        };\r\n\r\n        var userService = $injector.get('userService');\r\n        try {\r\n            var data = await userService.httpRequest(request);\r\n            if (data.webUrl) {\r\n                return data.webUrl;\r\n            }\r\n\r\n            // There is no service info for OD4B\r\n            return Promise.reject('o365UserService.DiscoverServiceEndpoint - Invalid resource');\r\n        }\r\n        catch (reason) {\r\n            clearToken();\r\n            notification.show(constants.NOTIFICATION.INVALIDSUBSCRIPTION);\r\n            $log.error('0365User.getOneDriveUrl failed: %s', reason);\r\n            return null;\r\n        }\r\n    }\r\n\r\n    async function getSharePointUrl() {\r\n        var request = {\r\n            method: 'GET',\r\n            url: constants.O365CONFIG.SHAREPOINT_URL,\r\n            headers: {\r\n                'X-UserType': constants.USER_SERVICE_TYPE.O365\r\n            }\r\n        };\r\n\r\n        var userService = $injector.get('userService');\r\n        try {\r\n            var data = await userService.httpRequest(request);\r\n            if (data.webUrl) {\r\n                return data.webUrl;\r\n            }\r\n            return Promise.reject('No SharePoint info for user');\r\n        }\r\n        catch (reason) {\r\n            $log.error('0365User.getSharePointUrl failed: %s', reason);\r\n            return null;\r\n        }\r\n    }\r\n\r\n    function clearToken() {\r\n        var userService = $injector.get('userService');\r\n        userService.clearToken();\r\n    }\r\n\r\n    // Method from ADAL to extract user profile from idtoken\r\n    // Reference: https://github.com/AzureAD/azure-activedirectory-library-for-js/blob/master/lib/adal.js\r\n    function getUserProfile(idToken) {\r\n        var user = {};\r\n        var parsedJson = extractIdToken(idToken);\r\n        if (parsedJson && parsedJson.hasOwnProperty('aud')) {\r\n            if (parsedJson.aud.toLowerCase() === constants.O365CONFIG.CLIENT_ID.toLowerCase()) {\r\n                if (parsedJson.hasOwnProperty('upn')) {\r\n                    user.email = parsedJson.upn;\r\n                } else if (parsedJson.hasOwnProperty('email')) {\r\n                    user.email = parsedJson.email;\r\n                }\r\n\r\n                if (parsedJson.hasOwnProperty('puid')) {\r\n                    user.puid = parsedJson.puid;\r\n                }\r\n\r\n                if (parsedJson.hasOwnProperty('tid')) {\r\n                    user.tid = parsedJson.tid;\r\n                }\r\n            } else {\r\n                $log.error('IdToken has invalid aud field');\r\n            }\r\n        }\r\n\r\n        return user;\r\n    }\r\n\r\n    // Method from ADAL to extract user profile from idtoken\r\n    // Reference: https://github.com/AzureAD/azure-activedirectory-library-for-js/blob/master/lib/adal.js\r\n    function extractIdToken(encodedIdToken) {\r\n        // id token will be decoded to get the username\r\n        var decodedToken = decodeJwt(encodedIdToken);\r\n        if (!decodedToken) {\r\n            return null;\r\n        }\r\n\r\n        try {\r\n            var base64IdToken = decodedToken.JWSPayload;\r\n            var base64Decoded = base64DecodeStringUrlSafe(base64IdToken);\r\n            if (!base64Decoded) {\r\n                this._logstatus('The returned id_token could not be base64 url safe decoded.');\r\n                return null;\r\n            }\r\n\r\n            // ECMA script has JSON built-in support\r\n            return JSON.parse(base64Decoded);\r\n        } catch (err) {\r\n            $log.error('The returned id_token could not be decoded: ' + err.stack);\r\n        }\r\n\r\n        return null;\r\n    }\r\n\r\n    // Method from ADAL to extract user profile from idtoken\r\n    // Reference: https://github.com/AzureAD/azure-activedirectory-library-for-js/blob/master/lib/adal.js\r\n    function base64DecodeStringUrlSafe(base64IdToken) {\r\n        // html5 should support atob function for decoding\r\n        base64IdToken = base64IdToken.replace(/-/g, '+').replace(/_/g, '/');\r\n        if (window.atob) {\r\n            return decodeURIComponent(escape(window.atob(base64IdToken)));\r\n        }\r\n        return null;\r\n    }\r\n\r\n    // Method from ADAL to extract user profile from idtoken\r\n    // Reference: https://github.com/AzureAD/azure-activedirectory-library-for-js/blob/master/lib/adal.js\r\n    function decodeJwt(jwtToken) {\r\n        var idTokenPartsRegex = /^([^.\\s]*)\\.([^.\\s]+)\\.([^.\\s]*)$/;\r\n\r\n        var matches = idTokenPartsRegex.exec(jwtToken);\r\n        if (!matches || matches.length < 4) {\r\n            $log.error('The returned id_token is not parseable.');\r\n            return null;\r\n        }\r\n\r\n        var crackedToken = {\r\n            header: matches[1],\r\n            JWSPayload: matches[2],\r\n            JWSSig: matches[3],\r\n        };\r\n\r\n        return crackedToken;\r\n    }\r\n}\r\n","import constants from '../common/constants';\r\n\r\nexport default function msidUserService($log, $injector, notification) {\r\n    const type = constants.USER_SERVICE_TYPE.MSID;\r\n    var userService = undefined;\r\n    // previous app registration also included (are they still needed?)\r\n    // Graph:\r\n    // offline_access, Directory.AccessAsUser.All, User.Read.All\r\n    // SharePoint:\r\n    // MyFiles.Read, MyFiles.Write\r\n    const scopes = 'email openid profile user.read';\r\n    const userInfoUrl = 'https://graph.microsoft.com/v1.0/me/';\r\n    const aadV2Url = new URL('https://login.microsoftonline.com/common/oauth2/').toString();\r\n    const msaOAuthUrl = new URL('https://login.live.com/oauth20_authorize.srf').toString();\r\n    const redirectUri = new URL('nativeclient', aadV2Url).toString();\r\n    const logoutUrl = new URL('v2.0/logoutsession', aadV2Url).toString();\r\n    const authorizeUrl = new URL('v2.0/authorize', aadV2Url).toString();\r\n    const aadClientId = 'e28ff72c-58a5-49ba-8125-42ec264d7cd0'; // newest clientId\r\n    const loginUrl = (() => {\r\n        var loginUrl = new URL(authorizeUrl);\r\n        loginUrl.search = createParams({prompt: 'select_account'});\r\n        return loginUrl.toString();\r\n    })();\r\n\r\n    function getUserService() {\r\n        if (!userService) {\r\n            userService = $injector.get('userService');\r\n        }\r\n\r\n        return userService;\r\n    }\r\n\r\n    function createParams(additionalParams) {\r\n        const defaultParams = {\r\n            'client_id': aadClientId,\r\n            'response_type': 'id_token token',\r\n            'redirect_uri': redirectUri,\r\n            'scope': scopes,\r\n            'response_mode': 'fragment',\r\n        };\r\n        const params = new URLSearchParams(Object.assign({}, defaultParams, additionalParams));\r\n        return params.toString();\r\n    }\r\n\r\n    // Could we use chrome.identity.launchWebAuthFlow()\r\n    // with redirect url https://ndjpnladcallmjemlbaebfadecfhkepb.chromiumapp.org/response?\r\n    // see https://developer.chrome.com/extensions/identity#method-launchWebAuthFlow\r\n    function getConfig() {\r\n        return {\r\n            'loginUrl': loginUrl,\r\n            'logoutUrl': logoutUrl,\r\n            'photoUrl': 'https://graph.microsoft.com/beta/me/photo/$value',\r\n            'userInfoUrl': userInfoUrl,\r\n            'documentsUrl': 'https://graph.microsoft.com/v1.0/me/drive/recent'\r\n        };\r\n    }\r\n\r\n    async function handleLogin() {\r\n        const msaParams = {\r\n            'url': msaOAuthUrl,\r\n            'aadredir': 1,\r\n            'prompt': 'select_account'\r\n        };\r\n\r\n        const aadParams = {\r\n            'url': authorizeUrl,\r\n            'prompt': 'select_account'\r\n        };\r\n\r\n        // TODO: Not sure if aadv2 requires dual stack approach where we try one endpoint and then another but if\r\n        // so we then need to determine if we should start with AAD or MSA but default to MSA since it can\r\n        // handle sign up in case they want to create a new account for overview on how to handle dual stack\r\n        // select_account see https://identitydocs.azurewebsites.net/static/overview/user_discovery.html\r\n        const authEndpointParams = [];\r\n        // authEndpointParams.push(msaParams); // not adding until app configuration is updated to support msa\r\n        authEndpointParams.push(aadParams);\r\n\r\n        var accountId = undefined;\r\n        for (var endpointParams of authEndpointParams) {\r\n            var loginUrl = new URL(endpointParams.url);\r\n            delete endpointParams.url;\r\n\r\n            if (accountId) {\r\n                endpointParams.set('login_hint', accountId);\r\n            }\r\n            loginUrl.search = createParams(endpointParams);\r\n            var response = await getUserService().navigateToAuthEndpoint(loginUrl.toString(), type);\r\n            if (!response.error || response.error === 'aad_auth') {\r\n                return;\r\n            }\r\n\r\n            if (response.username) {\r\n                accountId = response.username;\r\n            }\r\n        }\r\n    }\r\n\r\n    async function lookupUserInfo(token) {\r\n        const infoFuncs = [\r\n            fetchUserInfo(),\r\n            fetchOneDriveUrl(),\r\n            fetchOneDriveQuota()\r\n        ];\r\n        var results = await Promise.all(infoFuncs);\r\n\r\n        return results.reduce((previous, current) => {\r\n            return Object.assign(previous, current);\r\n        });\r\n    }\r\n\r\n    function deleteMetaDataTags(object) {\r\n        for (const prop in object) {\r\n            if (object.hasOwnProperty(prop)) {\r\n                if (prop.match(/^@odata/i)) {\r\n                    delete object[prop];\r\n                }\r\n            }\r\n        }\r\n        return object;\r\n    }\r\n\r\n    async function fetchUserInfo() {\r\n        var request = {\r\n            method: 'GET',\r\n            url: userInfoUrl,\r\n            headers: {\r\n                'X-UserType': type\r\n            }\r\n        };\r\n\r\n        var userInfo = {};\r\n        try {\r\n            var response = await getUserService().httpRequest(request);\r\n            userInfo = deleteMetaDataTags(response);\r\n        }\r\n        catch (reason) {\r\n            return Promise.reject(`msidUser.fetchUserInfo failed: ${reason}`);\r\n        }\r\n\r\n        return userInfo;\r\n    }\r\n\r\n    async function fetchOneDriveUrl() {\r\n        var request = {\r\n            method: 'GET',\r\n            url: constants.O365CONFIG.ONEDRIVE_URL,\r\n            headers: {\r\n                'X-UserType': type\r\n            }\r\n        };\r\n\r\n        try {\r\n            var data = await getUserService().httpRequest(request);\r\n            if (data.webUrl) {\r\n                return {'oneDriveUrl': data.webUrl};\r\n            }\r\n\r\n            // There is no service info for OD4B\r\n            return Promise.reject('o365UserService.DiscoverServiceEndpoint - Invalid resource');\r\n        }\r\n        catch (reason) {\r\n            notification.show(constants.NOTIFICATION.INVALIDSUBSCRIPTION);\r\n            $log.error(`msidUser.fetchOneDriveUrl failed: ${JSON.stringify(reason)}`);\r\n            return null;\r\n        }\r\n    }\r\n\r\n    // accounts.microsoft.com makes a call to\r\n    // https://account.microsoft.com/services/api/subscriptions?X-Requested-With=XMLHttpRequest&excludeWindowsStoreInstallOptions=false&_=1571422283464\r\n    // which seems to get consumer subscriptions, maybe another option?\r\n    async function fetchSubscriptionInfo(userType) {\r\n        var request = {\r\n            method: 'GET',\r\n            url: 'https://graph.microsoft.com/v1.0/me/licenseDetails',\r\n            headers: {\r\n                'X-UserType': userType\r\n            }\r\n        };\r\n\r\n        var licenses = {};\r\n        try {\r\n            var response = await getUserService().httpRequest(request);\r\n\r\n            for (const license of response.value.values()) {\r\n                const sku = license.skuPartNumber.toLowerCase();\r\n                var plans = license.servicePlans.filter(plan => plan.provisioningStatus === 'Success').map(plan => plan.servicePlanName.toLowerCase());\r\n                licenses[sku] = plans;\r\n            }\r\n            return {'licenses': licenses};\r\n        }\r\n        catch (reason) {\r\n            $log.error(`msidUser.fetchSubscriptionInfo failed: ${JSON.stringify(reason)}`);\r\n            return;\r\n        }\r\n    }\r\n\r\n    async function fetchOneDriveQuota() {\r\n        var request = {\r\n            method: 'GET',\r\n            url: 'https://graph.microsoft.com/v1.0/me/drive',\r\n            headers: {\r\n                'X-UserType': type\r\n            }\r\n        };\r\n\r\n        try {\r\n            var response = await getUserService().httpRequest(request);\r\n            var quota = parseInt(response.quota.total) / (1024 * 1024 * 1024);\r\n            quota = Math.round(quota * 100) / 100;\r\n            $log.info(`OneDrive quota: ${JSON.stringify(response.quota, null, '\\t')} capacity: ${quota}GB`);\r\n            return {'driveQuota': response.quota.total, 'driveQuotaString': `${quota}GB`};\r\n        }\r\n        catch (reason) {\r\n            return Promise.reject(`msidUser.fetchOneDriveQuota failed: ${reason}`);\r\n        }\r\n    }\r\n\r\n    function getResourceForEndpoint(endpoint) {\r\n        if (!endpoint) {\r\n            return scopes;\r\n        }\r\n\r\n        const endpointResources = {\r\n            'https://graph.microsoft.com': {\r\n                '/v1.0/me/': scopes,\r\n                '/v1.0/me/drive/recent': 'Files.ReadWrite.All' //'https://graph.microsoft.com/Files.ReadWrite.All'\r\n            },\r\n            'https://nleditor.osi.office.net':\r\n            {\r\n                '/NlEditor/': 'https://nleditor.osi.office.net/NlEditor/instrumentation.write'\r\n            }\r\n        };\r\n\r\n        try {\r\n            const url = new URL(endpoint);\r\n            if (!endpointResources.hasOwnProperty(url.origin)) {\r\n                return scopes;\r\n            }\r\n            const paths = endpointResources[url.origin];\r\n            const urlPath = url.pathname;\r\n\r\n            var match = Object.keys(paths).reduce((previous, current) => {\r\n                if (urlPath.startsWith(current) && current.length > previous.length) {\r\n                    return current;\r\n                } else {\r\n                    return previous;\r\n                }\r\n            });\r\n\r\n            return paths[match];\r\n        }\r\n        catch (reason) {\r\n            $log.warning(`msidUser.Service threw an exception: ${reason}`);\r\n            return scopes;\r\n        }\r\n    }\r\n\r\n    async function requestAccessToken(resource, userInfo) {\r\n        var additionalParams = {scope: resource, response_type: 'token'};\r\n        if (userInfo && userInfo.email) {\r\n            // additionalParams['domain_hint'] = organizations;\r\n            additionalParams['login_hint'] = userInfo.email;\r\n        }\r\n        var params = createParams(additionalParams);\r\n        var url = new URL(authorizeUrl);\r\n\r\n        url.search = params.toString();\r\n        var result = await getUserService().navigateToAuthEndpoint(url.href, type, true);\r\n\r\n        if (!result || !result.access_token) {\r\n            // eslint-disable-next-line no-debugger\r\n            debugger;\r\n            $log.info(`failed to get token from iframe for resource ${resource}`);\r\n            return Promise.reject(`unable to retrieve result from ${url.href}`);\r\n        }\r\n\r\n        return result;\r\n    }\r\n\r\n    return {\r\n        type: type,\r\n        getConfig: getConfig,\r\n        getResourceForEndpoint: getResourceForEndpoint,\r\n        // handleLogin: handleLogin,\r\n        lookupUserInfo: lookupUserInfo,\r\n        requestAccessToken: requestAccessToken\r\n    };\r\n}\r\n","import BrowserHandler from '../common/browserHandler';\r\nimport constants from '../common/constants';\r\nimport Utilities from '../common/utilities';\r\nimport { OneDSEndpoint, OneDSSink, OsPlugin } from \"@microsoft/oteljs-1ds\";\r\nimport * as OTel from '@microsoft/oteljs';\r\n\r\n// ppe = 'https://nleditor.osi.officeppe.net/NLEditor/BrowserExtension/V1'\r\nconst FlightingUrl = 'https://nleditor.osi.office.net/NLEditor/api/V1/BrowserExtension';\r\n\r\nexport default function userService($q, $log, $injector, $window, storage, notification, msaUserService, o365UserService, msidUserService) {\r\n    function authMessageListener(message, sender, response) {\r\n        switch (message.activity) {\r\n            case constants.ACTIVITY.LOGOUT.NAME:\r\n                logout().then(() => {\r\n                    response();\r\n                });\r\n\r\n                return true;\r\n            case constants.ACTIVITY.AUTHENTICATION.NAME:\r\n                login(message.type).then(result => {\r\n                    response(result);\r\n                });\r\n\r\n                return true;\r\n            case constants.ACTIVITY.AUTHORIZATION.NAME:\r\n                {\r\n                    // This handler can probably go away if it's determined that we don't\r\n                    // need to call authenticate for any responses that aren't our own\r\n                    if (sender.id === BrowserHandler.runtime.id && message.close) {\r\n                        if (sender.tab && sender.tab.id) {\r\n                            BrowserHandler.tabs.remove(sender.tab.id);\r\n                        }\r\n                        delete message.close;\r\n                    }\r\n\r\n                    authorize(unpackStateParam(message)).then(() => {\r\n                        response();\r\n                    });\r\n\r\n                    return true;\r\n                }\r\n            case constants.ACTIVITY.REQUEST_TOKEN.NAME:\r\n                {\r\n                    navigateToAuthEndpoint(message.data.url, message.data.type, message.data.inIFrame).then(token => {\r\n                        response(token);\r\n                    });\r\n                    return true;\r\n                }\r\n            default:\r\n                {\r\n                    return;\r\n                }\r\n        }\r\n    }\r\n\r\n    // This module can be loaded by pages other than the background page so only\r\n    // handle these messages on the background page\r\n    if (Utilities.isBackgroundContext()) {\r\n        BrowserHandler.runtime.onMessage.addListener(authMessageListener);\r\n    }\r\n\r\n    async function acquireToken(userOrServiceType, endpoint, resource) {\r\n        var userService = {};\r\n        userService = await getServiceProvider(userOrServiceType);\r\n\r\n        if (!userService) {\r\n            $log.error('userService.acquireToken - Invalid type');\r\n            return Promise.reject('Invalid userType');\r\n        }\r\n\r\n        if (!resource && userService.getResourceForEndpoint) {\r\n            resource = userService.getResourceForEndpoint(endpoint);\r\n        }\r\n\r\n        var token = {};\r\n        try {\r\n            token = await getAccessToken(endpoint, resource);\r\n\r\n            // if found cached token for resource/scope and not expired, return it\r\n            if (token && token.access_token && !isTokenExpired(token.expires_on)) {\r\n                $log.debug(`Using cached token with resource:'${resource}'${endpoint ? ' for ' + endpoint : ''} `);\r\n                return token.access_token;\r\n            }\r\n\r\n            token = await requestAccessToken(userService, resource);\r\n\r\n            if (token) {\r\n                saveTokens(userService, endpoint, token);\r\n            } else {\r\n                return Promise.reject('No tokens available');\r\n            }\r\n        }\r\n        catch (reason) {\r\n            $log.error(`userService.acquireToken - failed. reason: ${reason}, userType: ${userOrServiceType}, endpoint: ${endpoint}, resource: ${resource}`);\r\n        }\r\n\r\n        if (!token || !token.access_token || !token.expires_on || isTokenExpired(token.expires_on)) {\r\n            return null;\r\n        }\r\n\r\n        return token.access_token;\r\n    }\r\n\r\n    function getFunctionName() {\r\n        var stack = Error().stack;\r\n        if (stack.length < 3) {\r\n            return;\r\n        }\r\n        var caller = stack.split('\\n')[2];\r\n        var match = caller.match(/^\\s*at\\s*(\\w*)/);\r\n        if (!match || match.length < 2) {\r\n            return;\r\n        }\r\n\r\n        return match[1];\r\n    }\r\n\r\n    async function httpRequest(request) {\r\n        if (!request) {\r\n            return Promise.reject('Invalid Request');\r\n        }\r\n\r\n        var stack = new Error().stack;\r\n        var result = new Promise((resolve, reject) => {\r\n            const $http = $injector.get('$http');\r\n\r\n            $http(request).then(\r\n                (response) => {\r\n                    resolve(response.data);\r\n                },\r\n                (response) => {\r\n                    reject(`httpRequest failed for url: ${request.url} reason: ${response.statusText} stack:\\n ${stack}`);\r\n                });\r\n\r\n        });\r\n\r\n        return (await result);\r\n    }\r\n\r\n    async function acquireTokenFromCode(userService, code) {\r\n        if (!userService) {\r\n            $log.error('userService.acquireTokenFromCode - Invalid type');\r\n            Promise.reject('Invalid userService type');\r\n            return;\r\n        }\r\n\r\n        var config = userService.getConfig();\r\n        config.params.grant_type = constants.OAUTH.AUTH_CODE;\r\n        config.params.code = code;\r\n\r\n        var request = {\r\n            method: 'POST',\r\n            url: config.tokenUrl,\r\n            headers: {\r\n                'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8'\r\n            },\r\n            data: (new URLSearchParams(config.params)).toString()\r\n        };\r\n\r\n        const accessToken = await httpRequest(request);\r\n        await saveTokens(userService, userService.getConfig().resource, accessToken);\r\n        // is all the above needed or would protectedResourceInterceptor call into acquireToken\r\n        // if the userType was just added to the header here?\r\n        await lookupUserInfo(userService, accessToken);\r\n        return accessToken.access_token;\r\n    }\r\n\r\n    async function getRefreshToken() {\r\n        return getIdentityProperty('refresh_token');\r\n    }\r\n\r\n    async function refreshAccessToken(userService, resource, refresh_token) {\r\n        if (!userService) {\r\n            $log.error('userService.refreshAccessToken - Invalid type');\r\n            return Promise.reject('Invalid userType');\r\n        }\r\n\r\n        var token = {};\r\n        var config = userService.getConfig();\r\n\r\n        config.params.grant_type = constants.OAUTH.REFRESH_TOKEN;\r\n        config.params.resource = resource;\r\n        config.params.refresh_token = refresh_token;\r\n\r\n        var request = {\r\n            method: 'POST',\r\n            url: config.tokenUrl,\r\n            headers: {\r\n                'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8',\r\n            },\r\n            data: (new URLSearchParams(config.params)).toString()\r\n        };\r\n\r\n        token = await httpRequest(request);\r\n        return token;\r\n    }\r\n\r\n    async function requestAccessToken(userService, resource) {\r\n        if (!userService) {\r\n            $log.error('userService.requestAccessToken - Invalid type');\r\n            return Promise.reject('Invalid userType');\r\n        }\r\n\r\n        // if there's a refresh token available (code grant only) attempt to renew it\r\n        // if there is no refresh token then it's an implicit flow which just attempts\r\n        // to get a new access token\r\n        const refreshToken = await getRefreshToken();\r\n        if (refreshToken) {\r\n            return refreshAccessToken(userService, resource, refreshToken);\r\n        }\r\n\r\n        const userType = await getUserType();\r\n        var userInfo = await getUserInfo(userType);\r\n        if (userService.requestAccessToken) {\r\n            var result = await userService.requestAccessToken(resource, userInfo);\r\n        }\r\n\r\n        return result;\r\n    }\r\n\r\n    async function authorize(request) {\r\n        const serviceType = request.type;\r\n        var userType = undefined;\r\n        var dataBoundary = undefined;\r\n        var userAndTenantId = undefined;\r\n        var userService = await getServiceProvider(serviceType);\r\n        var result = false;\r\n        if (!userService) {\r\n            $log.error('userService.authenticate - Invalid type');\r\n            return;\r\n        }\r\n\r\n        if (request.code) {\r\n            userType = serviceType.userType;\r\n            try {\r\n                var token = await acquireTokenFromCode(userService, request.code);\r\n                result = !!token;\r\n\r\n            }\r\n            catch (reason) {\r\n                if (userType === constants.USER_TYPE.O365) {\r\n                    notification.show(constants.NOTIFICATION.INVALIDSUBSCRIPTION);\r\n                }\r\n            }\r\n        } else {\r\n\r\n            if (request.id_token) {\r\n                userType = await setUserType(request.id_token);\r\n                dataBoundary = await setUserDataBoundary(request.id_token);\r\n                userAndTenantId = await setUserAndTenantId(request.id_token);\r\n                //Initialize OTel Logger\r\n                const osPlugin = new OsPlugin();\r\n                await osPlugin.detectOs();\r\n                const oneDSSinkProperties = {\r\n                    endpointUrl: dataBoundary.dataBoundary === 'EU' && userType === 'aad' ? OneDSEndpoint.EUDB : OneDSEndpoint.PUBLIC,\r\n                    plugins: [osPlugin],\r\n                };\r\n                const persistentDataFields = [\r\n                    ...OTel.App.getFields({\r\n                        name: \"M365Extension\",\r\n                        platform: \"Web\",\r\n                    }),\r\n                    ...OTel.User.getFields({\r\n                        primaryIdentitySpace: userType === 'aad' ? 'OrgIdPUID' : 'MSAPUID',\r\n                        primaryIdentityHash: userAndTenantId['userId'],\r\n                        isAnonymous: false,\r\n                        tenantId: userAndTenantId['tenantId'],\r\n                        tenantGroup: userType === 'aad' ? 'Commercial' : 'Consumer',\r\n                    }),\r\n                    OTel.makeStringDataField('DeviceType', window.sessionStorage.getItem('deviceType')),\r\n                ];\r\n                const oneDSSink = new OneDSSink(persistentDataFields, oneDSSinkProperties);\r\n                \r\n                //remove existing sinks and add new one for correct data boundary\r\n                $window.otelLogger.telemetrySinks = [];\r\n                $window.otelLogger.addSink(oneDSSink);\r\n                $window.otelLogger.flushQueue();\r\n            }\r\n            if (request.access_token) {\r\n                await saveTokens(userService, userService.getConfig().userInfoUrl, request);\r\n                if (!userType) {\r\n                    userType = await getUserType();\r\n                }\r\n                await lookupUserInfo(userService, request.id_token);\r\n            }\r\n            result = userType !== constants.USER_TYPE.NONE;\r\n        }\r\n        if (request.error) {\r\n            if (request.error === 'interaction_required') {\r\n                login(await getUserType(), false);\r\n            } else {\r\n                $log.error(`userService.authenticate - authentication returned error: ${request.error} description: ${request.error_description} request: ${JSON.stringify(request)}`);\r\n            }\r\n        }\r\n\r\n        $log.trackEvent('Request.Authorization', {'ServiceType': serviceType, 'Succeeded': result, 'EventCategory': 'Request'});\r\n        return result ? Promise.resolve() : Promise.reject();\r\n    }\r\n\r\n    async function clearToken() {\r\n        return Promise.all([\r\n            storage.remove('accessToken'),\r\n            storage.remove('refreshToken'),\r\n            storage.remove('userInfo'),\r\n            storage.remove('userType'),\r\n            storage.remove('identity'),\r\n        ]);\r\n    }\r\n\r\n    async function getLoginStatus() {\r\n        var result = await storage.get('userType');\r\n\r\n        if (!result.userType) {\r\n            return false;\r\n        }\r\n        try {\r\n            var accessToken = await acquireToken(result.userType);\r\n            return !!accessToken;\r\n        }\r\n        catch (reason) {\r\n            return false;\r\n        }\r\n    }\r\n\r\n    async function isLoggedIn() {\r\n        var storageData = await storage.get(['userType', 'identity']);\r\n        return (storageData.identity && storageData.userType && storageData.userType !== constants.USER_TYPE.NONE /*&& result.accessToken*/);\r\n    }\r\n\r\n    async function getUserType() {\r\n        // Does this still need to be here? every telemetry call\r\n        // calls this which causes us to log back in again\r\n        /*\r\n        var status = await getLoginStatus();\r\n        if (!status) {\r\n            deferred.resolve(constants.USER_TYPE.NONE);\r\n            return deferred.promise;\r\n        }\r\n        */\r\n\r\n        var result = await storage.get('userType');\r\n        return result.userType || constants.USER_TYPE.NONE;\r\n    }\r\n\r\n    async function setUserType(typeOrToken) {\r\n        var userType = '';\r\n        if (Object.values(constants.USER_TYPE).includes(typeOrToken)) {\r\n            userType = typeOrToken;\r\n        } else {\r\n            var tenantInfo = resolveTypeAndTenant(typeOrToken);\r\n            userType = tenantInfo.type;\r\n            delete tenantInfo.type;\r\n\r\n            var tenantEntry = {\r\n                [userType]: tenantInfo\r\n            };\r\n\r\n            var identity = await getStoredIdentity();\r\n\r\n            mergeProperties(identity, tenantEntry);\r\n            await storage.set({identity});\r\n        }\r\n\r\n        if (userType !== constants.USER_TYPE.NONE) {\r\n            await storage.set({'userType': userType});\r\n        }\r\n\r\n        return userType;\r\n    }\r\n\r\n    async function getUserDataBoundary() {\r\n        var result = await storage.get('dataBoundary');\r\n        return result.dataBoundary || constants.USER_DATA_BOUNDARY.NONE;\r\n    }\r\n\r\n    async function setUserDataBoundary(boundaryOrToken) {\r\n        var boundary = '';\r\n        if(Object.values(constants.USER_DATA_BOUNDARY).includes(boundaryOrToken)) {\r\n            boundary = boundaryOrToken;\r\n        } else {\r\n            try {\r\n                const {header, payload} = parseJwtToken(boundaryOrToken);\r\n                boundary = {['dataBoundary']: payload.xms_tdbr};\r\n                await storage.set({'dataBoundary': boundary});\r\n            }\r\n            catch (error) {\r\n                $log.error(`userService.setUserDataBoundary - unable to parse token: ${error}`);\r\n                return {type: constants.USER_DATA_BOUNDARY.NONE};\r\n            }\r\n        }\r\n        return boundary;\r\n    }\r\n\r\n    async function getUserAndTenantId() {\r\n        var uid = await storage.get('userId');\r\n        var tid = await storage.get('tenantId');\r\n        var result = {userId: uid['userId'], tenantId: tid['tenantId']};\r\n        return result;\r\n    }\r\n\r\n    async function setUserAndTenantId(idOrToken) {\r\n        var puid = '';\r\n        var tid = '';\r\n        try {\r\n            const {header, payload} = parseJwtToken(idOrToken);\r\n            puid = payload.puid;\r\n            tid = payload.tid;\r\n            await storage.set({'userId': payload.puid});\r\n            await storage.set({'tenantId': payload.tid});\r\n        }\r\n        catch (error) {\r\n            $log.error(`userService.setUserAndTenantId - unable to parse token: ${error}`);\r\n            return undefined;\r\n        }\r\n        return {userId: puid, tenantId: tid};\r\n    }\r\n\r\n    function unpackStateParam(message) {\r\n        // separate the type from the state param\r\n        if (message.state) {\r\n            message.state = decodeURIComponent(message.state);\r\n        }\r\n        var [state, type, appid] = message.state.split('|');\r\n        if (type) {\r\n            message.type = type;\r\n        }\r\n\r\n        return message;\r\n    }\r\n\r\n    async function navigateToAuthEndpoint(url, type, inIFrame) {\r\n        return new Promise(async (resolve, reject) => {\r\n            if (!Utilities.isBackgroundContext()) {\r\n                BrowserHandler.runtime.sendMessage({activity: 'requestToken', data: {url: url, type: type, inIFrame: inIFrame}}, token => {\r\n                    resolve(token);\r\n                });\r\n            } else {\r\n                url = new URL(url);\r\n                const params = url.searchParams;\r\n                for (const param of ['state', 'nonce']) {\r\n                    var value = params.get(param);\r\n                    if (!value) {\r\n                        value = createGuid();\r\n                    }\r\n                    // append the type to ensure the same is used to handle the response\r\n                    if (param === 'state' && type) {\r\n                        value += '|' + type + '|' + constants.APPINFO_NAME;\r\n                    }\r\n\r\n                    params.set(param, value);\r\n                }\r\n\r\n                var frameId = undefined;\r\n                var timeout = undefined;\r\n                // eslint-disable-next-line no-inner-declarations\r\n                function cleanup() {\r\n                    BrowserHandler.runtime.onMessage.removeListener(listener);\r\n                    if (frameId) {\r\n                        var iframe = document.getElementById(frameId);\r\n                        if (iframe) {\r\n                            iframe.parentNode.removeChild(iframe);\r\n                        }\r\n                    }\r\n                }\r\n\r\n                // remember the state parameter to unsure the response has the same state\r\n                const state = params.get('state');\r\n                const scope = params.get('scope');\r\n\r\n                $log.info(`loading auth url:${url.href} ${inIFrame ? 'in iframe' : ''}`);\r\n                var info = await getUserInfo();\r\n                if (info && info.email && !params.has('login_hint')) {\r\n                    params.set('login_hint', info.email);\r\n                }\r\n\r\n                // eslint-disable-next-line no-inner-declarations\r\n                function listener(message, sender, response) {\r\n                    if (sender.id !== BrowserHandler.runtime.id) {\r\n                        $log.debug(`auth listener rejected invalid id: ${sender.id}`);\r\n                        return;\r\n                    }\r\n\r\n                    if (message.activity === constants.ACTIVITY.AUTHORIZATION.NAME) {\r\n                        var result = unpackStateParam(message);\r\n\r\n                        if (!result) {\r\n                            $log.error(`userService.listener - auth url:${url} returned null response `);\r\n                            reject(result);\r\n                        }\r\n\r\n                        if (result.state !== state) {\r\n                            $log.warn(`userService.listener - auth url:${url} mismatched state:${result.state}`);\r\n                        }\r\n\r\n                        $log[result.error ? 'error' : 'debug'](`userService.listener - auth response:${JSON.stringify(result)} received from url:${url}`);\r\n\r\n                        if (timeout) {\r\n                            clearTimeout(timeout);\r\n                        }\r\n\r\n                        delete result.activity;\r\n                        cleanup();\r\n                        resolve(result);\r\n                    }\r\n                }\r\n                BrowserHandler.runtime.onMessage.addListener(listener);\r\n\r\n                if (!inIFrame) {\r\n                    BrowserHandler.tabs.create({url: url.toString()});\r\n                } else {\r\n                    params.set('prompt', 'none');\r\n                    frameId = 'authFrame!' + scope;\r\n\r\n                    const iframeAuthDelay = 60000;\r\n                    timeout = setTimeout(() => {\r\n                        $log.warn(`userService.authInFrame timed out waiting for ${url.toString()} after ${iframeAuthDelay} ms`);\r\n                        cleanup();\r\n                        reject('Timed out waiting for response from iFrame');\r\n                    }, iframeAuthDelay);\r\n\r\n                    var iframe = document.getElementById(frameId);\r\n                    if (!iframe) {\r\n                        iframe = document.createElement('iframe');\r\n                        iframe.setAttribute('id', frameId);\r\n                        iframe.style.visibility = \"hidden\";\r\n                        iframe.style.position = \"absolute\";\r\n                        iframe.style.width = iframe.style.height = \"0\";\r\n                        iframe.style.border = \"0\";\r\n                        iframe.setAttribute(\"sandbox\", \"allow-scripts allow-same-origin allow-forms\");\r\n\r\n                        document.body.appendChild(iframe);\r\n                        iframe.src = url.toString();\r\n                    }\r\n                }\r\n            }\r\n        });\r\n    }\r\n\r\n    async function login(userType, clear = true) {\r\n        if (clear === true) {\r\n            clearToken();\r\n        }\r\n\r\n        var userService = await getServiceProvider(userType);\r\n        if (userService.handleLogin) {\r\n            return userService.handleLogin();\r\n        }\r\n\r\n        const config = userService.getConfig();\r\n        var loginUrl = config['loginUrl'];\r\n        if (!loginUrl) {\r\n            $log.error('userService.login - Invalid type');\r\n            return;\r\n        }\r\n\r\n        return navigateToAuthEndpoint(loginUrl, userService.type);\r\n    }\r\n\r\n    async function logout() {\r\n        const userType = await getUserType();\r\n        var userService = await getServiceProvider(userType);\r\n        clearToken();\r\n        if (userService.handleLogout) {\r\n            await userService.handleLogout();\r\n        } else {\r\n            const config = userService.getConfig();\r\n            var logoutUrl = config['logoutUrl'];\r\n            if (!logoutUrl) {\r\n                $log.error('userService.logout - Invalid type');\r\n                return;\r\n            }\r\n\r\n            var request = {\r\n                method: 'GET',\r\n                url: logoutUrl\r\n            };\r\n\r\n            await httpRequest(request);\r\n        }\r\n\r\n        $log.debug(`userService.logout - ${userType}`);\r\n    }\r\n\r\n    async function getDeviceId() {\r\n        var result = await storage.get('deviceId');\r\n        if (result.deviceId) {\r\n            return result.deviceId;\r\n        }\r\n\r\n        var id = createGuid();\r\n        await storage.set({'deviceId': id});\r\n        return id;\r\n    }\r\n\r\n    async function useAuthNext(toggle) {\r\n        if (typeof toggle !== 'undefined') {\r\n            storage.set({'authNext': {override: toggle}});\r\n        }\r\n\r\n        return checkAuthFlighting({noLogout: true});\r\n    }\r\n\r\n    window.useAuthNext = useAuthNext;\r\n    window.checkTransitionAuth = checkAuthFlighting;\r\n\r\n    // only check once a day\r\n    const transitionAuthInterval = 24 /*hours*/ * 3600 /*seconds per hour*/ * 1000/* millseconds per second*/;\r\n\r\n    async function initCheckTransition() {\r\n        $log.debug('initCheckTransition');\r\n        //check now before setting interval\r\n        await checkAuthFlighting();\r\n        // set the recurring interval to perform the check\r\n        setInterval(checkAuthFlighting, transitionAuthInterval);\r\n    }\r\n\r\n    if (Utilities.isBackgroundContext()) {\r\n        initCheckTransition();\r\n    }\r\n\r\n    async function checkAuthFlighting(options) {\r\n        var now = new Date();\r\n        const checkedTime = now.toUTCString();\r\n        var storageData = await storage.get('authNext');\r\n        now = Math.round(now / 1000);\r\n        var elapsed = 0;\r\n        if (storageData.authNext && storageData.authNext.lastCheck && Utilities.isNotUndefinedOrNull(storageData.authNext.flighted)) {\r\n            elapsed = now - storageData.authNext.lastCheck;\r\n\r\n            if (!(options && options.force === true) && elapsed < transitionAuthInterval && storageData.authNext.flighted) {\r\n                return storageData.authNext.flighted;\r\n            }\r\n        }\r\n\r\n        $log.info(`checkTransitionAuth time:${checkedTime}`);\r\n\r\n        var authNext = await (async () => {\r\n            // Guidance from service is to use deviceId as userId since the userId isn't\r\n            // always available, and would change if they login with a different account.\r\n            // X_UserId needs to be consistent so they don't jump flights but\r\n            // X_CorrelationId isn't required\r\n            const editorService = FlightingUrl;\r\n            var deviceId = await getDeviceId();\r\n            var request = {\r\n                url: editorService,\r\n                method: 'POST',\r\n                accept: 'application/json',\r\n                contentType: 'application/json',\r\n                headers: {\r\n                    // 'X-CorrelationId': deviceId,\r\n                    'X-UserId': deviceId // CodeQL [js/insecure-randomness] False-positive: Device Id for flighting doesn't need to be be cryptographically secure.\r\n                },\r\n                data: {\r\n                    AppId: \"OfficeBX_Online\"\r\n                }\r\n            };\r\n\r\n            var result = {};\r\n            try {\r\n                result = await httpRequest(request);\r\n            } catch (error) {\r\n                // eslint-disable-next-line no-debugger\r\n                debugger;\r\n                $log.error(`userService.checkAuthFlighting - Call to editor service failed. error:${JSON.stringify(error)}`);\r\n            }\r\n\r\n            var enabled = false;\r\n            if (result && result.FeatureFlags && result.FeatureFlags.authNext) {\r\n                var authNext = result.FeatureFlags.authNext;\r\n                enabled = typeof authNext === 'string' ? authNext.toLowerCase() === 'true' : !!authNext;\r\n            }\r\n\r\n            $log.info(`editor featureFlags.authNext returned:${enabled}`);\r\n            return enabled;\r\n        })();\r\n\r\n        await storage.set({'authNext': {flighted: authNext, 'lastCheck': now}});\r\n\r\n        // check the override last so the flighting service will still get called as usual\r\n        if (storageData.authNext && Utilities.isNotUndefinedOrNull(storageData.authNext.override)) {\r\n            $log.info(`using authNext override from local storage.`);\r\n            return storageData.authNext.override;\r\n        }\r\n\r\n        var serviceType = await getIdentityProperty('service');\r\n        if (authNext === (serviceType === constants.USER_SERVICE_TYPE.MSID)) {\r\n            // current serviceType and authNext match so return with no change\r\n            return;\r\n        }\r\n\r\n        $log.trackEvent('Request.AuthNext', {'Elapsed': elapsed, 'AuthNext': authNext, serviceType, 'EventCategory': 'Request'});\r\n\r\n        // logout to force user to login with correct flighted auth\r\n        if (options && !options.noLogout) {\r\n            await logout();\r\n        }\r\n    }\r\n\r\n    async function getLastAuthCheck() {\r\n        if (!window.lastAuthFlightCheck) {\r\n            var result = await storage.get('authNext');\r\n            if (result.lastCheck) {\r\n                window.lastAuthFlightCheck = result.lastCheck;\r\n            }\r\n        }\r\n        return window.lastAuthFlightCheck;\r\n    }\r\n\r\n\r\n    async function getServiceForUserType(userType) {\r\n        // if one serviceType was responsible for logged in identity return it\r\n        var serviceType = await getIdentityProperty('service', userType);\r\n        if (serviceType) {\r\n            return serviceType;\r\n        }\r\n\r\n        // otherwise determine which to use\r\n        serviceType = constants.USER_SERVICE_TYPE.NONE;\r\n        if (await useAuthNext()) {\r\n            return constants.USER_SERVICE_TYPE.MSID;\r\n        }\r\n\r\n        switch (userType) {\r\n            case constants.USER_TYPE.MSA:\r\n                serviceType = constants.USER_SERVICE_TYPE.MSA;\r\n                break;\r\n            case constants.USER_TYPE.O365:\r\n                serviceType = constants.USER_SERVICE_TYPE.O365;\r\n                break;\r\n        }\r\n        return serviceType;\r\n    }\r\n\r\n    async function getServiceProvider(type) {\r\n        var userServiceProvider = null;\r\n        if (!Object.values(constants.USER_SERVICE_TYPE).includes(type)) {\r\n            type = await getServiceForUserType(type);\r\n        }\r\n        // Determine which user service to use and inject\r\n        if (type.indexOf(constants.USER_SERVICE_TYPE.MSA) !== -1) {\r\n            userServiceProvider = msaUserService;\r\n        } else if (type.indexOf(constants.USER_SERVICE_TYPE.O365) !== -1) {\r\n            userServiceProvider = o365UserService;\r\n        } else if (type.indexOf(constants.USER_SERVICE_TYPE.MSID) !== -1) {\r\n            userServiceProvider = msidUserService;\r\n        } else {\r\n            // eslint-disable-next-line no-debugger\r\n            debugger;\r\n            $log.error(`userService.getServiceProvider - Invalid type - ${type}`);\r\n        }\r\n\r\n        return userServiceProvider;\r\n    }\r\n\r\n    async function getStoredIdentity() {\r\n        var result = await storage.get('identity');\r\n        return (result && result.identity) ? result.identity : {};\r\n    }\r\n\r\n    function mergeProperties(target, source) {\r\n        for (var [key, sourceValue] of Object.entries(source)) {\r\n            if (!sourceValue) {\r\n                continue;\r\n            }\r\n\r\n            if (!target[key] || target[key] === \"none\" || sourceValue === \"none\") {\r\n                target[key] = sourceValue;\r\n                continue;\r\n            }\r\n\r\n            if (typeof sourceValue !== typeof target[key]) {\r\n                $log.warn(`skipping ${key} due to conflicting types`);\r\n                continue;\r\n            }\r\n\r\n            if (Array.isArray(sourceValue)) {\r\n                sourceValue.forEach((value) => {\r\n                    var index = target[key].indexOf(value);\r\n                    if (index < 0) {\r\n                        target[key].push(value);\r\n                    }\r\n                });\r\n\r\n                continue;\r\n            }\r\n\r\n            if (typeof sourceValue === 'object') {\r\n\r\n                mergeProperties(target[key], sourceValue);\r\n                continue;\r\n            }\r\n            target[key] = sourceValue;\r\n        }\r\n    }\r\n\r\n    function resolveTypeAndTenant(tokenData) {\r\n        var scopes = tokenData.scopes || tokenData.scope;\r\n        if (scopes && scopes.includes('wl.')) {\r\n            return {type: constants.USER_TYPE.MSA};\r\n        }\r\n        var idToken = tokenData.id_token || tokenData;\r\n        if (!idToken) {\r\n            return {type: constants.USER_TYPE.NONE};\r\n        }\r\n\r\n        const tenants = {\r\n            '9188040d-6c67-4c5b-b112-36a304b66dad': {\r\n                'type': constants.USER_TYPE.MSA, 'audience': 'prod'\r\n            },\r\n            '4925308c-f164-4d2d-bc7e-0631132e9375': {\r\n                'type': constants.USER_TYPE.MSA, 'audience': 'ppe'\r\n            },\r\n            '72f988bf-86f1-41af-91ab-2d7cd011db47': {\r\n                'type': constants.USER_TYPE.O365, 'audience': 'prod', 'domain': 'microsoft.com'\r\n            },\r\n            'f686d426-8d16-42db-81b7-ab578e110ccd': {\r\n                'type': constants.USER_TYPE.O365, 'audience': 'ppe', 'domain': 'microsoft.com'\r\n            }\r\n        };\r\n\r\n        try {\r\n            const {header, payload} = parseJwtToken(idToken);\r\n            var result = {['tenant']: payload.tid};\r\n            if (tenants.hasOwnProperty(result.tenant)) {\r\n                var tenantInfo = tenants[result.tenant];\r\n                result = Object.assign(result, tenantInfo);\r\n            } else {\r\n                // everything not included in tenants would be AAD\r\n                result.type = constants.USER_TYPE.O365;\r\n            }\r\n\r\n            return result;\r\n        }\r\n        catch (error) {\r\n            // If it wasn't parsable then it must be an MSA\r\n            return {type: constants.USER_TYPE.MSA};\r\n        }\r\n    }\r\n\r\n    function getEndpointBase(endpoint) {\r\n        const url = new URL(endpoint);\r\n        return url.origin;\r\n    }\r\n\r\n    async function saveTokens(userService, endpoint, tokenData) {\r\n        if (tokenData.expires_in && !tokenData.expires_on) {\r\n            tokenData.expires_on = Utilities.getCurrentTime() + Number(tokenData.expires_in);\r\n        }\r\n\r\n        if (!endpoint) {\r\n            $log.error('userService.saveTokens - endpoint not provided');\r\n            return;\r\n        }\r\n\r\n        var userType = await getUserType();\r\n        if (userType === constants.USER_TYPE.NONE) {\r\n            userType = await setUserType(tokenData);\r\n        }\r\n\r\n        if (userType === constants.USER_TYPE.NONE) {\r\n            $log.error('userService.saveTokens - unable to resolve userType');\r\n            return;\r\n        }\r\n\r\n        var scope = decodeURIComponent(tokenData.scope).toLowerCase().split(/[ +]/);\r\n\r\n        // if one of the scopes contains a url, then it is the actual endpoint\r\n        for (const item of scope) {\r\n            var result = item.match(/(^https:\\/\\/[.\\w]*(?:\\S+\\/))/i);\r\n            if (result) {\r\n                endpoint = result[result.index];\r\n                break;\r\n            }\r\n        }\r\n        endpoint = getEndpointBase(endpoint);\r\n        if (tokenData.resource && tokenData.resource !== endpoint) {\r\n            $log.info(`saveTokens ${endpoint} does not match ${tokenData.resource}`);\r\n            endpoint = tokenData.resource;\r\n        }\r\n\r\n        var tokenEntry = {\r\n            [userType]: {\r\n                \"id_token\": tokenData.id_token,\r\n                \"refresh_token\": tokenData.refresh_token,\r\n                \"service\": userService.type,\r\n                \"resources\": {\r\n                    [endpoint]: {\r\n                        \"access_token\": tokenData.access_token,\r\n                        \"expires_in\": tokenData.expires_in,\r\n                        \"expires_on\": tokenData.expires_on,\r\n                        \"scope\": scope\r\n                    }\r\n                }\r\n            }\r\n        };\r\n\r\n        var identity = await getStoredIdentity();\r\n\r\n        mergeProperties(identity, tokenEntry);\r\n        await storage.set({identity});\r\n    }\r\n\r\n    function supportsScopes(required, granted) {\r\n        if (!required) {\r\n            return true;\r\n        }\r\n\r\n        if (!granted) {\r\n            return false;\r\n        }\r\n\r\n        if (!Array.isArray(required)) {\r\n            required = required.toLowerCase().split(/[ +]/);\r\n        }\r\n\r\n        for (const scope of required) {\r\n            if (!granted.includes(scope)) {\r\n                return false;\r\n            }\r\n        }\r\n        return true;\r\n    }\r\n\r\n    async function getAccessToken(endpoint, resourceScope) {\r\n        if (!endpoint) {\r\n            $log.error('userService.getAccessToken - endpoint not provided');\r\n            return;\r\n        }\r\n\r\n        endpoint = getEndpointBase(endpoint);\r\n\r\n        try {\r\n            var allTokens = await getIdentityProperty('resources');\r\n\r\n            // either specifically by name or the first one if there is no entry for the endpoint\r\n            if (allTokens[endpoint]) {\r\n\r\n                var tokenData = allTokens[endpoint];\r\n                // if the resource is the same as the endpoint as in the case of legacy auth,\r\n                // no reason to validate the scopes. just return it\r\n                if (endpoint === resourceScope) {\r\n                    return tokenData;\r\n                }\r\n\r\n                if (tokenData && supportsScopes(resourceScope, tokenData.scope)) {\r\n                    return tokenData;\r\n                }\r\n\r\n                // remove it from the array so it's not checked again below\r\n                delete allTokens[endpoint];\r\n            }\r\n\r\n            // in case the token data was stored under a different endpoint, try to find the appropriate\r\n            // scopes stored under other scopes\r\n            for (const token in allTokens) {\r\n                if (supportsScopes(resourceScope, token.scope)) {\r\n                    return token;\r\n                }\r\n            }\r\n\r\n            return null;\r\n        }\r\n        catch (error) {\r\n            return null;\r\n        }\r\n    }\r\n\r\n    async function getUserInfo(userType) {\r\n        return getIdentityProperty('userInfo', userType);\r\n    }\r\n\r\n    async function getIdentityProperty(property, userType) {\r\n        if (!userType) {\r\n            userType = await getUserType();\r\n        }\r\n\r\n        var identity = await getStoredIdentity();\r\n\r\n        if (!identity[userType] || !identity[userType][property]) {\r\n            return null;\r\n        }\r\n\r\n        return identity[userType][property];\r\n    }\r\n\r\n    // Waits for the userInfo to be available (non-null) before resolving\r\n    async function waitForUserInfo(userType) {\r\n        return new Promise(async (resolve) => {\r\n            var userInfo = await getUserInfo(userType);\r\n            // userInfo is available => resolve\r\n            if (Utilities.isNotUndefinedOrNull(userInfo)) {\r\n                return resolve(userInfo);\r\n            }\r\n\r\n            BrowserHandler.runtime.onMessage.addListener(userInfoListener);\r\n\r\n            // in testing mode, only wait for a short time before giving up on getting the userInfo so as not to slow down unit tests too much\r\n            var giveUpDelay = Utilities.isExtensionInTestingMode() ? constants.TIMEOUT.USER_INFO_LOOKUP_TEST : constants.TIMEOUT.USER_INFO_LOOKUP;\r\n\r\n            // if looking up the userInfo takes too long, resolve with the current userInfo (undefined or null)\r\n            var giveUp = setTimeout(() => {\r\n                $log.warn(`userService.waitForUserInfo timed out after ${constants.TIMEOUT.USER_INFO_LOOKUP} ms - ${userType}`);\r\n                cleanUp();\r\n                resolve(userInfo);\r\n            }, giveUpDelay);\r\n\r\n            // listen for a runtime message that is sent when the userInfo is available from lookupUserInfo\r\n            function userInfoListener(request) {\r\n                if (request.activity === constants.ACTIVITY.USERINFO_AVAILABLE.NAME) {\r\n                    cleanUp();\r\n                    clearTimeout(giveUp);\r\n                    resolve(request.data);\r\n                }\r\n            }\r\n\r\n            function cleanUp() {\r\n                BrowserHandler.runtime.onMessage.removeListener(userInfoListener);\r\n            }\r\n        });\r\n    }\r\n\r\n    async function saveUserInfo(userType, data, replace) {\r\n\r\n        var identity = await getStoredIdentity();\r\n\r\n        var userInfo = {};\r\n        if (identity[userType] && identity[userType].userInfo && !replace) {\r\n            userInfo = identity[userType].userInfo;\r\n        }\r\n\r\n        mergeProperties(userInfo, data);\r\n\r\n        if (identity[userType]) {\r\n            identity[userType].userInfo = userInfo;\r\n            await storage.set({identity});\r\n        }\r\n    }\r\n\r\n    function isTokenExpired(expiresOn) {\r\n        var now = Utilities.getCurrentTime();\r\n        var offset = 120;\r\n        return expiresOn && expiresOn > now + offset ? false : true;\r\n    }\r\n\r\n    async function lookupUserInfo(userService, tokenData) {\r\n        var userType = await getUserType();\r\n\r\n        var userInfo = await userService.lookupUserInfo(tokenData);\r\n        // send a message (listened to in waitForUserInfo) with the newly available userInfo\r\n        BrowserHandler.runtime.sendMessage({activity: constants.ACTIVITY.USERINFO_AVAILABLE.NAME, data: userInfo});\r\n        // save the userInfo to local storage\r\n        if (!userInfo.email && userInfo.userPrincipalName) {\r\n            userInfo.email = userInfo.userPrincipalName;\r\n        }\r\n\r\n        await saveUserInfo(userType, userInfo, true);\r\n\r\n        // get user's profile photo\r\n        await getPhotoFromServer(userService);\r\n    }\r\n\r\n    // TODO: consolidate with o365User once we have WebPack\r\n    function parseJwtToken(token) {\r\n        var idTokenPartsRegex = /^([^.\\s]*)\\.([^.\\s]+)\\.([^.\\s]*)$/;\r\n\r\n        var matches = idTokenPartsRegex.exec(token);\r\n        if (!matches || matches.length < 4) {\r\n            $log.error('userService.parseJwtToken - The returned id_token is not parseable.');\r\n            return null;\r\n        }\r\n\r\n        var header = JSON.parse(base64DecodeStringUrlSafe(matches[1]));\r\n        var payload = JSON.parse(base64DecodeStringUrlSafe(matches[2]));\r\n        return {header, payload};\r\n    }\r\n\r\n    function base64DecodeStringUrlSafe(base64IdToken) {\r\n        base64IdToken = base64IdToken.replace(/-/g, '+').replace(/_/g, '/');\r\n        return decodeURIComponent(escape(window.atob(base64IdToken)));\r\n    }\r\n\r\n    // Gets the user's photo (profile picture) from either local storage or an http call\r\n    // Calls the helper functions attached to the service (getUserType, getUserInfo, getPhotoFromServer) to allow for mocking in UTs\r\n    async function getUserPhoto() {\r\n        var userType = await getUserType();\r\n        // Invalid user type - no photo\r\n        if (userType === constants.USER_TYPE.NONE) {\r\n            $log.warn('UserService.getUserPhoto: no signed-in user');\r\n            return Promise.reject(constants.RECENTS.ERROR.UNSUPPORTED_USER_TYPE);\r\n        }\r\n\r\n        var userInfo = await getUserInfo(userType);\r\n        // If there is a photo in local storage, use that\r\n        if (userInfo && userInfo.photo) {\r\n            $log.trackEvent('Request.GotLocalPhoto', {'EventCategory': 'Request'});\r\n            return userInfo.photo;\r\n        }\r\n\r\n        // No local photo - Do not retry to fetch the photo from server, use the default photo instead.\r\n        return Promise.reject('No photo in local storage');\r\n    }\r\n\r\n    // Gets the user's photo from the appropriate endpoint based on the given userType\r\n    async function getPhotoFromServer(userService) {\r\n        const serviceType = userService.type;\r\n        const userType = await getUserType();\r\n        const config = userService.getConfig();\r\n        var photoUrl = config['photoUrl'];\r\n        if (!photoUrl) {\r\n            return;\r\n        }\r\n\r\n        // Request to get photo\r\n        var photoRequest = {\r\n            method: 'GET',\r\n            url: photoUrl,\r\n            responseType: 'blob',\r\n            headers: {\r\n                'X-UserType': serviceType\r\n            }\r\n        };\r\n\r\n        // Send photo request\r\n        try {\r\n            const photo = await httpRequest(photoRequest);\r\n            $log.trackEvent('Request.GotServerPhoto', {'EventCategory': 'Request'});\r\n\r\n            // Convert the photo response into a displayable string source\r\n            var reader = new FileReader();\r\n            reader.onload = async () => {\r\n\r\n                // Save the photo in the userInfo in local storage\r\n                saveUserInfo(userType, {photo: reader.result});\r\n\r\n                return reader.result;\r\n            };\r\n            reader.readAsDataURL(photo);\r\n        }\r\n        catch (error) {\r\n            return null;\r\n        }\r\n\r\n    }\r\n\r\n    async function getEndpointUrlForCurrentUser(endpoint) {\r\n        const userType = await getUserType();\r\n        if (!userType || userType === constants.USER_TYPE.NONE) {\r\n            return null;\r\n        }\r\n        var userService = await getServiceProvider(userType);\r\n        if (!userService) {\r\n            return null;\r\n        }\r\n\r\n        const config = userService.getConfig();\r\n        return config[endpoint];\r\n    }\r\n\r\n    function createGuid() {\r\n        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (char) {\r\n            let timestamp = performance.now();\r\n            const rand = (timestamp + Math.random() * 16) % 16 | 0;\r\n            timestamp = Math.floor(timestamp / 16);\r\n            return (char === 'x' ? rand : (rand & 0x3 | 0x8)).toString(16);\r\n        });\r\n    }\r\n\r\n    async function getUserLicenseInfo() {\r\n        var userInfo = await getUserInfo();\r\n        const licenseProps = ['driveQuota', 'licenses'];\r\n        return licenseProps.reduce((previous, current) => {\r\n            if (userInfo[current]) {\r\n                previous[current] = userInfo[current];\r\n            }\r\n            return previous;\r\n        }, {});\r\n    }\r\n\r\n    // all exports are async\r\n    return {\r\n        acquireToken,\r\n        clearToken,\r\n        isLoggedIn,\r\n        getEndpointUrlForCurrentUser,\r\n        getUserType,\r\n        getUserInfo,\r\n        getUserPhoto,\r\n        getUserDataBoundary,\r\n        getUserAndTenantId,\r\n        httpRequest,\r\n        navigateToAuthEndpoint,\r\n        saveUserInfo,\r\n        waitForUserInfo,\r\n        getUserLicenseInfo,\r\n        useAuthNext,\r\n        // Exposed to be called from UTs\r\n        authorize,\r\n        getAccessToken,\r\n        getPhotoFromServer,\r\n        login,\r\n        logout,\r\n        lookupUserInfo,\r\n    };\r\n}\r\n","import Utilities from '../common/utilities';\r\nimport constants from '../common/constants';\r\n\r\nexport default mruService;\r\n\r\nfunction mruService($q, $log, $http, userService) {\r\n    // Gets the most recent documents list from either OneDrive or o365\r\n    async function getRecentDocumentList() {\r\n        const userType = await userService.getUserType();\r\n        if (userType === constants.USER_TYPE.NONE) {\r\n            return Promise.reject(constants.RECENTS.ERROR.UNSUPPORTED_USER_TYPE);\r\n        }\r\n        const documentsUrl = await userService.getEndpointUrlForCurrentUser('documentsUrl');\r\n        var recentDocs = await getRecentDocs(userType, documentsUrl);\r\n        await mergeSharedDocs(userType, recentDocs);\r\n        return normalizeMruList(recentDocs.data || recentDocs.value || recentDocs);\r\n    }\r\n\r\n    // Calls into the appropriate endpoint to retrieve the recent documents\r\n    async function getRecentDocs(userType, endpointUrl) {\r\n        return new Promise((resolve, reject) => {\r\n            var request = {\r\n                method: 'GET',\r\n                accept: 'application/json',\r\n                url: endpointUrl,\r\n                contentType: 'application/json',\r\n                headers: {\r\n                    'X-UserType': userType\r\n                }\r\n            };\r\n\r\n            $http(request).then(\r\n                function (response) {\r\n                    resolve(response.data);\r\n                },\r\n                function () {\r\n                    reject(constants.RECENTS.ERROR.GENERIC);\r\n                });\r\n        });\r\n    }\r\n\r\n    async function getOneDriveItem(userType, itemId) {\r\n        var request = {\r\n            method: 'GET',\r\n            accept: 'application/json',\r\n            url: `https://graph.microsoft.com/v1.0/me/drive/items/${itemId}`,\r\n            contentType: 'application/json',\r\n            headers: {\r\n                'X-UserType': userType\r\n            }\r\n        };\r\n        try {\r\n            return new Promise(resolve => {\r\n                $http(request)\r\n                    .then(function (response) {\r\n                        resolve(response.data);\r\n                    });\r\n            });\r\n        }\r\n        catch (_) {\r\n            return Promise.resolve({});\r\n        }\r\n    }\r\n\r\n    async function getOneDriveSharedItems(userType) {\r\n        var request = {\r\n            method: 'GET',\r\n            accept: 'application/json',\r\n            url: 'https://graph.microsoft.com/v1.0/me/drive/sharedWithMe',\r\n            contentType: 'application/json',\r\n            headers: {\r\n                'X-UserType': userType,\r\n            },\r\n        };\r\n        return new Promise(resolve => {\r\n            try {\r\n                $http(request)\r\n                    .then(function (response) {\r\n                        resolve(response.data);\r\n                    });\r\n            }\r\n            catch (_) {\r\n                resolve({});\r\n            }\r\n        });\r\n    }\r\n\r\n    // When using msa msgraph, recent docs doesn't include the necessary\r\n    // metadata needed to sort and access the files, so we have to get the\r\n    // documents shared with the person to look up the info for any shared\r\n    // documents and then each individual id for those owned by the person\r\n    async function mergeSharedDocs(userType, recentDocs) {\r\n        if (!recentDocs.value) {\r\n            return;\r\n        }\r\n\r\n        var sharedItems = undefined;\r\n        for (var recent of recentDocs.value) {\r\n            if (Object.values(recent.remoteItem).length) {\r\n                continue;\r\n            }\r\n\r\n            // only make this call if any of the recent docs\r\n            // don't have the remoteItem data\r\n            if (!sharedItems) {\r\n                var result = await getOneDriveSharedItems(userType);\r\n                if (!result.value) {\r\n                    return;\r\n                }\r\n                sharedItems = result.value;\r\n            }\r\n\r\n            var shared = sharedItems.find((value) => {\r\n                return value.remoteItem && value.remoteItem.id && value.remoteItem.id.toLowerCase() === recent.id.toLowerCase();\r\n            });\r\n\r\n            if (shared) {\r\n                recent.remoteItem = shared.remoteItem;\r\n                continue;\r\n            }\r\n\r\n            var item;\r\n            try {\r\n                item = await getOneDriveItem(userType, recent.id);\r\n            } catch (_) {\r\n                continue;\r\n            }\r\n\r\n            if (!item || !item.id) {\r\n                continue;\r\n            }\r\n\r\n            recent.remoteItem.webUrl = item.webUrl;\r\n            recent.name = item.name;\r\n            if (!recent.file) {\r\n                recent.file = item.file;\r\n            }\r\n            if (!recent.remoteItem.package) {\r\n                recent.remoteItem.package = item.package;\r\n            }\r\n            if (!recent.remoteItem.lastModifiedDateTime) {\r\n                recent.remoteItem.lastModifiedDateTime = item.lastModifiedDateTime;\r\n            }\r\n        }\r\n    }\r\n\r\n    const supportedMimeType = {\r\n        'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'word',\r\n        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'excel',\r\n        'application/vnd.openxmlformats-officedocument.presentationml.presentation': 'powerpoint',\r\n        'application/msonenote': 'onenote'\r\n    };\r\n\r\n    // Helper function to normalize the MRU list to be in the form of the JSON returned by MRU++ (with just the values we use)\r\n    // TODO: Once we use MRU++ for both services, we won't need this any longer\r\n    function normalizeMruList(fileList) {\r\n        var newFileList = [];\r\n        if (Utilities.isUndefinedOrNull(fileList)) {\r\n            return newFileList;\r\n        }\r\n\r\n        for (const entry of fileList) {\r\n            // if it's already got the correct metadata just add it and continue\r\n            if (entry.DocumentUrl && entry.Timestamp && entry.Application && entry.FileName/* && entry.Id*/) {\r\n                newFileList.push(entry);\r\n                continue;\r\n            }\r\n\r\n            // if it doesn't have the other known fields, then move along to the next\r\n            if (!entry.remoteItem) {\r\n                continue;\r\n            }\r\n\r\n            const fileName = entry.name || entry.remoteItem.name;\r\n            const id = entry.id || entry.remoteItem.id;\r\n            if (!fileName || !id) {\r\n                continue;\r\n            }\r\n\r\n            var remoteItem = entry.remoteItem;\r\n            var documentUrl = undefined;\r\n            var timestamp = undefined;\r\n            var application = undefined;\r\n            if (remoteItem.mru) {\r\n                var mruItem = remoteItem.mru;\r\n                if (mruItem.app && constants.FILE.SUPPORTED_APPLICATIONS.indexOf(mruItem.app) !== -1) {\r\n                    documentUrl = mruItem.url;\r\n                    timestamp = mruItem.timeStamp;\r\n                    application = mruItem.app.toLowerCase();\r\n                }\r\n            }\r\n            else {\r\n                // look in other known locations for url\r\n                documentUrl = remoteItem.webDavUrl || remoteItem.webUrl;\r\n                if (!documentUrl) {\r\n                    continue;\r\n                }\r\n\r\n                const supportedExtensions = constants.FILE.SUPPORTED_FILE_TYPES;\r\n                var ext = Utilities.getFileExtension(documentUrl) || Utilities.getFileExtension(fileName);\r\n                if (supportedExtensions.hasOwnProperty(ext)) {\r\n                    application = supportedExtensions[ext];\r\n                } else if (remoteItem.file && remoteItem.file.mimeType && supportedMimeType.hasOwnProperty(remoteItem.file.mimeType)) {\r\n                    application = supportedMimeType[remoteItem.file.mimeType];\r\n                } else if (!application) {\r\n                    var packageInfo = remoteItem.package || entry.package;\r\n                    if (!packageInfo || !packageInfo.type) {\r\n                        continue;\r\n                    }\r\n                    application = packageInfo.type.toLowerCase();\r\n                    if (!Object.values(supportedExtensions).includes(application)) {\r\n                        continue;\r\n                    }\r\n                }\r\n                if (!application) {\r\n                    continue;\r\n                }\r\n\r\n                if (remoteItem.lastModifiedDateTime) {\r\n                    timestamp = remoteItem.lastModifiedDateTime;\r\n                } else if (remoteItem.fileSystemInfo) {\r\n                    timestamp = remoteItem.fileSystemInfo.lastAccessedDateTime || remoteItem.fileSystemInfo.lastModifiedDateTime;\r\n                }\r\n\r\n                if (!timestamp) {\r\n                    continue;\r\n                }\r\n            }\r\n\r\n            newFileList.push({\r\n                DocumentUrl: documentUrl,\r\n                Timestamp: timestamp,\r\n                Application: application,\r\n                FileName: fileName,\r\n                Id: id\r\n            });\r\n        }\r\n        return newFileList;\r\n    }\r\n\r\n    var service = {\r\n        getRecentDocumentList: getRecentDocumentList,\r\n\r\n        // Exposed to be called from UTs\r\n        getRecentDocs: getRecentDocs,\r\n        normalizeMruList: normalizeMruList,\r\n    };\r\n\r\n    return service;\r\n}\r\n","import Utilities from '../common/utilities';\r\nimport './mru.service';\r\nimport constants from '../common/constants';\r\n\r\nexport default mruController;\r\n\r\nfunction mruController($scope, $q, $log, storage, mruService) {\r\n    var self = this;\r\n\r\n    // Exposed methods\r\n    self.onLoad = onLoad;\r\n    self.openRecentDocument = openRecentDocument;\r\n\r\n    // Exposed properties\r\n    self.constants = constants;\r\n    self.storage = storage;\r\n    self.currentDisplayPanel = self.constants.RECENTS.DISPLAY_PANEL.LOADING;\r\n    self.recentDocuments = [];\r\n    self.LIST_LENGTH = self.constants.RECENTS.LIST_LENGTH_MSA;\r\n\r\n    function onLoad() {\r\n        $log.debug('Loading MruController');\r\n        // Set to the loading message while we fetch the documents\r\n        self.currentDisplayPanel = self.constants.RECENTS.DISPLAY_PANEL.LOADING;\r\n\r\n        // Pull cached list of recent documents UX info\r\n        self.getRecentDocumentsFromStorage().then(function (docList) {\r\n            if (!Utilities.isUndefinedOrNull(docList) && docList.length > 0) {\r\n                // We got some recents, so show them\r\n                self.recentDocuments = docList;\r\n                self.currentDisplayPanel = self.constants.RECENTS.DISPLAY_PANEL.LIST;\r\n            }\r\n        });\r\n    }\r\n\r\n    $scope.$watch('userType', function (userType) {\r\n        if (userType === self.constants.USER_TYPE.NONE) {\r\n            return;\r\n        }\r\n\r\n        self.LIST_LENGTH = userType === self.constants.USER_TYPE.O365 ? self.constants.RECENTS.LIST_LENGTH_O365 : self.constants.RECENTS.LIST_LENGTH_MSA;\r\n\r\n        // Refresh the list\r\n        self.refreshRecentDocumentsList().then(function () {\r\n            // If there are some documents in the list already (from storage), then display them\r\n            // Otherwise, we didn't find any and just display the no documents message\r\n            self.currentDisplayPanel = (!Utilities.isUndefinedOrNull(self.recentDocuments) && self.recentDocuments.length > 0) ?\r\n                self.constants.RECENTS.DISPLAY_PANEL.LIST : self.constants.RECENTS.DISPLAY_PANEL.NO_DOCS;\r\n        },\r\n            function (error) {\r\n                $log.debug(`MruController $scope.$watch error on refreshRecentDocumentsList: ${error}`);\r\n\r\n                // If we receive an error AND we don't have any cached documents, we'll show an error message\r\n                // This is better than giving the impression the user documents are now gone\r\n                self.currentDisplayPanel = (!Utilities.isUndefinedOrNull(self.recentDocuments) && self.recentDocuments.length > 0) ?\r\n                    self.constants.RECENTS.DISPLAY_PANEL.LIST : self.constants.RECENTS.DISPLAY_PANEL.ERROR;\r\n            });\r\n    });\r\n\r\n    // Open recent document\r\n    function openRecentDocument(doc, clickEvent) {\r\n        //capture and update app names to match apps section capitalization for telemetry purposes\r\n        let appName = doc.application;\r\n        if (doc.application === 'powerpoint') {\r\n            appName = 'PowerPointOnline';\r\n        } else if (doc.application === 'excel') {\r\n            appName = 'ExcelOnline';\r\n        } else if (doc.application === 'word') {\r\n            appName = 'WordOnline';\r\n        } else if (doc.application === 'onenote') {\r\n            appName = 'OneNoteOnline';\r\n        }\r\n\r\n        //do string manipulation to Camelcase app referral\r\n        $log.trackEvent('Action.Refer.'+appName, {'Action_Area': 'Docs', 'Action_SubArea': 'Docs', 'Action_Target': appName,  'EventCategory': 'Action', 'Action_Type': 'Click'});\r\n        Utilities.navigateToUrlWithNewTab(doc.url, Utilities.isUndefinedOrNull(clickEvent) || Utilities.isUndefinedOrNull(clickEvent.ctrlKey) ? true : !clickEvent.ctrlKey);\r\n        window.close();\r\n    }\r\n\r\n    // Gets the most recent document list if signed in and then updates the current list\r\n    this.refreshRecentDocumentsList = function () {\r\n        var deferred = $q.defer();\r\n\r\n        $log.debug('MruController.refreshRecentDocumentsList(): Method start');\r\n\r\n        mruService.getRecentDocumentList().then(function (recentDocumentsList) {\r\n            if (Utilities.isUndefinedOrNull(recentDocumentsList)) {\r\n                // getRecentDocumentsList returned a null array, so set it to empty\r\n                // to clear out the displayed list for the user\r\n                recentDocumentsList = [];\r\n            }\r\n\r\n            // This will be used to store the list returned from the service\r\n            var newRecentDocuments = [];\r\n\r\n            // Keep a separate count from i so we fill the list even if recents has folders\r\n            var listCount = 0;\r\n\r\n            // (re)populate the recentDocuments list\r\n            for (var i = 0; i < recentDocumentsList.length && listCount < self.LIST_LENGTH; i++) {\r\n\r\n                // Skip and warn about any undefined document applications\r\n                if (Utilities.isUndefinedOrNull(recentDocumentsList[i].Application)) {\r\n                    $log.warn(`Undefined document application with document type ${Utilities.getFileExtension(recentDocumentsList[i].FileName)}`);\r\n                    continue;\r\n                }\r\n\r\n                // Ensure the file data from o365 is valid\r\n                if (self.isFileDataValid(recentDocumentsList[i].FileName, recentDocumentsList[i].Application, recentDocumentsList[i].DocumentUrl, recentDocumentsList[i].Timestamp)) {\r\n                    newRecentDocuments.push({\r\n                        appLabel: self.constants.FILE.APPLICATION_LABEL[recentDocumentsList[i].Application.toLowerCase()],\r\n                        application: recentDocumentsList[i].Application,\r\n                        lastAccessed: new Date(recentDocumentsList[i].Timestamp).toLocaleDateString(),\r\n                        imageSource: '../' + self.constants.FILE.APPLICATION_IMAGE_PATH[recentDocumentsList[i].Application.toLowerCase()],\r\n                        name: self.shortenFilename(recentDocumentsList[i].FileName),\r\n                        url: self.createOpenInWebUrl(recentDocumentsList[i].DocumentUrl),\r\n                        id: recentDocumentsList[i].Id\r\n                    });\r\n\r\n                    listCount++;\r\n                }\r\n            }\r\n\r\n            // Only update the list if we found something different\r\n            if (!self.mruListsEqual(self.recentDocuments, newRecentDocuments)) {\r\n                self.recentDocuments = newRecentDocuments;\r\n                self.setRecentDocumentsToStorage(newRecentDocuments);\r\n            }\r\n\r\n            deferred.resolve();\r\n        }, function (error) {\r\n            // rejected promise from mruService.getRecentDocumentList\r\n            deferred.reject(error);\r\n        });\r\n\r\n        return deferred.promise;\r\n    };\r\n\r\n    // Do a check if we have any updated files\r\n    this.mruListsEqual = function (oldList, newList) {\r\n\r\n        if (Utilities.isUndefinedOrNull(oldList) || Utilities.isUndefinedOrNull(newList) || oldList.length !== newList.length) {\r\n            return false;\r\n        }\r\n\r\n        for (var i = 0; i < newList.length; i++) {\r\n            if (newList[i].name !== oldList[i].name ||\r\n                newList[i].url !== oldList[i].url ||\r\n                newList[i].lastAccessed !== oldList[i].lastAccessed) {\r\n                return false;\r\n            }\r\n        }\r\n\r\n        return true;\r\n    };\r\n\r\n    // Gets the list of documents for the UX from local storage\r\n    this.getRecentDocumentsFromStorage = function () {\r\n        var deferred = $q.defer();\r\n\r\n        storage.get('localRecentDocuments').then(function (result) {\r\n            deferred.resolve(result.localRecentDocuments);\r\n        });\r\n\r\n        return deferred.promise;\r\n    };\r\n\r\n    // Puts the documents list for the UX into local storage\r\n    this.setRecentDocumentsToStorage = function (docList) {\r\n        storage.set({\r\n            'localRecentDocuments': docList\r\n        });\r\n    };\r\n\r\n    // Helper function to validate the MRU file data\r\n    this.isFileDataValid = function (name, application, url, lastAccessed) {\r\n\r\n        // Make sure it's a valid application with a label since we use this to get the label and image path\r\n        if (Utilities.isUndefinedOrNull(application) || !self.constants.FILE.APPLICATION_LABEL[application.toLowerCase()]) {\r\n            return false;\r\n        }\r\n\r\n        // Now just make sure the rest of the values are not empty\r\n        return (Utilities.isNotUndefinedOrNull(name) && Utilities.isNotUndefinedOrNull(url) && Utilities.isNotUndefinedOrNull(lastAccessed));\r\n    };\r\n\r\n    // Appends on ?web=1 so the o365 documents open in WAC and are not downloaded\r\n    this.createOpenInWebUrl = function (path) {\r\n        if (self.constants.FILE.SUPPORTED_FILE_TYPES[Utilities.getFileExtension(path)]) {\r\n            return (path + '?web=1');\r\n        }\r\n\r\n        // Return the path if it doesn't and in a known extension. For example, OneNote notebooks\r\n        return path;\r\n    };\r\n\r\n    // Removes file extension (e.g. .docx) if they exist\r\n    this.shortenFilename = function (fileName) {\r\n        var name = fileName.replace(/\\.[^/.]+$/, '');\r\n        return name;\r\n    };\r\n}\r\n","import angular from 'angular';\r\nimport mruService from './mru.service';\r\nimport mruController from './mru.controller';\r\n\r\nexport default angular\r\n    .module('app.mru', [])\r\n    .factory('mruService', ['$q', '$log', '$http', 'userService', mruService])\r\n    .controller('MruController', ['$scope', '$q', '$log', 'storage', 'mruService', mruController])\r\n    .name;\r\n","import angular from 'angular';\r\nimport ariaTelemetry from './ariaTelemetry.service';\r\nimport otelTelemetry from './otelTelemetry.service';\r\nimport telemetry from './telemetry.service';\r\n\r\nexport default angular\r\n    .module('app.diagnostics', [])\r\n    .service('telemetry', ['$injector', 'ariaTelemetry', 'otelTelemetry', telemetry])\r\n    .service('ariaTelemetry', ['$window', ariaTelemetry])\r\n    .service('otelTelemetry', ['$window', otelTelemetry])\r\n    .name;\r\n\r\n","import Utilities from '../common/utilities';\r\nimport BrowserHandler from '../common/browserHandler';\r\nimport angular from 'angular';\r\nimport constants from '../common/constants';\r\nimport {AWTLogManager} from '@aria/webjs-sdk';\r\n\r\nexport default function telemetry($injector, ariaTelemetry, otelTelemetry) {\r\n    var telemetryProviders = [otelTelemetry];\r\n\r\n    var addCustomProperties = async function (properties) {\r\n        var userService = $injector.get('userService');\r\n        var storage = $injector.get('storage');\r\n\r\n        \r\n        // Append app specific properties\r\n        if (Utilities.isUndefinedOrNull(properties)) {\r\n            properties = {};\r\n        }\r\n        \r\n        //Append sessionId for browser and popup sessions\r\n        properties['BrowserSessionId'] = window.sessionStorage.getItem('browserSessionId');\r\n        await storage.get('sessionId').then(function (result) {\r\n            properties['Session_Id'] = result.sessionId;\r\n        });\r\n\r\n        properties.pii = [];\r\n        var manifest = Utilities.getManifest();\r\n        if (manifest) {\r\n            properties.AppVersion = manifest.version;\r\n        }\r\n\r\n        // Get data boundary for EUDB routing\r\n        var dataBoundaryPromise = await userService.getUserDataBoundary();\r\n        properties.DataBoundary = dataBoundaryPromise.dataBoundary;\r\n\r\n        // Get UI language\r\n        var language = BrowserHandler.i18n.getUILanguage();\r\n        if (Utilities.isNotUndefinedOrNull(language)) {\r\n            properties.Language = language;\r\n        }\r\n\r\n        // Add AppInfo.Name for GDPR T3 export\r\n        properties['AppInfo.Name'] = constants.APPINFO_NAME;\r\n        // Add user info properties\r\n        var userType = await userService.getUserType();\r\n        var semanticContext = AWTLogManager.getSemanticContext();\r\n        \r\n        if (userType === constants.USER_TYPE.NONE) {\r\n            // Clear UserInfo.Id and UserInfo.IdType context\r\n            semanticContext.setUserId('', '', '');\r\n            return properties;\r\n        }\r\n\r\n        var userInfo = await userService.getUserInfo(userType);\r\n        if (Utilities.isUndefinedOrNull(userInfo)) {\r\n            // Clear UserInfo.Id and UserInfo.IdType context\r\n            semanticContext.setUserId('', '', '');\r\n            return properties;\r\n        }\r\n\r\n        // userInfo properties - cid from MSA\r\n        if (Utilities.isNotUndefinedOrNull(userInfo.cid)) {\r\n            properties['User_PrimaryIdentityHash'] = userInfo.cid;\r\n            // Instrument AWT about UserInfo.Id and UserInfo.IdType for GDPR requirements\r\n            semanticContext.setUserId(userInfo.cid);\r\n        }\r\n\r\n        // userInfo properties - features (from ExP treatment assignment)\r\n        if (Utilities.isNotUndefinedOrNull(userInfo.features)) {\r\n            properties.ExperimentFeatures = userInfo.features.toString();\r\n        }\r\n\r\n        // PII identity properties - puid from O365\r\n        if (Utilities.isNotUndefinedOrNull(userInfo.puid)) {\r\n            properties.pii.push({type: constants.TELEMETRY.PII_TYPE.IDENTITY, name: 'User_PrimaryIdentityHash', value: userInfo.puid});\r\n            // Instrument AWT about UserInfo.Id and UserInfo.IdType for GDPR requirements\r\n            semanticContext.setUserId(userInfo.puid);\r\n        }\r\n\r\n        if (Utilities.isNotUndefinedOrNull(userInfo.tid)) {\r\n            properties['User_TenantId'] = userInfo.tid;\r\n        }\r\n\r\n        return properties;\r\n    };\r\n\r\n    // Parses correctly the value of setting\r\n    // Returns undefined if the value cannot be parsed.\r\n    var readSettingValueOrUndefined = function (settings, settingName) {\r\n        if (!settings[settingName]) {return undefined}\r\n\r\n        var storedSetting = JSON.parse(settings[settingName]);\r\n\r\n        if (storedSetting.value === undefined) {return undefined}\r\n\r\n        return JSON.parse(storedSetting.value);\r\n    };\r\n\r\n    var getEnabledSettingFromStorage = function () {\r\n        var $q = $injector.get('$q');\r\n        var storage = $injector.get('storage');\r\n        var deferred = $q.defer();\r\n\r\n        storage.get(['telemetry_enabled', 'enableTelemetry']).then(function (result) {\r\n            deferred.resolve(\r\n                Utilities.isUndefinedOrNull(result)\r\n                    || readSettingValueOrUndefined(result, 'enableTelemetry') === true\r\n                    || Utilities.isUndefinedOrNull(result.telemetry_enabled)\r\n                    || result.telemetry_enabled === true\r\n                    ? true : false);\r\n        });\r\n\r\n        return deferred.promise;\r\n    };\r\n\r\n    var setEnabledSettingInStorage = function (enabled) {\r\n        var storage = $injector.get('storage');\r\n        storage.set({\r\n            'telemetry_enabled': enabled,\r\n            'enableTelemetry': JSON.stringify(\r\n                {\r\n                    value: JSON.stringify(enabled),\r\n                    lastUpdate: Date.now(),\r\n                    manualOverride: false\r\n                }\r\n            ),\r\n        });\r\n    };\r\n\r\n    var service = {\r\n        // Get telemetry setting from storage\r\n        getEnabledSetting: function () {\r\n            return getEnabledSettingFromStorage();\r\n        },\r\n\r\n        // Set telemetry setting from storage\r\n        setEnabledSetting: function (enabled) {\r\n            // App Insights workaround: send message to background instance to handle sending telemetry data\r\n            if (!Utilities.isBackgroundContext()) {\r\n                BrowserHandler.runtime.sendMessage({\r\n                    activity: constants.ACTIVITY.TELEMETRY.NAME,\r\n                    command: constants.TELEMETRY.COMMAND.SET_DISABLED,\r\n                    enabled: enabled\r\n                });\r\n\r\n                return;\r\n            }\r\n\r\n            // Cache setting in local storage\r\n            setEnabledSettingInStorage(enabled);\r\n            for (var i = 0; i < telemetryProviders.length; ++i) {\r\n                telemetryProviders[i].setEnabledSetting(enabled);\r\n            }\r\n        },\r\n\r\n        // Use to track custom application events and sends to application insights\r\n        trackEvent: async function (eventName, properties, measurements) {\r\n            if (angular.isUndefined(eventName) || !angular.isString(eventName)) {\r\n                return;\r\n            }\r\n\r\n            // Send message to background instance to handle sending telemetry data\r\n            if (!Utilities.isBackgroundContext()) {\r\n                BrowserHandler.runtime.sendMessage({\r\n                    activity: constants.ACTIVITY.TELEMETRY.NAME,\r\n                    command: constants.TELEMETRY.COMMAND.TRACK_EVENT,\r\n                    eventName: eventName,\r\n                    properties: properties,\r\n                    measurements: measurements\r\n                });\r\n\r\n                return;\r\n            }\r\n\r\n            properties = await addCustomProperties(properties);\r\n            for (var i = 0; i < telemetryProviders.length; ++i) {\r\n                var propertiesToTrack = angular.extend({}, properties);\r\n                telemetryProviders[i].trackEvent(eventName, propertiesToTrack, measurements);\r\n            }\r\n\r\n        },\r\n\r\n        // Use to track trace messages (ie. logging/diagnostics info) and sends to application insights\r\n        trackTrace: async function (message, properties) {\r\n            if (angular.isUndefined(message) || !angular.isString(message)) {\r\n                return;\r\n            }\r\n\r\n            // Send message to background instance to handle sending telemetry data\r\n            if (!Utilities.isBackgroundContext()) {\r\n                BrowserHandler.runtime.sendMessage({\r\n                    activity: constants.ACTIVITY.TELEMETRY.NAME,\r\n                    command: constants.TELEMETRY.COMMAND.TRACK_TRACE,\r\n                    message: message,\r\n                    properties: properties\r\n                });\r\n\r\n                return;\r\n            }\r\n\r\n            properties = await addCustomProperties(properties);\r\n            for (var i = 0; i < telemetryProviders.length; ++i) {\r\n                var propertiesToTrack = angular.extend({}, properties);\r\n                telemetryProviders[i].trackTrace(message, propertiesToTrack);\r\n            }\r\n        }\r\n    };\r\n\r\n    // return the local instance when called\r\n    return service;\r\n}\r\n","import Utilities from '../common/utilities';\r\nimport './telemetry.service';\r\nimport constants from '../common/constants';\r\nimport {AWTEventProperties} from '@aria/webjs-sdk';\r\n\r\nexport default function ariaTelemetry($window) {\r\n    var addEventProperties = function (eventProperties, properties) {\r\n        if (Utilities.isUndefinedOrNull(eventProperties) || Utilities.isUndefinedOrNull(properties)) {\r\n            return;\r\n        }\r\n\r\n        // Obfuscate pii properties out and remove\r\n        if (!Utilities.isUndefinedOrNull(properties.pii)) {\r\n            for (var i = 0; i <= properties.pii.length - 1; ++i) {\r\n                eventProperties.setProperty(properties.pii[i].name, properties.pii[i].value, properties.pii[i].type);\r\n            }\r\n            delete properties.pii;\r\n        }\r\n\r\n        // Add rest of properties\r\n        for (var property in properties) {\r\n            if (properties.hasOwnProperty(property)) {\r\n                eventProperties.setProperty(property, properties[property]);\r\n            }\r\n        }\r\n    };\r\n\r\n    var enabledSetting = true;\r\n\r\n    this.setEnabledSetting = function (enabled) {\r\n        enabledSetting = enabled;\r\n    };\r\n\r\n    this.trackEvent = function (eventName, properties, measurements) {\r\n        if (!enabledSetting) {\r\n            return;\r\n        }\r\n\r\n        // ARIA: Bug when dots are in event name; replace with underscores\r\n        eventName = eventName.replace(/\\./g, '_');\r\n\r\n        var eventProperties = new AWTEventProperties();\r\n        eventProperties.setName(constants.TELEMETRY.EVENT_PREFIX + eventName);\r\n        addEventProperties(eventProperties, properties);\r\n        addEventProperties(eventProperties, measurements);\r\n\r\n        $window.ariaLogger.logEvent(eventProperties);\r\n    };\r\n\r\n    this.trackTrace = function (message, properties) {\r\n        if (!enabledSetting) {\r\n            return;\r\n        }\r\n\r\n        var eventProperties = new AWTEventProperties();\r\n        eventProperties.setName(constants.TELEMETRY.EVENT_PREFIX + message);\r\n        eventProperties.setProperty('severity', message);\r\n        addEventProperties(eventProperties, properties);\r\n\r\n        $window.ariaLogger.logEvent(eventProperties);\r\n    };\r\n}\r\n","import './telemetry.service';\r\nimport constants from '../common/constants';\r\nimport * as OTel from '@microsoft/oteljs';\r\n\r\nexport default function otelTelemetry($window) {\r\n\r\n  this.trackEvent = function (eventName, properties, measurements) {\r\n    if (!enabledSetting) {\r\n      return;\r\n    }\r\n    let dataFields = [];\r\n\r\n    //remove data prefix from session id and browser session id\r\n    $window.otelLogger.partAFields = [\r\n      OTel.makeStringDataField(\"Session_Id\", properties['Session_Id']),\r\n      OTel.makeStringDataField(\"BrowserSessionId\", properties['BrowserSessionId']),\r\n    ];\r\n\r\n    for (let item in properties) {\r\n      if(item !== 'AppInfo.Name' && item !== 'Session_Id' && item !== 'BrowserSessionId'){\r\n        dataFields.push(OTel.makeStringDataField(item, properties[item]));\r\n      }\r\n    }\r\n    for (let item in measurements) {\r\n      dataFields.push(OTel.makeStringDataField(item, measurements[item]));\r\n    }\r\n\r\n    let otelEvent = {\r\n      eventName: constants.TELEM_PREFIX + \".\" + eventName,\r\n      dataFields: dataFields,\r\n      eventFlags: {\r\n        dataCategories: 2,\r\n        diagnosticLevel: 10,\r\n      },\r\n    };\r\n\r\n    //remove diagnostic for now per D&F guidelines, only log to Aria\r\n    if(otelEvent['eventName'].toLowerCase().includes(\"diagnostic.\")){\r\n      return;\r\n    }\r\n    $window.otelLogger.sendTelemetryEvent(otelEvent);\r\n  };\r\n\r\n  this.trackTrace = function (message, properties) {\r\n    if (!enabledSetting) {\r\n        return;\r\n    }\r\n    let dataFields = [];\r\n\r\n    //remove data prefix from session id and browser session id\r\n    $window.otelLogger.partAFields = [\r\n      OTel.makeStringDataField(\"Session_Id\", properties['Session_Id']),\r\n      OTel.makeStringDataField(\"BrowserSessionId\", properties['BrowserSessionId']),\r\n    ];\r\n\r\n    for (let item in properties) {\r\n      if(item !== 'AppInfo.Name' && item !== 'Session_Id' && item !== 'BrowserSessionId'){\r\n        dataFields.push(OTel.makeStringDataField(item, properties[item]));\r\n      }\r\n    }\r\n    let otelEvent = {\r\n      eventName: constants.TELEM_PREFIX + \".\" + message,\r\n      dataFields: dataFields,\r\n      eventFlags: {\r\n        dataCategories: 2,\r\n        diagnosticLevel: 10,\r\n      },\r\n    };\r\n    //set event name based on message because can't log to console with custom event name higher upstream\r\n    //also remove diagnostic Info and Warn for now per D&F guidelines, only log to Aria\r\n    if(message.toLowerCase() === \"info\"){\r\n      otelEvent['eventName'] = constants.TELEM_PREFIX + \".Diagnostic.Info\";\r\n      return;\r\n    } else if(message.toLowerCase() === \"warn\"){\r\n      otelEvent['eventName'] = constants.TELEM_PREFIX + \".Diagnostic.Warn\";\r\n      return;\r\n    } else if(message.toLowerCase() === 'error'){\r\n      otelEvent['eventName'] = constants.TELEM_PREFIX + \".Diagnostic.Error\";\r\n    }\r\n\r\n    $window.otelLogger.sendTelemetryEvent(otelEvent);\r\n  };\r\n\r\n  var enabledSetting = true;\r\n\r\n  this.setEnabledSetting = function (enabled) {\r\n    enabledSetting = enabled;\r\n  };\r\n}","import angular from 'angular';\r\nimport 'angular-route';\r\nimport '../common/browserHandler';\r\nimport {bindDragAndDrop, bindFileChange, bindFileInputContainerClick, PopupController} from './popup.controller';\r\nimport '../common';\r\n\r\nexport default angular\r\n    .module('app.popup', ['ngRoute'])\r\n    .controller('PopupController', ['$timeout', '$scope', '$q', '$log', '$document', 'storage', 'userService', 'localize', 'notification', PopupController])\r\n    .directive('bindFileChange', bindFileChange)\r\n    .directive('bindDragAndDrop', ['$log', bindDragAndDrop])\r\n    .directive('bindFileInputContainerClick', ['$log', bindFileInputContainerClick])\r\n    .config(['$routeProvider', ($routeProvider) => {\r\n        $routeProvider\r\n            .when('/', {\r\n                templateUrl: './popup/popup.html',\r\n                controller: 'PopupController',\r\n                controllerAs: 'ctrl'\r\n            })\r\n            .otherwise({\r\n                redirectTo: '/'\r\n            });\r\n    }])\r\n    .name;\r\n","import fabric from 'office-ui-fabric-js/dist/js/fabric.min.js';\r\nimport BrowserHandler from '../common/browserHandler';\r\nimport constants from '../common/constants';\r\nimport Utilities from '../common/utilities';\r\n\r\n// Custom directive since Angular does not support on change event binding with input elements of type 'file'\r\nexport function bindFileChange() {\r\n    return {\r\n        require: 'ngModel',\r\n        restrict: 'A',\r\n        link: function (scope, element, attrs, ngModel) {\r\n            element.bind('change', function (event) {\r\n                ngModel.$setViewValue(event.target.files);\r\n            });\r\n        },\r\n    };\r\n}\r\n\r\nexport function bindDragAndDrop($log) {\r\n    return {\r\n        require: 'ngModel',\r\n        restrict: 'A',\r\n        link: function (scope, element, attrs, ngModel) {\r\n            element.bind('dragover', function (event) {\r\n                event.stopPropagation();\r\n                event.preventDefault();\r\n                event.originalEvent.dataTransfer.dropEffect = 'copy';\r\n            });\r\n\r\n            element.bind('drop', function (event) {\r\n                event.stopPropagation();\r\n                event.preventDefault();\r\n                $log.trackEvent('Action.Open.Document.DragAndDrop', {'Action_Area': 'Docs', 'Action_SubArea': 'Upload_Open', 'Action_Target': 'Upload', 'EventCategory': 'Action', 'Action_Type': 'Click', 'Action_Result': 'Open'});\r\n                ngModel.$setViewValue(event.originalEvent.dataTransfer.files);\r\n            });\r\n        },\r\n    };\r\n}\r\n\r\nexport function bindFileInputContainerClick($log) {\r\n    return {\r\n        restrict: 'A',\r\n        link: function (scope, element) {\r\n            element.bind('mousedown keydown keypress', function (event) {\r\n                // Bind with Mousedown and Enter keydown events\r\n                if (\r\n                    event.which === constants.JQUERY.EVENT_ID.MOUSEDOWN.LEFT_BUTTON_CLICK ||\r\n                    event.which === constants.JQUERY.EVENT_ID.KEYPRESS.ENTER\r\n                ) {\r\n                    $log.trackEvent('Action.Open.Document.Upload', {'Action_Area': 'Docs','Action_SubArea': 'Upload_Open', 'Action_Target': 'Upload', 'EventCategory': 'Action', 'Action_Type': 'Click', 'Action_Result': 'Open'});\r\n                    event.currentTarget.nextElementSibling.click();\r\n                    event.preventDefault();\r\n                }\r\n            });\r\n        },\r\n    };\r\n}\r\n\r\nexport function PopupController($timeout, $scope, $q, $log, $document, storage, userService, localize, notification) {\r\n    var self = this;\r\n\r\n    self.accountPanelOpened = false;\r\n    self.filesSelected = null;\r\n    self.webRedirectInputChecked = false;\r\n    self.telemetryInputChecked = false;\r\n    self.onLine = true;\r\n    self.username = '';\r\n    self.profilePicture = '';\r\n    self.rtl = Utilities.isRTL();\r\n    self.isChrome = Utilities.isChrome();\r\n    self.useAuthNext = false;\r\n\r\n    // var message = Utilities.getAppDescription(); // the manifest isn't localized so can't show this\r\n    self.appDescriptionMessage = localize.getLocalizedString(\"AppDescription\");\r\n\r\n    // Exposed Methods\r\n    self.onMenuItemClick = onMenuItemClick;\r\n    self.onSignOutClick = onSignOutClick;\r\n    self.onWelcomeSignInClick = onWelcomeSignInClick;\r\n    self.onProfileClick = onProfileClick;\r\n    self.onSignOutLinkClick = onSignOutLinkClick;\r\n    self.onSignupLinkClick = onSignupLinkClick;\r\n    self.onWebRedirectInputChange = onWebRedirectInputChange;\r\n    self.onTelemetryInputChange = onTelemetryInputChange;\r\n    self.onFileInputChange = onFileInputChange;\r\n    self.openDocument = openDocument;\r\n    self.openOfficeHome = openOfficeHome;\r\n    self.openSupportPage = openSupportPage;\r\n    self.openMyAccountPage = openMyAccountPage;\r\n    self.browseToRecents = browseToRecents;\r\n    self.openAppsModule = openAppsModule;\r\n    self.createDocument = createDocument;\r\n    self.handleTableNavigation = handleTableNavigation;\r\n    self.loadFile = loadFile;\r\n    self.constants = constants;\r\n    self.storage = storage;\r\n    self.userService = userService;\r\n    self.localize = localize;\r\n    self.hasSignedIn = constants.SIGNINSTATUS.UNKNOWN;\r\n\r\n    // Default to using OneDrive as storage\r\n    self.currentViewMode = constants.MENU_VIEWMODE.NONE;\r\n    $scope.userType = constants.USER_TYPE.NONE;\r\n\r\n    self.appLaunchers = [\r\n        [\r\n            {\r\n                id: 'Outlook',\r\n                label: 'OutlookAppName',\r\n                iconClass: 'ms-BrandIcon--icon48 ms-BrandIcon--outlook',\r\n                url: constants.LINKS.APP.OUTLOOK_DEFAULT,\r\n                isBusinessOnly: false,\r\n            },\r\n            {\r\n                id: 'OneDrive',\r\n                label: 'OneDriveAppName',\r\n                iconClass: 'ms-BrandIcon--icon48 ms-BrandIcon--onedrive',\r\n                url: constants.LINKS.APP.ONEDRIVE,\r\n                isBusinessOnly: false,\r\n            },\r\n        ],\r\n        [\r\n            {\r\n                id: 'WordOnline',\r\n                label: 'WordAppName',\r\n                iconClass: 'ms-BrandIcon--icon48 ms-BrandIcon--word',\r\n                url: constants.LINKS.APP.WORD,\r\n                isBusinessOnly: false,\r\n            },\r\n            {\r\n                id: 'ExcelOnline',\r\n                label: 'ExcelAppName',\r\n                iconClass: 'ms-BrandIcon--icon48 ms-BrandIcon--excel',\r\n                url: constants.LINKS.APP.EXCEL,\r\n                isBusinessOnly: false,\r\n            },\r\n        ],\r\n        [\r\n            {\r\n                id: 'PowerPointOnline',\r\n                label: 'PowerPointAppName',\r\n                iconClass: 'ms-BrandIcon--icon48 ms-BrandIcon--powerpoint',\r\n                url: constants.LINKS.APP.POWERPOINT,\r\n                isBusinessOnly: false,\r\n            },\r\n            {\r\n                id: 'OneNoteOnline',\r\n                label: 'OneNoteAppName',\r\n                iconClass: 'ms-BrandIcon--icon48 ms-BrandIcon--onenote',\r\n                url: constants.LINKS.APP.ONENOTE,\r\n                isBusinessOnly: false,\r\n            },\r\n        ],\r\n        [\r\n            {\r\n                id: 'SharePoint',\r\n                label: 'SharePointSiteAppName',\r\n                iconClass: 'ms-BrandIcon--icon48 ms-BrandIcon--sharepoint',\r\n                url: constants.LINKS.APP.SHAREPOINT_DEFAULT,\r\n                isBusinessOnly: true,\r\n            },\r\n            {\r\n                id: 'Teams',\r\n                label: 'TeamsAppName',\r\n                iconClass: 'ms-BrandIcon--icon48 ms-BrandIcon--teams',\r\n                url: constants.LINKS.APP.TEAMS,\r\n                isBusinessOnly: true,\r\n            },\r\n        ],\r\n    ];\r\n\r\n    // Send telemetry asynchronously after DOM content is loaded\r\n    $document.ready(function () {\r\n        //create sessionId for the popup session\r\n        const sessionId = Utilities.getNewId();\r\n        self.storage.set({'sessionId': sessionId});\r\n        \r\n        $timeout(function () {\r\n            $log.trackEvent('Action.OpenExtension', {'EventCategory': 'Action', 'Action_Type': 'Click', 'Action_Result': 'Open'});\r\n        });\r\n\r\n        var CheckBoxElements = document.querySelectorAll('.ms-CheckBox');\r\n        for (var j = 0; j < CheckBoxElements.length; j++) {\r\n            new fabric.CheckBox(CheckBoxElements[j]);\r\n        }\r\n    });\r\n\r\n    // Initialize scope variables for view\r\n    function initialize() {\r\n        storage.get(['userType', 'identity']).then(storageResult => {\r\n            var signInStatus = (storageResult && storageResult.identity && storageResult.userType !== constants.USER_TYPE.NONE);\r\n            self.hasSignedIn = signInStatus ? constants.SIGNINSTATUS.SIGNEDIN : constants.SIGNINSTATUS.NONE;\r\n\r\n            // note that we are only checking against SIGNINSTATUS.HASREFRESHTOKEN because getSignInInfo is not supposed to return SIGNINSTATUS.SIGNEDIN since it does not attempt to valid the signin state\r\n            if (self.hasSignedIn > constants.SIGNINSTATUS.NONE) {\r\n                refreshSignInStatus(); // refresh signIn status only if we have signInInfo\r\n            }\r\n\r\n            return self.storage.get('webRedirect_disabled');\r\n        }).then(storageResult => {\r\n            self.webRedirectInputChecked = !(Utilities.isNotUndefinedOrNull(storageResult.webRedirect_disabled) && storageResult.webRedirect_disabled);\r\n\r\n            return $log.getEnabledSetting();\r\n        }).then(enabled => {\r\n            $log.setEnabledSetting(enabled);\r\n            self.telemetryInputChecked = enabled;\r\n\r\n            return userService.useAuthNext();\r\n        }).then(useAuthNext => {\r\n            self.useAuthNext = useAuthNext;\r\n\r\n            return;\r\n        });\r\n    }\r\n\r\n    // Gets the user's profile picture from the user service\r\n    function getUserPhoto() {\r\n        userService.getUserPhoto().then(function (photo) {\r\n            if (photo) {\r\n                self.profilePicture = photo;\r\n            }\r\n        }, function (error) {\r\n            self.profilePicture = '';\r\n            $log.info(`PopupController.getUserPhoto: Profile Picture Error - ${error}`);\r\n        });\r\n    }\r\n\r\n    // Update which menu is displayed\r\n    function onMenuItemClick(viewMode) {\r\n        // If the user clicks on the menu button again, dismiss the menu\r\n        self.currentViewMode = self.currentViewMode === viewMode ? constants.MENU_VIEWMODE.NONE : (self.currentViewMode = viewMode);\r\n    }\r\n\r\n    function refreshSignInStatus() {\r\n        $log.debug('PopupController.refreshSignInStatus(): Method start');\r\n\r\n        self.userService.getUserType().then(async function (userType) {\r\n            $log.debug(`PopupController.getSignInStatus(): hasSignedIn: ${userType}`);\r\n            $log.trackEvent('Diagnostic.SignedIn', {'EventCategory': 'Diagnostic'});\r\n            $scope.userType = userType;\r\n            self.hasSignedIn = userType === constants.USER_TYPE.NONE ? constants.SIGNINSTATUS.NONE : constants.SIGNINSTATUS.SIGNEDIN;\r\n\r\n            if (self.hasSignedIn !== constants.SIGNINSTATUS.SIGNEDIN) {\r\n                return;\r\n            }\r\n\r\n            var userInfo = await self.userService.waitForUserInfo(userType);\r\n            if (Utilities.isUndefinedOrNull(userInfo)) {\r\n                $log.warn('self.UserService.getUserInfo(): userInfo is undefined or null when hasSignedIn is SIGNINSTATUS.SIGNEDIN');\r\n                return;\r\n            }\r\n\r\n            if (Utilities.isUndefinedOrNull(userInfo.email)) {\r\n                $log.warn('self.UserService.getUserInfo(): userInfo.email is undefined or null when hasSignedIn is SIGNINSTATUS.SIGNEDIN');\r\n                return;\r\n            }\r\n            self.username = userInfo.email;\r\n\r\n            // Get the user's profile picture\r\n            getUserPhoto();\r\n        });\r\n    }\r\n\r\n    //\r\n    // --- Start Account Menu Methods ---\r\n    //\r\n\r\n    // Account menu item Sign-in/Sign-out link - Go back to login page\r\n    // This should only be reachable when signed in though\r\n    function onSignOutClick() {\r\n        self.currentViewMode = constants.MENU_VIEWMODE.NONE;\r\n\r\n        if (self.hasSignedIn === constants.SIGNINSTATUS.SIGNEDIN) {\r\n            onSignOutLinkClick();\r\n        }\r\n    }\r\n\r\n    // Welcome page Sign-in link\r\n    async function onWelcomeSignInClick(userType) {\r\n        $log.trackEvent('Action.SignIn', {'EventCategory': 'Action', 'Action_Type': 'Click', 'Action_Area': 'Login', 'Action_Target': 'SignIn'});\r\n        window.close();\r\n        // eslint-disable-next-line no-async-promise-executor\r\n        return new Promise(async (resolve) => {\r\n\r\n            BrowserHandler.runtime.sendMessage({\r\n                activity: constants.ACTIVITY.AUTHENTICATION.NAME,\r\n                type: userType\r\n            }, result => {\r\n                resolve();\r\n                $log.debug(`onWelcomeSignInClick sendMessage returned ${result}`);\r\n            });\r\n        });\r\n    }\r\n\r\n    // Sign-out link\r\n    function onSignOutLinkClick() {\r\n        $log.trackEvent('Action.SignOut', {'EventCategory': 'Action', 'Action_Type': 'Click', 'Action_Area': 'Account', 'Action_Target': 'SignOut'});\r\n        // Clear recents from local storage\r\n        storage.remove('localRecentDocuments');\r\n        //clear user info from local storage\r\n        storage.remove('userInfo');\r\n        storage.remove('dataBoundary');\r\n        storage.remove('userAndTenantId');\r\n\r\n        BrowserHandler.runtime.sendMessage({\r\n            activity: constants.ACTIVITY.LOGOUT.NAME,\r\n            type: $scope.userType\r\n        });\r\n\r\n        self.hasSignedIn = constants.SIGNINSTATUS.NONE;\r\n        $scope.userType = constants.USER_TYPE.NONE;\r\n\r\n    }\r\n\r\n    // Sign Up link\r\n    function onSignupLinkClick() {\r\n        $log.trackEvent('Action.Click.Signup', {'EventCategory': 'Action', 'Action_Type': 'Click', 'Action_Result': 'Click'});\r\n        Utilities.navigateToUrlWithNewTab(constants.LINKS.SIGNUP, true);\r\n    }\r\n\r\n    function onTelemetryInputChange() {\r\n        self.telemetryInputChecked = !self.telemetryInputChecked;\r\n        $log.setEnabledSetting(self.telemetryInputChecked);\r\n        $log.trackEvent('Action.TelemetryInputChecked', {Enabled: self.telemetryInputChecked, 'Action_Area': 'Account', 'EventCategory': 'Action', 'Action_Type': 'Click', 'Action_Result': 'Click'});\r\n    }\r\n\r\n    function onWebRedirectInputChange() {\r\n        self.webRedirectInputChecked = !self.webRedirectInputChecked;\r\n        self.storage.set({webRedirect_disabled: !self.webRedirectInputChecked});\r\n        $log.trackEvent('Action.WebRedirectChecked', {Enabled: self.webRedirectInputChecked, 'Action_Area': 'Account', 'EventCategory': 'Action', 'Action_Type': 'Click', 'Action_Result': 'Click'});\r\n    }\r\n\r\n    function onProfileClick() {\r\n        self.accountPanelOpened = !self.accountPanelOpened;\r\n    }\r\n\r\n    // Open document\r\n    async function openDocument() {\r\n        var userInfo = await self.userService.getUserInfo($scope.userType);\r\n        if (Utilities.isUndefinedOrNull(userInfo)) {\r\n            $log.warn('PopupController.openDocument(): invalid userInfo');\r\n            return;\r\n        }\r\n\r\n        if (Utilities.isUndefinedOrNull(userInfo.oneDriveUrl)) {\r\n            $log.warn('PopupController.openDocument(): invalid OneDriveUrl');\r\n            return;\r\n        }\r\n\r\n        Utilities.navigateToUrlWithNewTab(userInfo.oneDriveUrl, true);\r\n    }\r\n\r\n    // Open SharePoint site\r\n    async function openSharePointSite() {\r\n        var userInfo = await self.userService.getUserInfo($scope.userType);\r\n        if (Utilities.isNotUndefinedOrNull(userInfo) && Utilities.isNotUndefinedOrNull(userInfo.sharePointUrl)) {\r\n            Utilities.navigateToUrlWithNewTab(userInfo.sharePointUrl, true);\r\n            return;\r\n        }\r\n\r\n        $log.warn('PopupController.openDocument(): invalid sharePointUrl');\r\n        Utilities.navigateToUrlWithNewTab(constants.LINKS.APP.SHAREPOINT_DEFAULT, true);\r\n    }\r\n\r\n    // Helper function to add auth query string param to url\r\n    function addAuthParam(url) {\r\n        let userType = $scope.userType;\r\n        if(Utilities.isNotUndefinedOrNull(url)) {\r\n            if(userType === constants.USER_TYPE.MSA) {\r\n                url = url.concat('&auth=1');\r\n            } else if (userType === constants.USER_TYPE.O365) {\r\n                url = url.concat('&auth=2');\r\n            }\r\n        }\r\n\r\n        return url;\r\n    }\r\n\r\n    // Open Office.com\r\n    function openOfficeHome() {\r\n        $log.trackEvent('Action.Refer.Microsoft365', {'Action_Area': 'Apps', 'Action_SubArea':'Home','Action_Target': 'M365 Home', 'EventCategory': 'Action', 'Action_Type': 'Click', 'Action_Result': 'Refer'});\r\n        var url = addAuthParam(constants.LINKS.OFFICE_HOME_URL);\r\n        Utilities.navigateToUrlWithNewTab(url, true);\r\n    }\r\n\r\n    // Open support page\r\n    function openSupportPage() {\r\n        var supportUrl = constants.LINKS.SUPPORT_URL;\r\n        $log.trackEvent('Action.Refer.Support', {'EventCategory': 'Action', 'Action_Target': 'Support', 'Action_Area': 'Login', 'Action_Type': 'Click', 'Action_Result': 'Refer'});\r\n        Utilities.navigateToUrlWithNewTab(supportUrl, true);\r\n    }\r\n    \r\n    // Open myaccount page\r\n    function openMyAccountPage() {\r\n        var url = signedInWithOrgId() ? constants.LINKS.MYACCOUNT_O365_URL : constants.LINKS.MYACCOUNT_MSA_URL;\r\n        $log.trackEvent('Action.Refer.MyAccount', {'EventCategory': 'Action', 'Action_Target': 'MyAccount', 'Action_Area': 'Account', 'Action_Type': 'Click', 'Action_Result': 'Refer'});\r\n        Utilities.navigateToUrlWithNewTab(url, true);\r\n    }\r\n\r\n    // Open Recent Document view in browser tab\r\n    async function browseToRecents() {\r\n        $log.trackEvent('Action.Refer.MyContent', {'Action_Area': 'Docs', 'Action_SubArea': 'My Content', \"Action_Target\": 'My Content', 'EventCategory': 'Action', 'Action_Type': 'Click', 'Action_Result': 'Refer'});\r\n\r\n        var url = addAuthParam(constants.LINKS.MY_CONTENT_URL);\r\n        //add param for msa/aad accounts so it opens the right account in case logged in on different accounts in extension and browser\r\n        \r\n        Utilities.navigateToUrlWithNewTab(url.toString(), true);\r\n    }\r\n\r\n    // Open Apps module in browser tab\r\n    async function openAppsModule() {\r\n        $log.trackEvent('Action.Refer.AppsModule', {'Action_Area': 'Apps', 'Action_SubArea': 'AppsModule', 'Action_Target': 'Apps Module', 'EventCategory': 'Action', 'Action_Type': 'Click', 'Action_Result': 'Refer'});\r\n        var url = addAuthParam(constants.LINKS.APPS_MODULE_URL);\r\n        Utilities.navigateToUrlWithNewTab(url, true);\r\n    }\r\n\r\n    // Create document\r\n    function createDocument(app, clickEvent) {\r\n        //change Outlook to Mail for telem alignment\r\n        if (app.id === 'Outlook') {\r\n            $log.trackEvent('Action.Refer.Mail', {'Action_Area': 'Apps', 'Action_SubArea': 'App', 'Action_Target': 'Mail', 'EventCategory': 'Action', 'Action_Type': 'Click', 'Action_Result': 'Refer'});\r\n        } else{\r\n            $log.trackEvent('Action.Refer.'+app.id, {'Action_Area': 'Apps', 'Action_SubArea': 'App', 'Action_Target': app.id, 'EventCategory': 'Action', 'Action_Type': 'Click', 'Action_Result': 'Refer'});\r\n        }\r\n\r\n        var url;\r\n        if (app.id === 'OneDrive') {\r\n            openDocument();\r\n            return;\r\n        } else if (app.id === 'Outlook') {\r\n            url = signedInWithOrgId() ? constants.LINKS.APP.OUTLOOK_O365 : constants.LINKS.APP.OUTLOOK_DEFAULT;\r\n        } else if (app.id === 'SharePoint') {\r\n            openSharePointSite();\r\n            return;\r\n        } else if (typeof app.url === 'function') {\r\n            // Auth code for WAC: 0-default(hrd), 1-MSA, 2-OrgId\r\n            const authType = (self.hasSignedIn !== constants.SIGNINSTATUS.SIGNEDIN) ? '0' : (signedInWithOrgId() ? '2' : '1');\r\n            url = app.url(authType);\r\n        } else {\r\n            url = app.url;\r\n        }\r\n\r\n        Utilities.navigateToUrlWithNewTab(\r\n            url,\r\n            Utilities.isUndefinedOrNull(clickEvent) || Utilities.isUndefinedOrNull(clickEvent.ctrlKey) ? true : !clickEvent.ctrlKey\r\n        );\r\n    }\r\n\r\n    // File picker\r\n    function onFileInputChange() {\r\n        self.loadFile();\r\n    }\r\n\r\n    // Load the input file from html5, upload and view.\r\n    function loadFile() {\r\n        $log.trackEvent('Action.Select.File', {FilesSelectedCount: self.filesSelected.length, 'Action_Area': 'Docs', 'Action_SubArea': 'Upload_Open', 'Action_Target': \"Upload\", 'EventCategory': 'Action', 'Action_Type': 'Click', 'Action_Result': 'Select'});\r\n\r\n        // User can multi-select multiple files and drag/drop\r\n        if (self.filesSelected.length > 1) {\r\n            $log.warn(`loadFile called with ${self.filesSelected.length} files selected`);\r\n        }\r\n\r\n        // Check whether user has chosen an unsupported file type\r\n        if (!constants.FILE.SUPPORTED_FILE_TYPES[Utilities.getFileExtension(self.filesSelected[0].name)]) {\r\n            $log.info(\r\n                `PopupController.loadFile(): User attempted to open an unsupported file type of ${Utilities.getFileExtension(\r\n                    self.filesSelected[0].name\r\n                )} extension`\r\n            );\r\n            notification.show(constants.NOTIFICATION.UNSUPPORTEDFILETYPE);\r\n            return;\r\n        }\r\n\r\n        sendFileUploadMessageToBackground(self.filesSelected[0]);\r\n    }\r\n\r\n    // Check if the user is currently signed in with orgId.\r\n    function signedInWithOrgId() {\r\n        return $scope.userType === constants.USER_TYPE.O365;\r\n    }\r\n\r\n    // Sends post message to background for processing\r\n    function sendFileUploadMessageToBackground(file) {\r\n        BrowserHandler.extension.getBackgroundPage().postMessage(file, window.location);\r\n    }\r\n\r\n    function handleTableNavigation(event) {\r\n        var key = event.which || event.keyCode || 0;\r\n        var supportedKey = [\r\n            constants.JQUERY.EVENT_ID.KEYPRESS.ARROWLEFT,\r\n            constants.JQUERY.EVENT_ID.KEYPRESS.ARROWUP,\r\n            constants.JQUERY.EVENT_ID.KEYPRESS.ARROWRIGHT,\r\n            constants.JQUERY.EVENT_ID.KEYPRESS.ARROWDOWN\r\n        ];\r\n        if (!supportedKey.includes(key)) {\r\n            return;\r\n        }\r\n        var currentCell = (event.target).closest('.app_table_cell');\r\n        var currentRow = currentCell.closest('.app_table_row');\r\n        if (!currentCell || !currentRow) {\r\n            return;\r\n        }\r\n        var prevCell = currentCell.previousElementSibling;\r\n        var targetCell;\r\n        switch (key) {\r\n            case constants.JQUERY.EVENT_ID.KEYPRESS.ARROWLEFT:\r\n                {\r\n                    targetCell = currentCell.previousElementSibling;\r\n                    break;\r\n                }\r\n            case constants.JQUERY.EVENT_ID.KEYPRESS.ARROWUP:\r\n                {\r\n                    var prevRow = currentRow.previousElementSibling;\r\n                    if (prevRow) {\r\n                        targetCell = prevRow.querySelector('.app_table_cell');\r\n                    }\r\n                    if (prevCell && targetCell) {\r\n                        targetCell = targetCell.nextElementSibling;\r\n                    }\r\n                    break;\r\n                }\r\n            case constants.JQUERY.EVENT_ID.KEYPRESS.ARROWRIGHT:\r\n                {\r\n                    targetCell = currentCell.nextElementSibling;\r\n                    break;\r\n                }\r\n            case constants.JQUERY.EVENT_ID.KEYPRESS.ARROWDOWN:\r\n                {\r\n                    var nextRow = currentRow.nextElementSibling;\r\n                    if (nextRow) {\r\n                        targetCell = nextRow.querySelector('.app_table_cell');\r\n                    }\r\n                    if (prevCell && targetCell) {\r\n                        targetCell = targetCell.nextElementSibling;\r\n                    }\r\n                    break;\r\n                }\r\n        }\r\n        if (targetCell) {\r\n            event.preventDefault();\r\n            targetCell.querySelector('button').focus();\r\n        }\r\n    }\r\n\r\n    // Initialize\r\n    initialize();\r\n}\r\n","import angular from 'angular';\r\nimport constants from './experimentConstants';\r\nimport experimentService from './experiment.service';\r\nimport sharingController from './sharing/sharing.controller';\r\nimport sharingService from './sharing/sharing.service';\r\nimport SharingAController from './sharing/sharingA/sharingA.controller';\r\n\r\nexport default angular\r\n    .module('app.experimentation', [])\r\n    .constant('experimentConstants', constants)\r\n    .factory('experimentService', ['$http', '$q', '$log', /* 'constants', */ 'experimentConstants', 'userService', experimentService])\r\n    .controller('SharingController', ['experimentService', sharingController])\r\n    .factory('sharingService', ['$http', '$q', '$log', /* 'constants', */ 'userService', sharingService])\r\n    .controller('SharingAController', ['$log', 'sharingService', 'userService', 'localize', SharingAController])\r\n    .name;\r\n","\r\nexport default {\r\n    DEFAULT_CLIENT_ID: '',\r\n    ENABLED: {\r\n        MSA: true,\r\n        O365: false,\r\n        BROWSERS: ['Chrome', 'Edge']\r\n    },\r\n    // eslint-disable-next-line @microsoft/sdl/no-insecure-url\r\n    ENDPOINT: 'http://officeonlineextension-office365.msedge.net/ab',\r\n    ERROR: {\r\n        BAD_USER_TYPE: 'badUserType',\r\n        NO_CLIENT_ID: 'noClientId',\r\n        NO_FEATURES: 'noFeatures'\r\n    },\r\n    EXPERIMENTS: {\r\n        SHARING: {\r\n            ENABLED: {\r\n                MSA: true,\r\n                O365: false,\r\n                BROWSERS: ['Chrome']\r\n            },\r\n            CONTROL: 'sharingControl/sharingControl.html',\r\n            FLIGHTS: {\r\n                'flighttestaacf': 'sharingControl/sharingControl.html',\r\n                'flighttestaa': 'sharingControl/sharingControl.html',\r\n                'SharingUXCF': 'sharingControl/sharingControl.html',\r\n                'SharingUX': 'sharingA/sharingA.html'\r\n            }\r\n        }\r\n    }\r\n};\r\n","/* global Utilities */\r\nimport '../common/utilities';\r\nimport './experimentConstants';\r\nimport constants from '../common/constants';\r\n\r\nexport default function experimentService($http, $q, $log, experimentConstants, userService) {\r\n    // Private variables\r\n    var flights = null;\r\n    var flightsPromise = null;\r\n\r\n    var userTypeMap = {[constants.USER_TYPE.MSA]: 'MSA', [constants.USER_TYPE.O365]: 'O365'};\r\n\r\n    var currentUserType;\r\n\r\n    // Exposed methods\r\n    var service = {\r\n        getFlight: getFlight,\r\n\r\n        // Exposed to call from UTs\r\n        getFlights: getFlights,\r\n        flightingDisabled: flightingDisabled,\r\n        experimentEnabled: experimentEnabled,\r\n    };\r\n\r\n    return service;\r\n\r\n    // Function declarations\r\n\r\n    // Returns the flight assignment for the experiment with the given name\r\n    async function getFlight(expName) {\r\n        var enabled = await experimentEnabled(expName);\r\n        if (!enabled) {\r\n            return experimentConstants.EXPERIMENTS[expName].CONTROL;\r\n        }\r\n\r\n        var flights = await getFlights();\r\n        return flights[expName];\r\n    }\r\n\r\n    // Returns all flight assignments\r\n    async function getFlights() {\r\n        if (Utilities.isNotUndefinedOrNull(flights)) {\r\n            return flights;\r\n        }\r\n\r\n        if (Utilities.isNotUndefinedOrNull(flightsPromise)) {\r\n            await Promise.all([flightsPromise]);\r\n            return flights;\r\n        }\r\n\r\n        await setFlights();\r\n        return flights;\r\n    }\r\n\r\n    // Resolves with true iff the experiment with the given name is enabled\r\n    async function experimentEnabled(expName) {\r\n        try {\r\n            var userType = await userService.getUserType();\r\n            // if all flighting is disabled, the experiment is disabled (global experiment enabled settings override individual experiment enabled settings)\r\n            if (service.flightingDisabled(userType)) {\r\n                return false;\r\n            }\r\n\r\n            return !disabledCheck(userType, expName);\r\n\r\n        } catch (error) {\r\n            $log.error(`experimentService.experimentEnabled error: ${error}`);\r\n            return false;\r\n        }\r\n    }\r\n\r\n    // Returns true iff flighting is disabled for the given user type or the current browser\r\n    function flightingDisabled(userType) {\r\n        return disabledCheck(userType);\r\n    }\r\n\r\n    // Sets the private flights variable by getting the user-assigned features from local storage or ExP\r\n    async function setFlights() {\r\n        try {\r\n            var userType = await userService.getUserType();\r\n            currentUserType = userTypeMap[userType];\r\n\r\n            // undefined, null, or wrong userType => default flights\r\n            if (Utilities.isUndefinedOrNull(userType) || userType === constants.USER_TYPE.NONE) {\r\n                throw (experimentConstants.ERROR.BAD_USER_TYPE);\r\n            }\r\n\r\n            // flighting is disabled for the current user => default flights\r\n            if (service.flightingDisabled(userType)) {\r\n                flights = defaultFlights();\r\n                return;\r\n            }\r\n\r\n            var userInfo = await userService.waitForUserInfo(userType);\r\n            // if there are flights in the local userInfo, use those\r\n            if (Utilities.isNotUndefinedOrNull(userInfo) && Utilities.isNotUndefinedOrNull(userInfo.flights)) {\r\n                flights = userInfo.flights;\r\n                return;\r\n            }\r\n\r\n            // get the flight information from the ExP service and save in userInfo\r\n            var clientId = getClientId(userType, userInfo);\r\n            var features = await getFeatures(clientId);\r\n            featuresToFlights(features);\r\n            userInfo.flights = flights;\r\n            userInfo.features = features;\r\n            await userService.saveUserInfo(userType, userInfo);\r\n        } catch (error) {\r\n            // if any error occurs while getting the flight assignments, set the flights to default (all controls) and resolve\r\n            $log.error(`experimentService.setFlights error: ${error}`);\r\n            flights = defaultFlights();\r\n        }\r\n\r\n    }\r\n\r\n    // Returns the clientId from the given userInfo:\r\n    // cid (msa users) or the default specified in experimentConstants\r\n    function getClientId(userType, userInfo) {\r\n        if (Utilities.isUndefinedOrNull(userInfo)) {\r\n            return experimentConstants.DEFAULT_CLIENT_ID;\r\n        }\r\n\r\n        // TODO: does this still do anything. if so is the id the same as the cid?\r\n        var cid = userInfo.cid || userInfo.id;\r\n        if (cid) {\r\n            return cid;\r\n        }\r\n\r\n        return experimentConstants.DEFAULT_CLIENT_ID;\r\n    }\r\n\r\n    // Gets the user features array from the ExP flighting service, passing in the given clientId\r\n    function getFeatures(clientId) {\r\n        var deferral = $q.defer();\r\n        // bad clientId => no ExP features (reject)\r\n        // var promise = new Promise((resolve, reject) => {\r\n        if (Utilities.isUndefinedOrNull(clientId) || clientId === experimentConstants.DEFAULT_CLIENT_ID) {\r\n            $log.error('experimentService.getFeatures: clientId is undefined, null, or empty');\r\n            return deferral.reject(experimentConstants.ERROR.NO_CLIENT_ID);\r\n        }\r\n\r\n        var id = getTruncatedString(stringToHex(clientId));\r\n        var request = {\r\n            method: 'GET',\r\n            url: experimentConstants.ENDPOINT,\r\n            headers: {\r\n                'X-MSEDGE-CLIENTID': id\r\n            }\r\n        };\r\n\r\n        $http(request).then(\r\n            (response) => {\r\n                var result = response.data;\r\n                if (result.Features) {\r\n                    return deferral.resolve(result.Features);\r\n                } else {\r\n                    return deferral.reject(experimentConstants.ERROR.NO_FEATURES);\r\n                }\r\n            },\r\n            () => {\r\n                return deferral.reject(experimentConstants.ERROR.NO_FEATURES);\r\n            });\r\n        return deferral.promise;\r\n    }\r\n\r\n    // Sets the private flights variable to map each experiment name to the markup for the flight that the user has been assigned to for that experiment\r\n    function featuresToFlights(features) {\r\n        flights = {};\r\n        for (var expKey in experimentConstants.EXPERIMENTS) {\r\n            if (experimentConstants.EXPERIMENTS.hasOwnProperty(expKey)) {\r\n                setExperimentFlights(features, expKey);\r\n            }\r\n        }\r\n\r\n        // check for any invalid features from the ExP service\r\n        validateFeatures(features);\r\n    }\r\n\r\n    // Helper function: assigns the given experiment key to the appropriate flight for the experiment\r\n    function setExperimentFlights(features, expKey) {\r\n        var experiment = experimentConstants.EXPERIMENTS[expKey];\r\n        flights[expKey] = experiment.CONTROL;\r\n\r\n        if (!experiment.ENABLED[currentUserType]) {\r\n            return;\r\n        }\r\n\r\n        for (var flightKey in experiment.FLIGHTS) {\r\n            if (experiment.FLIGHTS.hasOwnProperty(flightKey)) {\r\n                if (features.indexOf(flightKey) > -1) {\r\n                    flights[expKey] = experiment.FLIGHTS[flightKey];\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    // Sets the private flights variable to map each experiment name to its control\r\n    // Used in case of any error in getting the actual flight assignments.\r\n    function defaultFlights() {\r\n        var flights = {};\r\n        for (var expKey in experimentConstants.EXPERIMENTS) {\r\n            if (experimentConstants.EXPERIMENTS.hasOwnProperty(expKey)) {\r\n                var experiment = experimentConstants.EXPERIMENTS[expKey];\r\n                flights[expKey] = experiment.CONTROL;\r\n            }\r\n        }\r\n        return flights;\r\n    }\r\n\r\n    // Checks whether any feature in the given features array (obtained from ExP) is invalid, i.e. not part of any experiment feature->flight mapping\r\n    // and logs an error if any invalid features are found\r\n    function validateFeatures(features) {\r\n        var invalid = [];\r\n        for (var i = 0; i < features.length; ++i) {\r\n            var feature = features[i];\r\n            if (isFeatureInvalid(feature)) {\r\n                invalid.push(feature);\r\n            }\r\n        }\r\n\r\n        if (invalid.length > 0) {\r\n            $log.warn(`ExP service returned invalid features: ${JSON.stringify(invalid)}`);\r\n        }\r\n    }\r\n\r\n    // Helper function that returns true iff the given feature is invalid, i.e. is not a key in any experiment FLIGHTS mapping\r\n    function isFeatureInvalid(feature) {\r\n        for (var expKey in experimentConstants.EXPERIMENTS) {\r\n            if (experimentConstants.EXPERIMENTS.hasOwnProperty(expKey)) {\r\n                var experiment = experimentConstants.EXPERIMENTS[expKey];\r\n                if (experiment.FLIGHTS.hasOwnProperty(feature)) {\r\n                    return false;\r\n                }\r\n            }\r\n        }\r\n\r\n        return true;\r\n    }\r\n\r\n    // Helper function that returns true iff\r\n    //  all flighting is disabled (if given an undefined or invalid expName)\r\n    //  the experiment with the given name is disabled (if given a valid expName)\r\n    function disabledCheck(userType, expName) {\r\n        // no user type => flighting is disabled\r\n        if (userType === constants.USER_TYPE.NONE) {\r\n            return true;\r\n        }\r\n\r\n        // determine whether to check the enabled settings for all experiments or for a specific experiment\r\n        var enabledSettings = experimentConstants.EXPERIMENTS.hasOwnProperty(expName) ? experimentConstants.EXPERIMENTS[expName].ENABLED : experimentConstants.ENABLED;\r\n        var logName = expName ? `experiment ${expName} is` : 'all experiments are';\r\n\r\n        // check whether flighting is disabled for the current browser - if so, flighting is disabled no matter the userType\r\n        var browser = Utilities.getBrowserName().toLowerCase();\r\n        var enabledBrowsers = enabledSettings.BROWSERS.toString().toLowerCase();\r\n        if (enabledBrowsers.indexOf(browser) < 0) {\r\n            $log.info(`experimentService: ${logName} disabled for browser ${browser}. Experiment is only enabled for browsers ${enabledBrowsers}`);\r\n            return true;\r\n        }\r\n\r\n        // valid user type and enabled browser => use the setting for the userType\r\n        var enabledForUser = enabledSettings[userTypeMap[userType]];\r\n        if (!enabledForUser) {\r\n            $log.info(`experimentService: ${logName} disabled for userType ${userType}`);\r\n        }\r\n        return !enabledForUser;\r\n    }\r\n\r\n    // Helper function that returns a hex representation of the given string (ExP expects the clientId to be in hex format)\r\n    // Source: http://stackoverflow.com/questions/21647928/javascript-unicode-string-to-hex\r\n    function stringToHex(string) {\r\n        var hex, i;\r\n        var result = '';\r\n\r\n        for (i = 0; i < string.length; i++) {\r\n            hex = string.charCodeAt(i).toString(16);\r\n            result += ('000' + hex).slice(-4);\r\n        }\r\n\r\n        return result;\r\n    }\r\n\r\n    // Helper function used to ensure that the clientId sent to ExP is <= 100 characters (ExP clientId length limit)\r\n    function getTruncatedString(string) {\r\n        return string.length > 100 ? string.substring(0, 100) : string;\r\n    }\r\n}\r\n","export default function SharingController(experimentService) {\r\n    var self = this;\r\n\r\n    // Private properties\r\n    var path = '/experimentation/sharing/';\r\n    var name = 'SHARING';\r\n\r\n    // Exposed properties\r\n    self.flightView = path + 'sharingControl/sharingControl.html';\r\n\r\n    initialize();\r\n\r\n    function initialize() {\r\n        experimentService.getFlight(name).then(function (flight) {\r\n            self.flightView = path + flight;\r\n        });\r\n    }\r\n\r\n}\r\n","import Utilities from '../../common/utilities';\r\nimport '../experimentConstants';\r\nimport constants from '../../common/constants';\r\n\r\n'use strict';\r\n\r\nexport default function sharingService($http, $q, $log, userService) {\r\n    var service = {\r\n        setShareUrl: setShareUrl,\r\n        setFlagFromPermissions: setFlagFromPermissions\r\n    };\r\n\r\n    return service;\r\n\r\n    // Sets the shareUrl of the given document (currently only supported for MSA users)\r\n    function setShareUrl(doc, userType) {\r\n        if (Utilities.isUndefinedOrNull(doc) || Utilities.isUndefinedOrNull(doc.url)) {\r\n            return;\r\n        }\r\n\r\n        doc.shareUrl = '';\r\n\r\n        if (userType === constants.USER_TYPE.MSA) {\r\n            var docUrl = doc.url;\r\n            var shareUrl = docUrl.replace('&page=view', '&page=self');\r\n            if (shareUrl.indexOf('&page=self') < 0) {\r\n                shareUrl += '&page=self';\r\n            }\r\n            shareUrl += '&action=share';\r\n\r\n            doc.shareUrl = shareUrl;\r\n        }\r\n    }\r\n\r\n    // Sets the canBeShared flag on the given document based on whether the user has permission to share it (for MSA users)\r\n    function setFlagFromPermissions(doc, userType) {\r\n\r\n        // no document => do nothing\r\n        if (Utilities.isUndefinedOrNull(doc)) {\r\n            return $q.resolve();\r\n        }\r\n\r\n        // msa user => based on document permissions\r\n        if (userType === constants.USER_TYPE.MSA) {\r\n            var deferred = $q.defer();\r\n            // in case of error in getting document permissions, assume the document can't be shared\r\n            getMSAPermissions(doc).then(\r\n                function (canShare) {\r\n                    doc.canBeShared = canShare;\r\n                    deferred.resolve();\r\n                },\r\n                function (error) {\r\n                    $log.error(`sharingService.setFlagFromPermissions error: ${error}`);\r\n                    doc.canBeShared = false;\r\n                    deferred.resolve();\r\n                });\r\n\r\n            return deferred.promise;\r\n\r\n        } else {\r\n            // non-msa users can't share documents\r\n            doc.canBeShared = false;\r\n            return $q.resolve();\r\n        }\r\n    }\r\n\r\n    // Resolves with true iff the MSA user has permission to share the given document\r\n    function getMSAPermissions(doc) {\r\n        var deferred = $q.defer();\r\n\r\n        // get the cid (needed to find the userId)\r\n        getCID().then(function (cid) {\r\n            if (Utilities.isUndefinedOrNull(cid)) {\r\n                deferred.reject('null cid');\r\n                return;\r\n            }\r\n\r\n            // get the document id that OneDrive uses\r\n            if (Utilities.isUndefinedOrNull(doc.id)) {\r\n                deferred.reject('no document id');\r\n                return;\r\n            }\r\n            var docSplit = doc.id.split('.');\r\n            var docId = docSplit[docSplit.length - 1];\r\n\r\n            // request to OneDrive api to get the permissions on the document\r\n            var request = {\r\n                method: 'GET',\r\n                url: constants.MSACONFIG.ONEDRIVE_ITEMS_URL + docId + '/permissions',\r\n                headers: {\r\n                    'X-UserType': constants.USER_TYPE.MSA\r\n                }\r\n            };\r\n\r\n            // make http request to get document permissions\r\n            $http(request).then(\r\n                function (response) {\r\n                    var canShare = hasWriteAccess(response.data, cid);\r\n                    deferred.resolve(canShare);\r\n                },\r\n                function (response) {\r\n                    deferred.reject(response.statusText);\r\n                });\r\n        });\r\n\r\n        return deferred.promise;\r\n    }\r\n\r\n    // Resolves with the user's cid or null if none exists\r\n    function getCID() {\r\n        var deferred = $q.defer();\r\n\r\n        userService.waitForUserInfo(constants.USER_TYPE.MSA).then(function (userInfo) {\r\n            if (Utilities.isUndefinedOrNull(userInfo)) {\r\n                deferred.resolve(null);\r\n                return;\r\n            }\r\n            deferred.resolve(userInfo.cid);\r\n        });\r\n\r\n        return deferred.promise;\r\n    }\r\n\r\n    // Returns true iff the user with the given userId has write access in the given permissions object\r\n    function hasWriteAccess(permissions, userId) {\r\n        if (Utilities.isUndefinedOrNull(permissions) || Utilities.isUndefinedOrNull(permissions.value)) {\r\n            return true;\r\n        }\r\n\r\n        var canShare = true;\r\n\r\n        // get the shortened id from the userId - this is the id that the OneDrive api uses for certain accounts\r\n        var shortId = userId.substring(1, userId.length);\r\n\r\n        for (var i = 0; i < permissions.value.length; ++i) {\r\n            var permissionObject = permissions.value[i];\r\n            if (Utilities.isUndefinedOrNull(permissionObject.grantedTo)) {\r\n                continue;\r\n            }\r\n            var grantedToUser = permissionObject.grantedTo.user;\r\n            if (grantedToUser.id === userId || grantedToUser.id === shortId) {\r\n                var roles = permissionObject.roles;\r\n                canShare = roles.toString().toLowerCase().indexOf('write') > -1;\r\n            }\r\n        }\r\n\r\n        return canShare;\r\n    }\r\n}\r\n","import Utilities from '../../../common/utilities';\r\nimport '../../experimentConstants';\r\n\r\n'use strict';\r\n\r\nexport default function SharingAController($log, sharingService, userService, localize) {\r\n    var self = this;\r\n\r\n    // Exposed properties\r\n    self.shareDoc = null;\r\n    self.isChrome = Utilities.isChrome();\r\n    self.localize = localize;\r\n\r\n    // Exposed methods\r\n    self.init = init;\r\n    self.shareDocument = shareDocument;\r\n\r\n    // Function declarations\r\n\r\n    function init(doc) {\r\n        self.shareDoc = doc;\r\n        userService.getUserType().then(function (userType) {\r\n            sharingService.setShareUrl(self.shareDoc, userType);\r\n            sharingService.setFlagFromPermissions(self.shareDoc, userType);\r\n        });\r\n    }\r\n\r\n    function shareDocument(clickEvent) {\r\n        $log.trackEvent('ShareRecentDocument', {'Application': self.shareDoc.application});\r\n        var openActive = Utilities.isUndefinedOrNull(clickEvent) || Utilities.isUndefinedOrNull(clickEvent.ctrlKey) ? true : !clickEvent.ctrlKey;\r\n        Utilities.navigateToUrlWithNewTab(self.shareDoc.shareUrl, openActive);\r\n        window.close();\r\n    }\r\n}\r\n","import angular from 'angular';\r\nimport 'angular-aria';\r\nimport 'angular-animate';\r\nimport './common';\r\nimport './user';\r\nimport './mru';\r\nimport './diagnostics';\r\nimport './popup';\r\nimport './experimentation';\r\nimport 'office-ui-fabric-core/dist/css/fabric.min.css';\r\nimport 'office-ui-fabric-js/dist/css/fabric.components.min.css';\r\nimport './css/styles.css';\r\n\r\nexport default angular\r\n    .module('app', ['localization', 'ngAria', 'app.common', 'app.diagnostics', 'app.experimentation', 'app.user', 'app.mru', 'app.popup'])\r\n    .config(['$ariaProvider', '$compileProvider', '$httpProvider', '$provide', function ($ariaProvider, $compileProvider, $routeProvider, $httpProvider, $provide) {\r\n\r\n        'use strict';\r\n\r\n        // Configure Angular accessibility; opt out of tabindex handling\r\n        $ariaProvider.config({\r\n            tabindex: false\r\n        });\r\n\r\n        // Override the default regular expression that is used for whitelisting of safe urls during img[src] sanitization\r\n        // eslint-disable-next-line @microsoft/sdl/no-angularjs-sanitization-whitelist\r\n        $compileProvider.imgSrcSanitizationWhitelist(/^\\s*(https?|data|chrome-extension|ms-browser-extension):/);\r\n    }])\r\n    .name;\r\n","declare let browser: any;\r\ndeclare let chrome: any;\r\n\r\nvar browserListeners: any[] = [];\r\nvar propertyList = {};\r\n\r\nfunction mergeProperties(target: any, source: any): any {\r\n    for (const [key, value] of Object.entries(source)) {\r\n        if (!target[key]) {\r\n            target[key] = value;\r\n            continue;\r\n        }\r\n\r\n        if (typeof value !== typeof target[key]) {\r\n            console.log(`skipping ${key} due to conflicting types`);\r\n            continue;\r\n        }\r\n\r\n        if (Array.isArray(value)) {\r\n            target[key] = target[key].concat(value);\r\n            continue;\r\n        }\r\n\r\n        if (typeof value === 'object') {\r\n            target[key] = mergeProperties(target[key], value);\r\n            continue;\r\n        }\r\n        target[key] = value;\r\n    }\r\n\r\n    return target;\r\n}\r\n\r\nexport default (function (): any {\r\n    var browserHandler = ((): any => {\r\n        if (typeof browser === 'object') {\r\n            var edgeBrowser = Object.create(browser);\r\n\r\n            edgeBrowser.notifications = {\r\n                clear: function (notificationId: string, callback: (wasCleared: boolean) => void): void {\r\n                    // Invoke callback with wasCleared == false\r\n                    callback(false);\r\n                },\r\n                create: function (\r\n                    notificationId: string,\r\n                    options: chrome.notifications.NotificationOptions,\r\n                    callback: (notificationId: string) => void\r\n                ): void {\r\n                    // Use window alert dialog to display notification message\r\n                    if (typeof options !== 'undefined' && options !== null) {\r\n                        // Only show when priority is 1 or 2\r\n                        if (typeof options.priority !== 'undefined' && options.priority !== null && options.priority > 0) {\r\n                            window.alert(options.message);\r\n                        }\r\n                    }\r\n\r\n                    // Invoke callback with notification id\r\n                    callback(notificationId);\r\n                },\r\n                onButtonClicked: {\r\n                    addListener: function (notificationId: string): void {\r\n                        // Not implemented\r\n                    },\r\n                },\r\n                onClicked: {\r\n                    addListener: function (notificationId: string): void {\r\n                        // Not implemented\r\n                    },\r\n                },\r\n            };\r\n\r\n            edgeBrowser.runtime = {\r\n                getPlatformInfo: function (callback: (platformInfo: chrome.runtime.PlatformInfo) => void): void {\r\n                    // Does not execute the callback function\r\n                    // Not implemented\r\n                },\r\n            };\r\n        } else if (typeof chrome === 'object') {\r\n            return Object.create(chrome);\r\n        }\r\n    })();\r\n\r\n    // when running in tests, provide override the necessary functions\r\n    if ((window as any).jasmine) {\r\n        const browserMock = {\r\n            mock: true,\r\n            browserAction: {\r\n                setIcon: function (icon: string): void {},\r\n            },\r\n            extension: {\r\n                getURL: function (name: any): string {\r\n                    return '';\r\n                },\r\n            },\r\n            i18n: {\r\n                getUILanguage: function (name: any, callback: any): string {\r\n                    return '';\r\n                },\r\n                getMessage: function (): string {\r\n                    return '';\r\n                },\r\n            },\r\n            runtime: {\r\n                onMessage: {\r\n                    addListener: function (listener: any): any {\r\n                        browserListeners.push(listener);\r\n                    },\r\n                    removeListener: function (listener: any): void {\r\n                        browserListeners.splice(browserListeners.indexOf(listener), 1);\r\n                    },\r\n                },\r\n                sendMessage: function (message: any): any {\r\n                    for (let i = 0; i < browserListeners.length; ++i) {\r\n                        browserListeners[i](message);\r\n                    }\r\n                },\r\n                id: 'ndjpnladcallmjemlbaebfadecfhkepb',\r\n            },\r\n            storage: {\r\n                local: {\r\n                    get: function (name: string, callback: (arg0: { [x: number]: any }) => void): any {\r\n                        callback({\r\n                            [name]: (propertyList as any)[name],\r\n                        });\r\n                    },\r\n\r\n                    set: function (data: { [x: string]: any; hasOwnProperty: (arg0: string) => any }): void {\r\n                        for (const key in data) {\r\n                            if (data.hasOwnProperty(key)) {\r\n                                (propertyList as any)[key] = /*JSON.stringify*/ data[key];\r\n                            }\r\n                        }\r\n                    },\r\n\r\n                    remove: function (name: string | number, callback: (arg0: any) => void): void {\r\n                        delete (propertyList as any)[name];\r\n                        callback(propertyList);\r\n                    },\r\n\r\n                    clear: function (name: any, callback: any): void {\r\n                        propertyList = {};\r\n                    },\r\n                },\r\n            },\r\n            tabs: {\r\n                create: function (createProperties: any, callback: (arg0: {}) => void): void {\r\n                    if (callback) callback({});\r\n                },\r\n            },\r\n        };\r\n        browserHandler = mergeProperties(browserHandler || {}, browserMock);\r\n        if (!(window as any).chrome) {\r\n            (window as any).chrome = browserHandler;\r\n        }\r\n    }\r\n\r\n    if (!(window as any).BrowserHandler) {\r\n        (window as any).BrowserHandler = browserHandler;\r\n    }\r\n\r\n    return browserHandler;\r\n})();\r\n","import BrowserHandler from '../common/browserHandler';\r\n\r\nif (!(window as any).Utilities) {\r\n    (window as any).Utilities = {\r\n        // Deserialize query string to an object\r\n        deserializeQuery: function (query: string): any {\r\n            var match: RegExpExecArray,\r\n                pl = /\\+/g, // Regex for replacing addition symbol with a space\r\n                search = /([^&=]+)=?([^&]*)/g,\r\n                decode = function (s: string): string {\r\n                    return decodeURIComponent(s.replace(pl, ' '));\r\n                },\r\n                obj: any = {};\r\n            match = search.exec(query);\r\n            while (match) {\r\n                obj[decode(match[1])] = decode(match[2]);\r\n                match = search.exec(query);\r\n            }\r\n\r\n            return obj;\r\n        },\r\n\r\n        // Gets the file extension\r\n        getFileExtension: function (fileName: string): string {\r\n            var docExt = '';\r\n            if (fileName) {\r\n                var splitDoc = fileName.match(/(?:\\.)(\\w+)$/);\r\n                if (splitDoc && splitDoc.length > 1) {\r\n                    docExt = splitDoc[splitDoc.length - 1].toLowerCase();\r\n                }\r\n            }\r\n\r\n            return docExt;\r\n        },\r\n\r\n        // Navigate to url\r\n        navigateToUrlWithNewTab: function (url: string, openActive: boolean, onSuccess: (tab: any) => void): void {\r\n            BrowserHandler.tabs.create({\r\n                url: url,\r\n                active: this.isUndefinedOrNull(openActive) ? true : openActive,\r\n            }, onSuccess);\r\n        },\r\n\r\n        // Waiting for a BrowserHandler window to be created if there is no current window existing.\r\n        // This is to avoid opening a browser instance if the extension is installed silently.\r\n        safeOpenNewTab: function(url: string, openActive: boolean, onSuccess: (tab: any) => void): void {\r\n            BrowserHandler.windows.getAll((windows: any) => {\r\n                if (windows.length === 0) {\r\n                    BrowserHandler.windows.onCreated.addListener(() =>\r\n                        this.navigateToUrlWithNewTab(\r\n                            url,\r\n                            openActive,\r\n                            onSuccess\r\n                        )\r\n                    );\r\n                } else {\r\n                    this.navigateToUrlWithNewTab(\r\n                        url,\r\n                        openActive,\r\n                        onSuccess\r\n                    );\r\n                }\r\n            });\r\n        },\r\n\r\n        // Simple check for not undefined or null\r\n        isNotUndefinedOrNull: function (obj: any): boolean {\r\n            return !this.isUndefinedOrNull(obj);\r\n        },\r\n\r\n        // Simple check for undefined or null\r\n        isUndefinedOrNull: function (obj: any): boolean {\r\n            return typeof obj === 'undefined' || obj === null;\r\n        },\r\n\r\n        // Determines whether the extension is running in testing mode (running jasmine unit tests)\r\n        isExtensionInTestingMode: function (): boolean {\r\n            return this.isNotUndefinedOrNull((window as any).jasmine);\r\n        },\r\n\r\n        // Determines whether extension is running in developer mode; defaults to true if inconclusive\r\n        isExtensionInDevelopmentMode: function (): boolean {\r\n            // testing mode is not development mode\r\n            if (this.isExtensionInTestingMode()) {\r\n                return false;\r\n            }\r\n\r\n            if ((window as any).browser && (window as any).browser.extension) {\r\n                var url = BrowserHandler.runtime.getURL('');\r\n\r\n                if (typeof url !== 'undefined' && url !== null) {\r\n                    if (/_microsoftofficeonline_/i.test(url)) {\r\n                        return false; // from store\r\n                    }\r\n                }\r\n            }\r\n            if ((window as any).chrome && (window as any).chrome.extension) {\r\n                // Make sure chrome manifest exists\r\n                var manifest = this.getManifest();\r\n                if (manifest === undefined || manifest === null) {\r\n                    return false;\r\n                }\r\n\r\n                // Google Web Store adds key and update_url keys to the manifest\r\n                if (manifest.key !== undefined || manifest.update_url !== undefined) {\r\n                    return false;\r\n                }\r\n            }\r\n            return true;\r\n        },\r\n\r\n        // Returns the message id to use.\r\n        // This should work only in chrome.\r\n        getAppDescription: function (): string {\r\n            if (!(window.chrome && window.chrome.extension)) {\r\n                return undefined;\r\n            }\r\n\r\n            // Make sure chrome manifest exists\r\n            var manifest = this.getManifest();\r\n\r\n            return manifest.description;\r\n        },\r\n\r\n        // Gets the Chrome runtime manifest object\r\n        getManifest: function (): any {\r\n            // Make sure the BrowserHandler.runtime.getManifest() function exists\r\n            if (typeof BrowserHandler.runtime !== 'object' || typeof BrowserHandler.runtime.getManifest !== 'function') {\r\n                return null;\r\n            }\r\n\r\n            // Make sure manifest exists\r\n            var manifest = BrowserHandler.runtime.getManifest();\r\n            if (manifest === undefined || manifest === null) {\r\n                return null;\r\n            }\r\n\r\n            return manifest;\r\n        },\r\n\r\n        // Returns whether the current context is running in the extension background\r\n        isBackgroundContext: function (): boolean {\r\n            var loc = window.location.href;\r\n\r\n            if ((window as any).browser && (window as any).browser.extension) {\r\n                if (/^ms-browser-extension/.test(loc) && window === BrowserHandler.extension.getBackgroundPage()) {\r\n                    return true;\r\n                }\r\n            }\r\n\r\n            // Modern chrome does define window.browser so we need to re-check\r\n            if (window.chrome && window.chrome.extension) {\r\n                if (/^chrome/.test(loc) && window === BrowserHandler.extension.getBackgroundPage()) {\r\n                    return true;\r\n                }\r\n            }\r\n\r\n            return false;\r\n        },\r\n\r\n        // Gets the current time\r\n        getCurrentTime: function (): number {\r\n            return Math.round(new Date().getTime() / 1000.0);\r\n        },\r\n\r\n        // Returns true if we are running on Chrome, false otherwise\r\n        isChrome: function (): boolean {\r\n            // Ref: http://stackoverflow.com/questions/4565112/javascript-how-to-find-out-if-the-user-browser-is-chrome/13348618\r\n            return this.getBrowserName() === 'Chrome' && window.navigator.vendor.indexOf('Google') > -1;\r\n        },\r\n\r\n        // browserVersion: undefined,\r\n        getBrowserAndVersion: function () {\r\n            if (!this.browserVersion) {\r\n                const checkUserAgentForBrowser = (browser: string) => {\r\n                    // userAgent provides better version but may be limited in future so fallback to userAgentData if userAgent fails\r\n                    const regex = new RegExp(`(?<browser>${browser})/(?<version>[0-9.]+)`, 'i');\r\n                    const browserMatch = window.navigator.userAgent.match(regex);\r\n                    if (browserMatch && browserMatch.groups) {\r\n                        return browserMatch.groups;\r\n                    }\r\n\r\n                    if ((window.navigator as any).userAgentData) {\r\n                        const brands: Array<{ brand: string; version: string }> = (window.navigator as any).userAgentData.brands;\r\n                        const match = brands.find((entry) => entry.brand.match(new RegExp(browser, 'i')));\r\n                        if (match) {\r\n                            return { browser: match.brand, version: match.version };\r\n                        }\r\n                    }\r\n                };\r\n\r\n                // order matters here as some browsers may include others to appear as another browser, such as Chrome with Safari\r\n                // or Edge based on Chromium including Chrome so more specific  needs to be checked first\r\n                const orderedBrowserMatches = ['OPe?R', 'Edge?', 'Chrome', 'Safari', 'Firefox'];\r\n                for (const browser of orderedBrowserMatches) {\r\n                    const browserVersion = checkUserAgentForBrowser(browser);\r\n                    if (browserVersion) {\r\n                        this.browserVersion = browserVersion;\r\n                        break;\r\n                    }\r\n                }\r\n            }\r\n\r\n            return this.browserVersion;\r\n        },\r\n\r\n        // Returns the name of the current browser (Chrome or Edge)\r\n        getBrowserName: function (): string {\r\n            const browserVersion = this.getBrowserAndVersion();\r\n            return browserVersion ? browserVersion.browser : 'Chrome';\r\n        },\r\n\r\n        // Following code is required since Edge doesn't support \"__MSG_@@bidi_dir__\" in RS1\r\n        isRTL: function (): boolean {\r\n            var uiLang = BrowserHandler.i18n.getUILanguage();\r\n            return /^ar/i.test(uiLang) || /^fa/i.test(uiLang) || /^he/i.test(uiLang) ? true : false;\r\n        },\r\n\r\n        // Set the pop up icon\r\n        setIcon: function (iconPath: any): void {\r\n            BrowserHandler.browserAction.setIcon({\r\n                path: iconPath,\r\n            });\r\n        },\r\n\r\n        //create a new random ID\r\n        getNewId: function(): string {\r\n            return (window as any).crypto.randomUUID();\r\n        }\r\n    };\r\n}\r\n\r\nexport default (window as any).Utilities;\r\n","﻿/* global BrowserHandler angular chrome browser */\r\n\r\n(function () {\r\n    'use strict';\r\n\r\n    /*\r\n     * An AngularJS Localization Service\r\n     *\r\n     * Written by Jim Lavin\r\n     * http://codingsmackdown.tv\r\n     *\r\n     * Modified to integrate with chrome.i18n infrastructure\r\n     */\r\n    var BrowserHandler = window.BrowserHandler;\r\n\r\n    if (!BrowserHandler) {\r\n        BrowserHandler = chrome || browser;\r\n    }\r\n\r\n    angular\r\n        .module('localization', [])\r\n        // localization service responsible for retrieving resource files from chrome.i18n\r\n        .factory('localize', ['$filter', function ($filter) {\r\n            var localize = {\r\n                // checks the dictionary for a localized resource string\r\n                getLocalizedString: function (value) {\r\n                    // default the result to an empty string\r\n                    var result = '';\r\n\r\n                    // pull localized resource using Chrome API\r\n                    result = BrowserHandler.i18n.getMessage(value);\r\n\r\n                    // return the value to the call\r\n                    return result;\r\n                }\r\n            };\r\n\r\n            // return the local instance when called\r\n            return localize;\r\n        }])\r\n\r\n        // simple translation filter\r\n        // usage {{ TOKEN | i18n }}\r\n        .filter('i18n', ['localize', function (localize) {\r\n            return function (input) {\r\n                return localize.getLocalizedString(input);\r\n            };\r\n        }])\r\n\r\n        // translation directive that can handle dynamic strings\r\n        // updates the text value of the attached element\r\n        // usage <span data-i18n=\"TOKEN\" ></span>\r\n        // or\r\n        // <span data-i18n=\"TOKEN|VALUE1|VALUE2\" ></span>\r\n        .directive('i18n', ['localize', function (localize) {\r\n            var i18nDirective = {\r\n                restrict: \"EAC\",\r\n                updateText: function (elm, token) {\r\n                    var values = token.split('|');\r\n                    if (values.length <= 1) return;\r\n\r\n                    // construct the tag to insert into the element\r\n                    var tag = localize.getLocalizedString(values[0]);\r\n                    if (!tag) return;\r\n\r\n                    // update the element\r\n                    for (var index = 1; index < values.length; index++) {\r\n                        var target = '{' + (index - 1) + '}';\r\n                        tag = tag.replace(target, values[index]);\r\n                    }\r\n\r\n                    // insert the text into the element\r\n                    elm.text(tag);\r\n                },\r\n\r\n                link: function (scope, elm, attrs) {\r\n                    attrs.$observe('i18n', function (value) {\r\n                        i18nDirective.updateText(elm, attrs.i18n);\r\n                    });\r\n                }\r\n            };\r\n\r\n            return i18nDirective;\r\n        }])\r\n        // translation directive that can handle dynamic strings\r\n        // updates the attribute value of the attached element\r\n        // usage <span data-i18n-attr=\"TOKEN|ATTRIBUTE\" ></span>\r\n        // or\r\n        // <span data-i18n-attr=\"TOKEN|ATTRIBUTE|VALUE1|VALUE2\" ></span>\r\n        .directive('i18nAttr', ['localize', function (localize) {\r\n            var i18NAttrDirective = {\r\n                restrict: \"EAC\",\r\n                updateText: function (elm, token) {\r\n                    var values = token.split('|');\r\n                    if (values.length < 2) return;\r\n\r\n                    // construct the tag to insert into the element\r\n                    var tag = localize.getLocalizedString(values[0]);\r\n                    if (!tag) return;\r\n\r\n                    for (var index = 2; index < values.length; index++) {\r\n                        var target = '{' + (index - 2) + '}';\r\n                        tag = tag.replace(target, values[index]);\r\n                    }\r\n\r\n                    // insert the text into the element\r\n                    elm.attr(values[1], tag);\r\n                },\r\n\r\n                link: function (scope, elm, attrs) {\r\n                    attrs.$observe('i18nAttr', function (value) {\r\n                        i18NAttrDirective.updateText(elm, value);\r\n                    });\r\n                }\r\n            };\r\n\r\n            return i18NAttrDirective;\r\n        }]);\r\n})();\r\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n// expose the modules object (__webpack_modules__)\n__webpack_require__.m = __webpack_modules__;\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.g = (function() {\n\tif (typeof globalThis === 'object') return globalThis;\n\ttry {\n\t\treturn this || new Function('return this')();\n\t} catch (e) {\n\t\tif (typeof window === 'object') return window;\n\t}\n})();","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","__webpack_require__.j = 213;","// no baseURI\n\n// object to store loaded and loading chunks\n// undefined = chunk not loaded, null = chunk preloaded/prefetched\n// [resolve, reject, Promise] = chunk loading, 0 = chunk loaded\nvar installedChunks = {\n\t213: 0\n};\n\n// no chunk on demand loading\n\n// no prefetching\n\n// no preloaded\n\n// no HMR\n\n// no HMR manifest\n\n__webpack_require__.O.j = (chunkId) => (installedChunks[chunkId] === 0);\n\n// install a JSONP callback for chunk loading\nvar webpackJsonpCallback = (parentChunkLoadingFunction, data) => {\n\tvar [chunkIds, moreModules, runtime] = data;\n\t// add \"moreModules\" to the modules object,\n\t// then flag all \"chunkIds\" as loaded and fire callback\n\tvar moduleId, chunkId, i = 0;\n\tif(chunkIds.some((id) => (installedChunks[id] !== 0))) {\n\t\tfor(moduleId in moreModules) {\n\t\t\tif(__webpack_require__.o(moreModules, moduleId)) {\n\t\t\t\t__webpack_require__.m[moduleId] = moreModules[moduleId];\n\t\t\t}\n\t\t}\n\t\tif(runtime) var result = runtime(__webpack_require__);\n\t}\n\tif(parentChunkLoadingFunction) parentChunkLoadingFunction(data);\n\tfor(;i < chunkIds.length; i++) {\n\t\tchunkId = chunkIds[i];\n\t\tif(__webpack_require__.o(installedChunks, chunkId) && installedChunks[chunkId]) {\n\t\t\tinstalledChunks[chunkId][0]();\n\t\t}\n\t\tinstalledChunks[chunkId] = 0;\n\t}\n\treturn __webpack_require__.O(result);\n}\n\nvar chunkLoadingGlobal = self[\"webpackChunkofficechromeextension\"] = self[\"webpackChunkofficechromeextension\"] || [];\nchunkLoadingGlobal.forEach(webpackJsonpCallback.bind(null, 0));\nchunkLoadingGlobal.push = webpackJsonpCallback.bind(null, chunkLoadingGlobal.push.bind(chunkLoadingGlobal));","// startup\n// Load entry module and return exports\n// This entry module depends on other loaded chunks and execution need to be delayed\nvar __webpack_exports__ = __webpack_require__.O(undefined, [216], () => (__webpack_require__(8489)))\n__webpack_exports__ = __webpack_require__.O(__webpack_exports__);\n"],"sourceRoot":""}